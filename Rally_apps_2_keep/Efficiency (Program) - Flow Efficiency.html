<!DOCTYPE html>
<html>

<head>
    <title>Flow Efficiency</title>
    <!--  (c) 2014 Rally Software Development Corp.  All Rights Reserved. -->
    <!--  Build Date: Tue May 10 2016 10:45:25 GMT-0600 (MDT) -->

    <script type="text/javascript">
        var APP_BUILD_DATE = "Tue May 10 2016 10:45:25 GMT-0600 (MDT)";
        var CHECKSUM = 72424961977;
    </script>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {

            /**
             * A link that pops up a version dialog box
             */

            Ext.define('Rally.technicalservices.InfoLink', {
                extend: 'Ext.Component',
                alias: 'widget.tsinfolink',

                /**
                 * @cfg {String} informationHtml
                 * Additional text to be displayed on the popup dialog (for exmaple,
                 * to add a description of the app's use or functionality)
                 */
                informationHtml: null,

                /**
                 * 
                 * cfg {String} title
                 * The title for the dialog box
                 */
                title: "Build Information",

                renderTpl: "<div id='{id}-infolinkWrap' class='tsinfolink'>i</div>",

                initComponent: function () {
                    this.callParent(arguments);

                },

                onRender: function () {
                    this.callParent(arguments);
                    this.mon(this.el, 'click', this.onClick, this);
                },
                _generateChecksum: function (string) {
                    var chk = 0x12345678,
                        i;
                    string = string.replace(/var CHECKSUM = .*;/, "");
                    string = string.replace(/\s/g, ""); //Remove all whitespace from the string.

                    for (i = 0; i < string.length; i++) {
                        chk += (string.charCodeAt(i) * i);
                    }

                    return chk;
                },
                _checkChecksum: function (container) {
                    var me = this;
                    Ext.Ajax.request({
                        url: document.URL,
                        params: {
                            id: 1
                        },
                        success: function (response) {
                            text = response.responseText;
                            if (CHECKSUM) {
                                if (CHECKSUM !== me._generateChecksum(text)) {
                                    console.log("Checksums don't match!");
                                    if (me.dialog) {
                                        me.dialog.add({
                                            xtype: 'container',
                                            html: 'Checksums do not match'
                                        });
                                    }
                                }
                            }
                        }
                    });
                },
                onClick: function (e) {
                    var me = this;
                    this._checkChecksum(this);

                    var dialog_items = [];

                    if (this.informationHtml) {
                        dialog_items.push({
                            xtype: 'container',
                            html: this.informationHtml
                        });
                    }

                    dialog_items.push({
                        xtype: 'container',
                        html: "This app was created by the Rally Technical Services Team."
                    });

                    if (APP_BUILD_DATE) {
                        dialog_items.push({
                            xtype: 'container',
                            html: 'Build date/time: ' + APP_BUILD_DATE
                        });
                    }

                    if (this.dialog) {
                        this.dialog.destroy();
                    }
                    this.dialog = Ext.create('Rally.ui.dialog.Dialog', {
                        defaults: {
                            padding: 5,
                            margin: 5
                        },
                        closable: true,
                        draggable: true,
                        title: me.title,
                        items: dialog_items
                    });
                    this.dialog.show();
                }
            });

            /*
             */
            Ext.define('Rally.technicalservices.Logger', {
                constructor: function (config) {
                    Ext.apply(this, config);
                },
                log: function (args) {
                    var timestamp = "[ " + Ext.util.Format.date(new Date(), "Y-m-d H:i:s.u") + " ]";
                    //var output_args = arguments;
                    //output_args.unshift( [ "[ " + timestamp + " ]" ] );
                    //output_args = Ext.Array.push(output_args,arguments);

                    var output_args = [];
                    output_args = Ext.Array.push(output_args, [timestamp]);
                    output_args = Ext.Array.push(output_args, Ext.Array.slice(arguments, 0));

                    window.console && console.log.apply(console, output_args);
                }

            });

            Ext.define('CycleCalculator', {
                //    extend: "Rally.data.lookback.calculator.BaseCalculator",
                logger: new Rally.technicalservices.Logger(),
                config: {
                    cycleField: 'ScheduleState',
                    cycleStartValue: 'Defined',
                    cycleEndValue: 'Accepted',
                    cyclePrecedence: [],
                    startDate: null,
                    endDate: null,
                    granularity: "month",
                    dateFormat: "M yyyy",
                    dataFilters: [],
                    color: {
                        Defect: 'red',
                        HierarchicalRequirement: 'green',
                        Combined: 'blue'
                    }
                },
                cycleTimeData: null,
                snapsByOid: {},
                constructor: function (config) {
                    this.mergeConfig(config);
                },
                runCalculation: function (snapshots) {
                    var snaps_by_oid = Rally.technicalservices.Toolbox.aggregateSnapsByOid(
                        snapshots);
                    var date_buckets = Rally.technicalservices.Toolbox.getDateBuckets(this.startDate,
                        this.endDate, this.granularity);

                    var cycle_time_data = [];

                    Ext.Object.each(snaps_by_oid, function (oid, snaps) {
                        var ctd = this._getCycleTimeData(snaps, this.cycleField, this.cycleStartValue,
                            this.cycleEndValue, this.cyclePrecedence);
                        if (ctd.include) {
                            cycle_time_data.push(ctd);
                        }
                    }, this);


                    var series = [];

                    series.push(this._getSeries(cycle_time_data, date_buckets, this.granularity,
                        undefined, 'black'));
                    var hr_series = this._getSeries(cycle_time_data, date_buckets, this.granularity,
                        'HierarchicalRequirement', '');
                    series.push(hr_series);

                    var defect_series = this._getSeries(cycle_time_data, date_buckets, this.granularity,
                        'Defect', this.color.Defect);
                    series.push(defect_series);

                    series.push(this._getTrendline(hr_series));
                    series.push(this._getTrendline(defect_series));

                    categories = Rally.technicalservices.Toolbox.formatDateBuckets(date_buckets,
                        this.dateFormat);

                    var cycleTimeDataExport = [];
                    Ext.each(cycle_time_data, function (ctd) {
                        ctd.startDate = Rally.util.DateTime.fromIsoString(ctd.startDate);
                        ctd.endDate = Rally.util.DateTime.fromIsoString(ctd.endDate);
                        cycleTimeDataExport.push(ctd);
                    });
                    this.cycleTimeDataExport = cycleTimeDataExport;

                    this.summaryData = this._getSummary(cycle_time_data, date_buckets, this.granularity,
                        categories);

                    return {
                        series: series,
                        categories: categories
                    }
                },
                _getTrendline: function (series, color) {
                    /**
                     * Regression Equation(y) = a + bx  
                     * Slope(b) = (NΣXY - (ΣX)(ΣY)) / (NΣX2 - (ΣX)2) 
                     * Intercept(a) = (ΣY - b(ΣX)) / N
                     */

                    var sum_xy = 0;
                    var sum_x = 0;
                    var sum_y = 0;
                    var sum_x_squared = 0;
                    var n = 0;
                    for (var i = 0; i < series.data.length; i++) {
                        if (series.data[i].y) {
                            sum_xy += series.data[i].y * i;
                            sum_x += i;
                            sum_y += series.data[i].y;
                            sum_x_squared += i * i;
                            n++;
                        }
                    }
                    var slope = (n * sum_xy - sum_x * sum_y) / (n * sum_x_squared - sum_x * sum_x);
                    var intercept = (sum_y - slope * sum_x) / n;

                    this.logger.log('trendline data (name, slope, intercept)', series.name, slope,
                        intercept);

                    var y = [];
                    if (!isNaN(slope) && !isNaN(intercept)) {
                        y = _.range(series.data.length).map(function () {
                            return null
                        })
                        for (var i = 0; i < series.data.length; i++) {
                            y[i] = intercept + slope * i;
                        }
                    }
                    this.logger.log('_getTrendline', y);
                    return {
                        name: series.name + ' Trendline',
                        color: color,
                        data: y,
                        display: 'line',
                        dashStyle: 'Dash'
                    };

                },
                _getCycleTimeData: function (snaps, field, startValue, endValue, precedence) {
                    var start_index = -1;
                    if (startValue != null) { //This is in case there is no start value (which means grab the first snapshot)
                        var start_index = _.indexOf(precedence, startValue);
                    }
                    var end_index = _.indexOf(precedence, endValue);


                    //Assumes snaps are stored in ascending date order.  
                    var start_date = null,
                        end_date = null,
                        between_states = false,
                        days = null;
                    var type = snaps[0]._TypeHierarchy.slice(-1)[0];

                    var previous_state_index = -1;
                    var state_index = -1;
                    var blocked_time = 0,
                        unblocked_date = null,
                        blocked_date = null;
                    var ready_time = 0,
                        unready_date = null,
                        ready_date = null;
                    var seconds = null;
                    var days = null;
                    var should_include = false;

                    Ext.each(snaps, function (snap) {

                        if (snap[field]) {
                            previous_state_index = state_index;
                            state_index = _.indexOf(precedence, snap[field]);
                        }
                        if (state_index >= start_index && previous_state_index <
                            start_index) {
                            start_date = Rally.util.DateTime.fromIsoString(snap._ValidFrom);
                        }

                        if (state_index >= end_index && previous_state_index < end_index) {
                            end_date = Rally.util.DateTime.fromIsoString(snap._ValidFrom);
                            if (start_date != null) {
                                seconds = Rally.util.DateTime.getDifference(end_date,
                                    start_date, "second");
                                days = Math.floor(seconds / 86400) + 1;
                            }
                            should_include = this._snapMeetsFilterCriteria(snap);
                        }
                    }, this);

                    var blocked_time = this._getTimeInBooleanState(snaps, 'Blocked', start_date,
                        end_date);
                    var ready_time = this._getTimeInBooleanState(snaps, 'Ready', start_date,
                        end_date);

                    var pct_blocked = 0,
                        pct_ready = 0;
                    if (seconds > 0) {
                        pct_blocked = (blocked_time / seconds * 100);
                        pct_ready = (ready_time / seconds * 100);
                    }



                    return {
                        formattedId: snaps[0].FormattedID,
                        seconds: seconds,
                        days: days,
                        endDate: end_date,
                        startDate: start_date,
                        artifactType: type,
                        'include': should_include,
                        blockedTime: blocked_time,
                        readyTime: ready_time,
                        pctBlocked: pct_blocked,
                        pctReady: pct_ready
                    };
                },
                _getTimeInBooleanState: function (snaps, stateField, startDate, endDate) {
                    var current, previous = null;
                    var true_date = null,
                        false_date = null;
                    var true_time = 0;


                    Ext.each(snaps, function (snap) {
                        previous = current;
                        current = snap[stateField];

                        var valid_to = Rally.util.DateTime.fromIsoString(snap._ValidTo);
                        var valid_from = Rally.util.DateTime.fromIsoString(snap._ValidFrom);

                        if (valid_to >= startDate && valid_from <= endDate) {
                            if (current != previous) {
                                if (current === true) {
                                    true_date = valid_from;
                                    if (valid_from < startDate) {
                                        true_date = startDate;
                                    }
                                } else {
                                    if (current === false && previous === true) {
                                        false_date = valid_from;
                                        if (true_date && false_date) {
                                            true_time += Rally.util.DateTime.getDifference(
                                                false_date, true_date, "second");
                                            true_date = null;
                                            false_date = null;
                                        }
                                    }
                                }
                            }
                        }
                    }, this);

                    if (true_date != null && false_date == null) {
                        true_time += Rally.util.DateTime.getDifference(endDate, true_date, "second");
                    }
                    return true_time;

                },
                _snapMeetsFilterCriteria: function (snap) {
                    var is_filtered = true;
                    // this.logger.log('_snapMeetsFilterCriteria', snap, filter);
                    Ext.each(this.dataFilters, function (filter) {
                        var str_format = "{0} {1} {2}";
                        if (isNaN(snap[filter.property]) && isNaN(filter.value)) {
                            str_format = "\"{0}\" {1} \"{2}\"";
                        }
                        var operator = filter.operator;
                        if (operator == "=") {
                            operator = "==";
                        }

                        var val = filter.value || '';
                        if (val.length == 0 || snap[filter.property].length == 0) {
                            is_filtered = (val.length == 0 && snap[filter.property].length ==
                                0);
                            //this.logger.log('_snapMeetsFilterCriteria filter property or value is blank', filter.property, snap[filter.property], is_filtered);
                        } else {
                            var str_eval = Ext.String.format(str_format, snap[filter.property],
                                operator, val);
                            is_filtered = eval(str_eval);
                            //this.logger.log('_snapMeetsFilterCriteria eval', filter, str_eval,is_filtered);
                        }
                        return is_filtered; //if filtered is false, then we want to stop looping.  
                    }, this);

                    return is_filtered;
                },
                _getSeries: function (cycle_time_data, date_buckets, granularity, type, color) {
                    var series_raw_data = [];
                    var series_data = [];
                    var tooltip_data = [];
                    for (var i = 0; i < date_buckets.length; i++) {
                        series_raw_data[i] = [];
                        tooltip_data[i] = 0;
                        series_data[i] = {
                            y: null,
                            n: 0
                        };
                    }

                    Ext.each(cycle_time_data, function (cdata) {
                        for (var i = 0; i < date_buckets.length; i++) {
                            if ((type == undefined || type == cdata.artifactType) && cdata.endDate >=
                                date_buckets[i] && cdata.endDate < Rally.util.DateTime.add(
                                    date_buckets[i], granularity, 1)) {
                                //var efficiency = 100;
                                if (cdata.seconds > 0) {
                                    var adjusted_cycle_time = (cdata.seconds - cdata.blockedTime -
                                        cdata.readyTime);
                                    var efficiency = (adjusted_cycle_time / cdata.seconds) *
                                        100;
                                    series_raw_data[i].push(efficiency);
                                }
                                //series_raw_data[i].push(efficiency);
                            }
                        }
                    });

                    var validDataPoints = 0;
                    var series_data = _.range(date_buckets.length).map(function () {
                        return {
                            y: null,
                            n: 0
                        }
                    })
                    for (var i = 0; i < series_raw_data.length; i++) {
                        if (series_raw_data[i].length > 0) {
                            series_data[i].y = Ext.Array.mean(series_raw_data[i]);
                            series_data[i].n = '(' + series_raw_data[i].length + ' Artifacts)';
                        }
                    }

                    return {
                        name: this._getSeriesName(type),
                        color: color,
                        data: series_data
                    };
                },
                _getSeriesName: function (type) {
                    var type_text = "Combined";
                    if (type) {
                        type_text = type;
                        if (type == 'HierarchicalRequirement') {
                            type_text = "User Story";
                        }
                    }
                    return Ext.String.format(type_text);
                },
                _getSummary: function (cycle_time_data, date_buckets, granularity, categories) {

                    var cycle_time = [];
                    var blockers = [];
                    var ready = [];
                    var cycle_time_in_days = [];

                    for (var i = 0; i < date_buckets.length; i++) {
                        cycle_time[i] = [];
                        blockers[i] = [];
                        ready[i] = [];
                        cycle_time_in_days[i] = [];
                    }

                    Ext.each(cycle_time_data, function (cdata) {
                        for (var i = 0; i < date_buckets.length; i++) {
                            if (cdata.endDate >= date_buckets[i] && cdata.endDate < Rally.util
                                .DateTime.add(date_buckets[i], granularity, 1)) {
                                if (cdata.seconds > 0) {
                                    cycle_time[i].push(cdata.seconds || 0);
                                    blockers[i].push(cdata.pctBlocked || 0);
                                    ready[i].push(cdata.pctReady || 0);
                                    cycle_time_in_days[i].push(cdata.days);
                                }
                            }
                        }
                    });

                    summaryData = [];
                    for (var i = 0; i < date_buckets.length; i++) {
                        var cycle_time_avg = 0,
                            pct_blocked = 0,
                            pct_ready = 0,
                            num_artifacts = 0,
                            total_cycle_time = 0;
                        if (cycle_time[i].length > 0) {
                            cycle_time_avg = (Ext.Array.mean(cycle_time[i]) / 86400).toFixed(); //convert to days
                            num_artifacts = cycle_time[i].length;
                            total_cycle_time = Ext.Array.sum(cycle_time[i]);
                            if (Ext.Array.sum(cycle_time[i]) > 0) {
                                pct_blocked = Ext.Array.mean(blockers[i]);
                                pct_blocked = pct_blocked.toFixed(1);
                                pct_ready = Ext.Array.mean(ready[i]);
                                pct_ready = pct_ready.toFixed(1);
                            }
                        }
                        //  total_cycle_time = (total_cycle_time/86400).toFixed(1); 
                        summaryData.push({
                            date: categories[i],
                            avgCycleTime: cycle_time_avg,
                            pctBlocked: pct_blocked,
                            pctReady: pct_ready,
                            numArtifacts: num_artifacts,
                            totalCycleTime: Ext.Array.sum(cycle_time_in_days[i])
                        })
                    }

                    return summaryData;
                },
            });
            Ext.define('Rally.technicalservices.FileUtilities', {
                singleton: true,
                logger: new Rally.technicalservices.Logger(),

                saveTextAsFile: function (textToWrite, fileName) {
                    var textFileAsBlob = new Blob([textToWrite], {
                        type: 'text/plain'
                    });
                    var fileNameToSaveAs = fileName;

                    var downloadLink = document.createElement("a");
                    downloadLink.download = fileNameToSaveAs;
                    downloadLink.innerHTML = "Download File";
                    if (window.webkitURL != null) {
                        // Chrome allows the link to be clicked
                        // without actually adding it to the DOM.
                        downloadLink.href = window.webkitURL.createObjectURL(textFileAsBlob);
                    } else {
                        // Firefox requires the link to be added to the DOM
                        // before it can be clicked.
                        downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
                        downloadLink.onclick = this.destroyClickedElement;
                        downloadLink.style.display = "none";
                        document.body.appendChild(downloadLink);
                    }
                    downloadLink.click();
                },
                destroyClickedElement: function (event) {
                    document.body.removeChild(event.target);
                },
                convertDataArrayToCSVText: function (data_array, requestedFieldHash) {

                    var text = '';
                    Ext.each(Object.keys(requestedFieldHash), function (key) {
                        text += requestedFieldHash[key] + ',';
                    });
                    text = text.replace(/,$/, '\n');

                    Ext.each(data_array, function (d) {
                        Ext.each(Object.keys(requestedFieldHash), function (key) {
                            if (d[key]) {
                                if (typeof d[key] === 'object') {
                                    if (d[key].FormattedID) {
                                        text += Ext.String.format("\"{0}\",", d[key]
                                            .FormattedID);
                                    } else if (d[key].Name) {
                                        text += Ext.String.format("\"{0}\",", d[key]
                                            .Name);
                                    } else if (!isNaN(Date.parse(d[key]))) {
                                        text += Ext.String.format("\"{0}\",", Rally
                                            .util.DateTime.formatWithDefaultDateTime(
                                                d[key]));
                                    } else {
                                        text += Ext.String.format("\"{0}\",", d[key]
                                            .toString());
                                    }
                                } else {
                                    text += Ext.String.format("\"{0}\",", d[key]);
                                }
                            } else {
                                text += ',';
                            }
                        }, this);
                        text = text.replace(/,$/, '\n');
                    }, this);
                    return text;
                }
            });
            Ext.define('Rally.technicalservices.dialog.Filter', {
                extend: Rally.ui.dialog.Dialog,
                logger: new Rally.technicalservices.Logger(),
                autoShow: true,
                componentCls: "rly-popover dark-container",
                validFields: [],
                initComponent: function () {
                    this.items = this._getItems();
                    this.buttons = this._getButtonConfig();
                    this.callParent(arguments);
                    this._initializeFilters(this.filters);
                    this.addEvents(
                        'customFilter'
                    );
                },
                _initializeFilters: function (filters) {
                    this.logger.log('_initializeFilters', filters);

                    if (filters && filters.length > 0) {
                        Ext.each(filters, function (filter) {
                            this._addNewRow(filter.property, filter.operator, filter.value);
                        }, this);
                    } else {
                        this._addNewRow();
                    }
                },
                _getFieldStore: function () {
                    var fields = [];
                    Ext.each(this.validFields, function (field) {
                        fields.push({
                            name: field.name,
                            displayName: field.displayName,
                            attributeType: field.attributeDefinition.AttributeType,
                            schemaType: field.attributeDefinition.SchemaType,
                            modelType: field.modelType,
                            isConstrained: field.attributeDefinition.Constrained
                        });
                    }, this);

                    return Ext.create('Rally.data.custom.Store', {
                        data: fields
                    });
                },
                _addNewRow: function (property, operator, value) {
                    this.logger.log('_addNewRow', property, operator, value);

                    var field_store = this._getFieldStore();
                    var items = [];
                    items.push({
                        xtype: "rallybutton",
                        itemId: 'btn-remove',
                        text: '-',
                        scope: this,
                        margin: 5,
                        handler: function (btn) {
                            btn.bubble(this._removeRow, this);
                        }
                    });

                    items.push({
                        xtype: "rallycombobox",
                        itemId: 'cb-filter-field',
                        store: field_store,
                        displayField: 'displayName',
                        valueField: 'name',
                        listeners: {
                            scope: this,
                            select: function (cb) {
                                this._updateFilterCombos(cb, operator, value);
                            },
                            ready: function (cb) {
                                if (property) {
                                    cb.setValue(property);
                                    this._updateFilterCombos(cb, operator, value);
                                }
                            }
                        },
                        allowNoEntry: true,
                        noEntryText: 'Choose Field...',
                        noEntryValue: null,
                        margin: 5,
                        value: null
                    });

                    var row = Ext.create('Ext.Container', {
                        layout: {
                            type: 'hbox'
                        },
                        items: items

                    });
                    this.down('#ct-rows').add(row);
                    this._validateFilters();
                },
                _updateFilterCombos: function (cb, operator, value) {
                    var parent_ct = cb.up(null, 1);
                    var rec = cb.getRecord();

                    this.logger.log('_updateFilterCombos', cb.itemId, rec, operator, value);

                    if (parent_ct) {
                        if (parent_ct.down('#cb-filter-operator')) {
                            parent_ct.down('#cb-filter-operator').destroy();
                            parent_ct.down('#cb-filter-value').destroy();
                        }


                        var op_val = operator || '=';
                        var operator_ctl = this._getOperatorControl(rec, op_val,
                            'cb-filter-operator');
                        parent_ct.add(operator_ctl);

                        var value_val = value || null;
                        var value_ctl = this._getValueControl(rec, value_val, 'cb-filter-value');
                        parent_ct.add(value_ctl);

                    }
                },

                _removeRow: function (btn) {
                    var ct = btn.up(null, 1);
                    if (ct) {
                        ct.destroy();
                    }
                    this._validateFilters();
                },
                _getButtonConfig: function () {
                    return [{
                        xtype: "rallybutton",
                        itemId: "cancelButton",
                        cls: "secondary rly-small",
                        text: "Cancel",
                        width: 90,
                        handler: this._onCancelClick,
                        scope: this
                    }, {
                        xtype: "rallybutton",
                        itemId: "applyButton",
                        cls: "primary rly-small",
                        text: "Apply",
                        width: 90,
                        handler: this._onApplyClick,
                        scope: this,
                        disabled: true
                    }]
                },
                _onClearAll: function () {
                    this.down('#ct-rows').removeAll();
                    this._addNewRow();
                },
                _onCancelClick: function () {
                    this.destroy()
                },
                _validateFilters: function (ct) {
                    var disabled = false;
                    var add_disabled = false;

                    var rows = this.down('#ct-rows').items.items;
                    if (rows.length == 0) {
                        disabled = true;
                    }

                    Ext.each(this.down('#ct-rows').items.items, function (item) {
                        item.down('#btn-remove').setDisabled(rows.length == 1);

                        var property = null;
                        if (item.down('#cb-filter-field')) {
                            property = item.down('#cb-filter-field').getValue();
                        }
                        var operator = null;
                        if (item.down('#cb-filter-operator')) {
                            operator = item.down('#cb-filter-operator').getValue();
                        }

                        if (property == null || operator == null || property.length == 0 ||
                            operator.length == 0) {
                            disabled = true, add_disabled = true;
                        }

                        var val = null;
                        if (item.down('#cb-filter-value')) {
                            val = item.down('#cb-filter-value').getValue()
                            if (item.down('#cb-filter-value').xtype == 'rallynumberfield') {
                                if (val == null || val.toString.length == 0) {
                                    disabled = true, add_disabled = true;
                                }
                            }
                        };
                        if (rows.length == 1 && property == null && operator == null && val ==
                            null) {
                            disabled = false; //clear filters 
                        }
                    }, this);
                    this.logger.log('_validateFilters', disabled);
                    this.down('#applyButton').setDisabled(disabled);
                    this.down('#btn-add').setDisabled(add_disabled);
                },
                _onApplyClick: function () {
                    var filters = [];
                    Ext.each(this.down('#ct-rows').items.items, function (item) {
                        if (this.down('#cb-filter-operator')) {
                            property = item.down('#cb-filter-field').getValue();
                            operator = item.down('#cb-filter-operator').getValue();
                            val = item.down('#cb-filter-value').getValue();
                            display_property = item.down('#cb-filter-field').getRecord().get(
                                'displayName');
                            if (property && operator) {
                                filters.push({
                                    property: property,
                                    operator: operator,
                                    value: val,
                                    displayProperty: display_property
                                });
                            }
                        }
                    }, this);

                    this.fireEvent("customfilter", filters);
                    this.destroy()
                },
                _getItems: function () {
                    return [{
                        xtype: "container",
                        cls: "custom-filter-header",
                        layout: {
                            type: 'hbox'
                        },
                        defaults: {
                            xtype: "component",
                            cls: "filter-panel-label"
                        },
                        items: [{
                            height: 1,
                            width: 30
                        }, {
                            html: "Field",
                            width: 155
                        }, {
                            html: "Operator",
                            width: 80
                        }, {
                            html: "Value",
                            width: 155
                        }]
                    }, {
                        xtype: "container",
                        itemId: "ct-rows",
                        layout: {
                            type: 'vbox'
                        }
                    }, {
                        xtype: "container",
                        itemId: 'ct-footer',
                        items: [{
                            xtype: 'rallybutton',
                            itemId: 'clearButton',
                            cls: "secondary rly-small",
                            text: 'Clear All',
                            width: 90,
                            align: 'right',
                            margin: '5 5 5 220',
                            scope: this,
                            handler: this._onClearAll
                        }, {
                            xtype: 'rallybutton',
                            itemId: 'btn-add',
                            text: 'Add New',
                            width: 90,
                            cls: "primary rly-small",
                            align: 'right',

                            margin: 5,
                            scope: this,
                            handler: this._addNewRow
                        }]
                    }]
                },
                _getOperatorControl: function (field, operatorValue, itemId) {
                    this.logger.log('_getOperatorControl', field, operatorValue);
                    var operators = ['='];
                    var operator_value = operatorValue || '=';
                    //We should be able to get these back from the field, but its not consistent
                    //so we are going to cheat and hardcode them
                    if (!field.get('isConstrained')) {
                        switch (field.get('attributeType')) {
                            case 'STRING':
                            case 'TEXT':
                                operators = ['=', 'contains'];
                                break;
                            case 'DECIMAL':
                            case 'INTEGER':
                            case 'QUANTITY':
                                operators = ['=', '<=', '>=', '<', '>'];
                                break;
                            case 'DATE':
                                operators = ['on', 'before', 'after'];
                        }
                    }

                    var op_ctl = {
                        xtype: "rallycombobox",
                        itemId: itemId,
                        store: operators,
                        margin: 5,
                        width: 80,
                        allowNoEntry: false,
                        noEntryText: '',
                        listeners: {
                            scope: this,
                            change: this._validateFilters,
                            ready: function (cb) {
                                cb.setValue(operator_value);
                            }
                        }
                    };
                    return op_ctl;
                },
                _getValueControl: function (field, value, item_id) {
                    this.logger.log('_getValueControl', field)

                    var ctl = {
                        xtype: 'rallytextfield'
                    };
                    var type = field.get('attributeType');
                    var hasAllowedValues = ((type == 'STATE') || (type == 'RATING') || field.get(
                        'isConstrained'));
                    var schema = field.get('schemaType');
                    var field_name = field.get('name');
                    var model_type = field.get('modelType');

                    switch (type) {
                        case 'BOOLEAN':
                            ctl = {
                                xtype: 'rallycombobox',
                                allowNoEntry: false,
                                store: ['true', 'false']
                            };
                            break;
                        case 'DATE':
                            ctl = {
                                xtype: 'rallydatefield',
                                allowNoEntry: false,
                            };
                            break;
                        case 'TEXT':
                        case 'STRING':
                        case 'STATE':
                        case 'RATING':
                            if (hasAllowedValues) {
                                ctl = {
                                    xtype: 'rallyfieldvaluecombobox',
                                    model: model_type,
                                    field: field_name,
                                    allowNoEntry: false,
                                };
                            }
                            break;
                        case 'OBJECT':
                            //Release, Iteration, User, Project, artifact links
                            if (schema == 'Iteration') {
                                ctl = {
                                    xtype: 'rallyiterationcombobox',
                                    allowNoEntry: false,
                                };
                            } else if (schema == 'Release') {
                                ctl = {
                                    xtype: 'rallyreleasecombobox',
                                    allowNoEntry: false,
                                };
                            } else if (schema == 'User') {
                                ctl = {
                                    xtype: 'rallyusersearchcombobox',
                                    project: this.getContext().getProject(),
                                    allowNoEntry: false,
                                };
                            } else if (schema == 'Project') {
                                ctl = {
                                    xtype: 'rallyprojectpicker',
                                    allowNoEntry: false,
                                };

                            } else if (schema == 'State') {
                                ctl = {
                                    xtype: 'rallyfieldvaluecombobox',
                                    model: model_name,
                                    field: field_name,
                                    allowNoEntry: false,
                                };
                            }
                            break;
                        case 'DECIMAL':
                        case 'INTEGER':
                        case 'QUANTITY':
                            ctl = {
                                xtype: 'rallynumberfield',
                                allowBlank: false
                            }
                    }
                    _.extend(ctl, {
                        itemId: item_id,
                        margin: 5,
                        listeners: {
                            scope: this,
                            change: this._validateFilters,
                            ready: function (cb) {
                                if (value) {
                                    cb.setValue(value);
                                }
                            },
                            render: function (cb) {
                                if (value) {
                                    cb.setValue(value);
                                }
                            }
                        }
                    });
                    return ctl;
                },
            });
            Ext.override(Rally.ui.picker.FieldPicker, {
                _shouldShowField: function (field) {
                    var allowed_attribute_types = ['STATE', 'STRING'];
                    if (field.attributeDefinition) {
                        var attr_def = field.attributeDefinition;
                        return (attr_def.Constrained && Ext.Array.contains(allowed_attribute_types,
                            attr_def.AttributeType) && attr_def.ReadOnly == false)
                    }
                    return false;
                }
            });

            Ext.override(Ext.data.proxy.Server, {
                timeout: 60000,
                processResponse: function (success, operation, request, response, callback, scope) {
                    var me = this,
                        reader,
                        result;

                    if (success === true) {
                        reader = me.getReader();
                        reader.applyDefaults = operation.action === 'read';
                        result = reader.read(me.extractResponseData(response));

                        if (result.success !== false) {

                            Ext.apply(operation, {
                                response: response,
                                resultSet: result
                            });

                            operation.commitRecords(result.records);
                            operation.setCompleted();
                            operation.setSuccessful();
                        } else {
                            operation.setException(result.message);
                            me.fireEvent('exception', this, response, operation);
                        }
                    } else {
                        if (response) {
                            me.setException(operation, response);
                        }
                        me.fireEvent('exception', this, response, operation);
                    }


                    if (typeof callback == 'function') {
                        callback.call(scope || me, operation);
                    }

                    me.afterRequest(request, success);
                },


                setException: function (operation, response) {
                    operation.setException({
                        status: response.status,
                        statusText: response.statusText
                    });
                },


                extractResponseData: Ext.identityFn,


                applyEncoding: function (value) {
                    return Ext.encode(value);
                }
            });

            Ext.define('Rally.technicalservices.Toolbox', {
                singleton: true,
                /**
                 * Returns beginnig of month as date for the current time zone
                 * 
                 */
                getBeginningOfMonthAsDate: function (dateInMonth) {
                    var year = dateInMonth.getFullYear();
                    var month = dateInMonth.getMonth();
                    return new Date(year, month, 1, 0, 0, 0, 0);
                },
                getEndOfMonthAsDate: function (dateInMonth) {
                    var year = dateInMonth.getFullYear();
                    var month = dateInMonth.getMonth();
                    var day = new Date(year, month + 1, 0).getDate();
                    return new Date(year, month, day, 0, 0, 0, 0);
                },
                aggregateSnapsByOid: function (snaps) {
                    //Return a hash of objects (key=ObjectID) with all snapshots for the object
                    var snaps_by_oid = {};
                    Ext.each(snaps, function (snap) {
                        var oid = snap.ObjectID || snap.get('ObjectID');
                        if (snaps_by_oid[oid] == undefined) {
                            snaps_by_oid[oid] = [];
                        }
                        snaps_by_oid[oid].push(snap);

                    });
                    return snaps_by_oid;
                },
                getCaseInsensitiveKey: function (obj, inputStr) {
                    var new_key = inputStr;
                    Ext.Object.each(obj, function (key, val) {
                        if (new_key.toLowerCase() == key.toLowerCase()) {
                            new_key = key;
                        }
                    });
                    return new_key;

                },
                aggregateSnapsByOidForModel: function (snaps) {
                    //Return a hash of objects (key=ObjectID) with all snapshots for the object
                    var snaps_by_oid = {};
                    Ext.each(snaps, function (snap) {
                        var oid = snap.ObjectID || snap.get('ObjectID');
                        if (snaps_by_oid[oid] == undefined) {
                            snaps_by_oid[oid] = [];
                        }
                        snaps_by_oid[oid].push(snap.getData());
                    });
                    return snaps_by_oid;
                },
                getDateBuckets: function (startDate, endDate, granularity) {

                    var bucketStartDate = Rally.technicalservices.Toolbox.getBeginningOfMonthAsDate(
                        startDate);
                    var bucketEndDate = Rally.technicalservices.Toolbox.getEndOfMonthAsDate(endDate);

                    var date = bucketStartDate;

                    var buckets = [];
                    while (date < bucketEndDate && bucketStartDate < bucketEndDate) {
                        buckets.push(date);
                        date = Rally.util.DateTime.add(date, granularity, 1);
                    }
                    return buckets;
                },
                formatDateBuckets: function (buckets, dateFormat) {
                    var categories = [];
                    Ext.each(buckets, function (bucket) {
                        categories.push(Rally.util.DateTime.format(bucket, dateFormat));
                    });
                    categories[categories.length - 1] += "*";
                    return categories;
                }
            });

            Ext.define('CustomApp', {
                extend: 'Rally.app.App',
                componentCls: 'app',
                logger: new Rally.technicalservices.Logger(),
                items: [{
                        xtype: 'container',
                        itemId: 'settings_box'
                    },
                    {
                        xtype: 'container',
                        itemId: 'selector_box',
                        layout: {
                            type: 'hbox'
                        }
                    },
                    {
                        xtype: 'container',
                        itemId: 'button_box',
                        layout: {
                            type: 'hbox'
                        }
                    },
                    {
                        xtype: 'container',
                        itemId: 'display_box',
                        padding: 25,
                        tpl: '<tpl><b>{msg}</b></tpl>'
                    },
                    {
                        xtype: 'container',
                        itemId: 'filter_box',
                        padding: 10,
                        margin: 10,
                        tpl: '<div class="ts-filter"><b>Applied Filters:</b><br><tpl for=".">{displayProperty} {operator} {value}<br></tpl></div>'
                    },
                    {
                        xtype: 'tsinfolink'
                    }
                ],
                //scheduleStateMapping: {
                //    "21934055950": "Accepted",
                //    "21934055944": "Defined" ,
                //    "21934055946": "In-Progress",
                //    "21934055948": "Completed"
                //},
                exportHash: {
                    formattedId: 'Formatted ID',
                    days: 'Cycle Time (Days)',
                    startDate: 'Start Date',
                    endDate: 'End Date',
                    pctBlocked: '% Cycle Time Blocked',
                    pctReady: '% Cycle Time Ready'
                },
                config: {
                    defaultSettings: {
                        cycleStateFields: "ScheduleState"
                    },
                },
                defaultField: 'ScheduleState',
                cycleFields: [],
                granularityStore: [{
                    displayName: 'Month',
                    value: 'month',
                    dateFormat: 'M yyyy',
                    tickInterval: 1
                }, {
                    displayName: 'Week',
                    value: 'week',
                    dateFormat: 'M dd yyyy',
                    tickInterval: 5
                }],
                hiddenSeries: [],
                dateRangeStore: [{
                        name: 'Last Complete Month',
                        value: -1
                    },
                    {
                        name: 'Last 2 Complete Months',
                        value: -2
                    },
                    {
                        name: 'Last 3 Complete Months',
                        value: -3
                    },
                    {
                        name: 'Last 6 Complete Months',
                        value: -6
                    },
                    {
                        name: 'Last 12 Complete Months',
                        value: -12
                    }
                ],
                defaultDateRange: -3,
                dataFilters: [],
                launch: function () {
                    if (this.isExternal()) {
                        this.showSettings(this.config);
                    } else {
                        this.onSettingsUpdate(this.getSettings()); //(this.config.type,this.config.pageSize,this.config.fetch,this.config.columns);
                    }
                },
                _initializeApp: function (validFields) {
                    var field_store = Ext.create('Rally.data.custom.Store', {
                        data: validFields,
                        autoLoad: true
                    });

                    this.logger.log('_initializeApp', validFields);

                    var cb = this.down('#selector_box').add({
                        xtype: 'rallycombobox',
                        itemId: 'cb-field',
                        store: field_store,
                        valueField: 'name',
                        displayField: 'displayName',
                        fieldLabel: 'Field',
                        labelAlign: 'right',
                        labelWidth: 50,
                        queryMode: 'local',
                        allowNoEntry: false,
                        margin: 10,
                        scope: this,
                        listeners: {
                            scope: this,
                            select: this._updateDropdowns,
                            ready: function (cb) {
                                this._updateDropdowns(cb);
                            }
                        }
                    });
                },
                _getGroupPrecedence: function () {
                    var data = this.down('#cb-from-state').getStore().data;

                    var group = [];
                    Ext.each(data.items, function (rec) {
                        group.push(rec.get('ObjectID'));
                    });
                    this.logger.log('_getGroupPrecedence', this.down('#cb-from-state').getStore(),
                        group);
                    return group;
                },
                _fetchFields: function (cycleStateFields) {
                    var deferred = Ext.create('Deft.Deferred');
                    this.logger.log('_fetchFields', cycleStateFields);
                    var allowed_attribute_types = ['STATE', 'STRING'];
                    var additional_filterable_fields = ['PlanEstimate'];
                    var valid_fields = [];
                    var filter_fields = [];

                    var promises = [this._fetchModelFields('HierarchicalRequirement'), this._fetchModelFields(
                        'Defect')];
                    Deft.Promise.all(promises).then({
                        scope: this,
                        success: function (fields) {
                            var scheduleStateField = null;
                            fields = _.flatten(fields);
                            this.logger.log('_fetchFields success', fields);
                            var field_names = [];
                            Ext.each(fields, function (f) {
                                if (f.hidden === false && f.attributeDefinition) {
                                    var attr_def = f.attributeDefinition;
                                    if (!Ext.Array.contains(field_names,
                                            attr_def.ElementName)) {
                                        if (Ext.Array.contains(cycleStateFields,
                                                attr_def.ElementName)) {
                                            valid_fields.push(f);

                                        }
                                        if (Ext.Array.contains(
                                                additional_filterable_fields,
                                                attr_def.ElementName) ||
                                            (attr_def.Constrained && Ext.Array.contains(
                                                    allowed_attribute_types,
                                                    attr_def.AttributeType) &&
                                                attr_def.ReadOnly == false)) {
                                            field_names.push(attr_def.ElementName);
                                            filter_fields.push(f);
                                        }
                                    }
                                }
                            });

                            this.filterFields = _.uniq(filter_fields);
                            this.cycleFields = _.uniq(valid_fields);
                            deferred.resolve();
                        }
                    });
                    return deferred;
                },
                _fetchModelFields: function (type) {
                    var deferred = Ext.create('Deft.Deferred');
                    Rally.data.ModelFactory.getModel({
                        type: type,
                        scope: this,
                        success: function (model) {
                            this.logger.log('_fetchModelFields', model.getFields());
                            deferred.resolve(model.getFields());

                        }
                    });
                    return deferred;
                },
                /**
                 * Called when the field is updated.  
                 */
                _updateDropdowns: function (cb) {

                    this.logger.log('_updateDropdowns', cb.getValue(), cb.getRecord());

                    if (this.down('#cb-from-state')) {
                        this.down('#cb-date-range').destroy();
                        this.down('#cb-from-state').destroy();
                        this.down('#cb-to-state').destroy();
                        this.down('#cb-granularity').destroy();
                        this.down('#btn-update').destroy();
                        this.down('#btn-filter').destroy();
                        this.down('#btn-export').destroy();
                    }

                    var field = cb.getValue();

                    if (cb.getRecord()) {
                        var model = cb.getRecord().get('modelType');

                        this.down('#selector_box').add({
                            xtype: 'rallyfieldvaluecombobox',
                            itemId: 'cb-from-state',
                            model: model,
                            field: field,
                            valueField: 'ObjectID',
                            allowNoEntry: false,
                            fieldLabel: 'Start',
                            labelAlign: 'right',
                            labelWidth: 30,
                            margin: 10
                        });

                        this.down('#selector_box').add({
                            xtype: 'rallyfieldvaluecombobox',
                            itemId: 'cb-to-state',
                            model: model,
                            field: field,
                            fieldLabel: 'End',
                            labelAlign: 'right',
                            labelWidth: 30,
                            margin: 10
                        });

                        var granularity_store = Ext.create('Rally.data.custom.Store', {
                            data: this.granularityStore
                        });
                        this.down('#selector_box').add({
                            xtype: 'rallycombobox',
                            itemId: 'cb-granularity',
                            store: granularity_store,
                            displayField: 'displayName',
                            valueField: 'value',
                            fieldLabel: 'Granularity',
                            labelAlign: 'right',
                            labelWidth: 65,
                            margin: 10
                        });

                        var date_store = Ext.create('Rally.data.custom.Store', {
                            data: this.dateRangeStore
                        });

                        this.down('#selector_box').add({
                            xtype: 'rallycombobox',
                            itemId: 'cb-date-range',
                            store: date_store,
                            displayField: 'name',
                            valueField: 'value',
                            fieldLabel: 'Date Range',
                            labelAlign: 'right',
                            labelWidth: 65,
                            width: 250,
                            value: this.defaultDateRange,
                            margin: 10
                        });

                        var button_width = 75;
                        this.down('#button_box').add({
                            xtype: 'rallybutton',
                            itemId: 'btn-update',
                            text: 'Update',
                            scope: this,
                            width: button_width,
                            margin: '5 5 5 65',
                            handler: this._createChart
                        });

                        this.down('#button_box').add({
                            xtype: 'rallybutton',
                            itemId: 'btn-filter',
                            scope: this,
                            text: 'Filter',
                            width: button_width,
                            margin: 5,
                            handler: this._filter
                        });
                        this.down('#button_box').add({
                            xtype: 'rallybutton',
                            itemId: 'btn-export',
                            scope: this,
                            text: 'Export',
                            width: button_width,
                            margin: 5,
                            handler: this._export
                        });
                    }
                },
                _getStartState: function () {
                    return this.down('#cb-from-state').getValue();
                },
                _getEndState: function () {
                    return this.down('#cb-to-state').getValue();
                },

                _createChart: function () {
                    var field = this.down('#cb-field').getValue();
                    var granularity_rec = this.down('#cb-granularity').getRecord();
                    var granularity = granularity_rec.get('value');
                    var end_date = new Date();

                    var date_range = this.down('#cb-date-range').getValue();
                    var start_date = Rally.util.DateTime.add(new Date(), "month", date_range);
                    var start_state = this._getStartState();
                    var filters = this.dataFilters;
                    filters.push({
                        property: 'Children',
                        value: ""
                    });

                    this.logger.log('_createChart', field, start_state, this._getEndState(),
                        granularity, start_date, end_date);

                    this.setLoading('Fetching data...');
                    this._cleanUI(['#rally-chart', '#rally-grid']);

                    this.loadSnapshots([this._getStoreConfig('Defect'), this._getStoreConfig(
                        'HierarchicalRequirement')]).then({
                        scope: this,
                        success: function (snapshots) {
                            var calc = Ext.create('CycleCalculator', {
                                cycleField: field,
                                cycleStartValue: start_state,
                                cycleEndValue: this._getEndState(),
                                cyclePrecedence: this._getGroupPrecedence(),
                                startDate: start_date,
                                endDate: end_date,
                                granularity: granularity,
                                dateFormat: granularity_rec.get('dateFormat'),
                                dataFilters: filters
                            });

                            this.setLoading(false);
                            var chart_data = calc.runCalculation(snapshots);
                            this._drawChart(chart_data);
                            this._buildGrid(calc.summaryData);
                            this.exportData = calc.cycleTimeDataExport;
                        },
                        failure: function (msg) {
                            var error_msg = msg + '.  Please retry your request.';
                            this._cleanUI(['#rally-chart', '#rally-grid'], error_msg);
                            this.setLoading(false);
                        }
                    });
                },
                _export: function () {
                    if (this.exportData) {
                        this.logger.log('_export', this.exportHash);
                        var text = Rally.technicalservices.FileUtilities.convertDataArrayToCSVText(
                            this.exportData, this.exportHash);
                        Rally.technicalservices.FileUtilities.saveTextAsFile(text,
                            'flow-efficiency.csv');
                    }
                },
                _cleanUI: function (componentIds, msg) {

                    Ext.each(componentIds, function (c) {
                        if (this.down(c)) {
                            this.down(c).destroy();
                        }
                    }, this);

                    if (msg == undefined) {
                        msg = '';
                    }
                    this.down('#display_box').update({
                        msg: msg
                    });
                },
                _drawChart: function (chart_data) {
                    this.logger.log('_drawChart');

                    var me = this;
                    var chart = this.down('#rally-chart')
                    if (chart) {
                        this.down('#rally-chart').destroy();
                        this.down('#rally-grid').destroy();
                    }

                    var granularity_rec = this.down('#cb-granularity').getRecord();
                    var title_text = 'Average Flow Efficiency from ' + (this._getStartState() ||
                        '(None)') + ' to ' + this._getEndState();
                    var tick_interval = granularity_rec.get('tickInterval');

                    this.down('#display_box').add({
                        xtype: 'rallychart',
                        itemId: 'rally-chart',
                        chartData: chart_data,
                        loadMask: false,
                        chartColors: ['#000000', '#8bbc21', '#c42525', '#8bbc21', '#c42525'],
                        updateAfterRender: function () {
                            if (me.hiddenSeries && me.hiddenSeries.length > 0) {
                                Ext.each(this.chartData.series, function (s) {
                                    if (Ext.Array.contains(me.hiddenSeries, s.name)) {
                                        s.visible = false;
                                    }
                                });
                            }
                        },
                        updateBeforeRender: this._beforeChartRender,
                        chartConfig: {
                            chart: {
                                zoomType: 'xy',
                                type: 'line'
                            },
                            title: {
                                text: title_text
                            },
                            xAxis: {
                                tickInterval: tick_interval,
                                title: {
                                    text: 'Date Entered ' + this._getEndState()
                                }
                            },
                            yAxis: [{
                                title: {
                                    text: '% Flow Efficiency'
                                },
                                //min: 0,
                                max: 100
                            }],
                            plotOptions: {
                                series: {
                                    dataLabels: {
                                        format: '{point.y:.1f}%'
                                    },
                                    marker: {
                                        enabled: false,
                                    },
                                    events: {
                                        legendItemClick: function () {
                                            if (this.visible) {
                                                //we are hiding it
                                                me.hiddenSeries = _.union(me.hiddenSeries, [
                                                    this.name
                                                ]);
                                            } else {
                                                me.hiddenSeries = _.without(me.hiddenSeries,
                                                    this.name);
                                            }
                                        }
                                    }

                                },
                                line: {
                                    connectNulls: true,
                                    tooltip: {
                                        pointFormat: '<span style="color:{series.color}">\u25CF</span> {series.name}: <b>{point.y:.1f}%</b><br/>'
                                    }
                                }
                            },
                        }
                    });
                },
                _buildGrid: function (summaryData) {
                    this.logger.log('_buildGrid', summaryData);

                    var store = Ext.create('Rally.data.custom.Store', {
                        data: summaryData
                    });

                    this.down('#display_box').add({
                        xtype: 'rallygrid',
                        store: store,
                        itemId: 'rally-grid',
                        columnCfgs: [{
                            text: 'Date',
                            dataIndex: 'date'
                        }, {
                            text: '% Blocked',
                            dataIndex: 'pctBlocked'
                        }, {
                            text: '% Ready',
                            dataIndex: 'pctReady'
                        }, {
                            text: 'Avg Cycle Time',
                            dataIndex: 'avgCycleTime'
                        }, {
                            text: 'Total Cycle Time',
                            dataIndex: 'totalCycleTime'
                        }, {
                            text: 'Total Artifacts',
                            dataIndex: 'numArtifacts'
                        }]
                    });
                },
                _beforeChartRender: function () {
                    this.chartConfig.plotOptions.line.tooltip.pointFormat =
                        '<span style="color:{series.color}">\u25CF</span> {series.name}: <b>{point.y:.1f}% {point.n}</b><br/>';
                },
                _setFilters: function (filters) {
                    this.dataFilters = filters;
                    this.down('#filter_box').update(filters);
                },
                _filter: function () {
                    this.logger.log('_filter', this.filterFields);
                    Ext.create('Rally.technicalservices.dialog.Filter', {
                        validFields: this.filterFields,
                        filters: this.dataFilters,
                        listeners: {
                            scope: this,
                            customFilter: function (filters) {
                                this.logger.log('_filter event fired', filters);
                                this._setFilters(filters);
                                this._createChart();
                            }
                        }
                    });
                },
                /**
                 * Functions to load the snapshots upfront
                 * 
                 */
                loadSnapshots: function (storeConfigs) {
                    var deferred = Ext.create('Deft.Deferred');
                    this.logger.log('loadSnapshots', storeConfigs);

                    var promises = [];
                    Ext.each(storeConfigs, function (storeConfig) {
                        promises.push(this._loadStore(storeConfig));
                    }, this);

                    Deft.Promise.all(promises).then({
                        scope: this,
                        success: function (snapshots) {
                            this.logger.log('loadSnapshots success', snapshots);
                            var hydrated_snaps = [];
                            // var scheduleStateMapping = this.scheduleStateMapping;
                            for (var i = 0; i < snapshots.length; i++) {
                                var type = storeConfigs[i]["find"]["_TypeHierarchy"];
                                //Now we will hydrate the type ourselves
                                hydrated_snaps.push(_.map(snapshots[i], function (snap) {
                                    var obj = snap.getData();
                                    //  obj["ScheduleState"] = scheduleStateMapping[snap.get('ScheduleState').toString()]
                                    obj["_TypeHierarchy"] = [type];
                                    return obj;
                                }));

                            }
                            hydrated_snaps = _.flatten(hydrated_snaps);
                            deferred.resolve(hydrated_snaps);
                        },
                        failure: function (type) {
                            var msg = "Error fetching data for " + type;
                            deferred.reject(msg);
                        }
                    });
                    return deferred;
                },
                _loadStore: function (storeConfig) {
                    var deferred = Ext.create('Deft.Deferred');

                    this.logger.log('_loadStore', storeConfig);
                    var start = Date.now();
                    storeConfig = _.extend(storeConfig, {
                        limit: 'Infinity',
                        removeUnauthorizedSnapshots: true,
                        autoLoad: true,
                        sort: {
                            _ValidFrom: 1
                        },
                        listeners: {
                            scope: this,
                            load: function (store, records, success) {
                                this.logger.log('_loadStore load returned', Date.now() -
                                    start, records.length, success, records);
                                if (success) {
                                    deferred.resolve(records);
                                } else {
                                    this.logger.log('_loadStore failed for config',
                                        Date.now() - start, storeConfig);
                                    deferred.reject(storeConfig["find"][
                                        "_TypeHierarchy"
                                    ]);
                                }
                            }
                        }
                    });
                    this.logger.log('_loadStore create store');
                    Ext.create('Rally.data.lookback.SnapshotStore', storeConfig);

                    return deferred;
                },
                _getStoreConfig: function (type) {
                    var field = this.down('#cb-field').getValue();
                    var fetch = this._getFetchFields();
                    this.logger.log('_getStoreConfig', type, field, fetch);
                    var find = {
                        "_TypeHierarchy": type
                    };

                    var project = this.getContext().getProject().ObjectID;
                    if (this.getContext().getProjectScopeDown()) {
                        find["_ProjectHierarchy"] = {
                            $in: [project]
                        };
                    } else {
                        find["Project"] = project;
                    }
                    var store_config = {
                        find: find,
                        fetch: fetch,
                        hydrate: ['ScheduleState'],
                        sort: {
                            _ValidFrom: 1
                        },
                        context: this.getContext().getDataContext(),
                    }
                    //        if (type == 'HierarchicalRequirement'){
                    //            store_config["context"] = {workspace: 'bldkjs/dakfjfa'};
                    //        }
                    this.logger.log('_getStoreConfig', store_config);
                    return store_config;
                },
                _getFetchFields: function () {
                    var field = this.down('#cb-field').getValue();
                    var fetch_fields = ['ObjectID', field, '_TypeHierarchy', '_SnapshotNumber',
                        'ScheduleState', 'FormattedID', 'Blocked', 'Ready', '_ValidTo',
                        '_ValidFrom', 'Children'
                    ];

                    var filter_fields = [];
                    Ext.each(this.dataFilters, function (f) {
                        if (f.property != field) {
                            filter_fields.push(f.property);
                        }
                    }, this);
                    this.logger.log('_getFetchFields', Ext.Array.merge(fetch_fields, filter_fields));
                    return Ext.Array.merge(fetch_fields, filter_fields);
                },
                /********************************************
                /* Overrides for App class
                /*
                /********************************************/
                //getSettingsFields:  Override for App    
                getSettingsFields: function () {

                    return [{
                        name: 'cycleStateFields',
                        xtype: 'rallyfieldpicker',
                        modelTypes: ['HierarchicalRequirement', 'Defect'],
                        labelWidth: 100,
                        fieldLabel: 'Valid Cycle States',
                        labelAlign: 'left',
                        minWidth: 400,
                        margin: '10 0 255 0',
                        autoExpand: false,
                        alwaysExpanded: false,
                        storeConfig: {
                            context: {
                                project: null
                            }
                        }
                    }];
                },
                isExternal: function () {
                    return typeof (this.getAppId()) == 'undefined';
                },
                //showSettings:  Override
                showSettings: function (options) {
                    this._appSettings = Ext.create('Rally.app.AppSettings', Ext.apply({
                        fields: this.getSettingsFields(),
                        settings: this.getSettings(),
                        defaultSettings: this.getDefaultSettings(),
                        context: this.getContext(),
                        settingsScope: this.settingsScope,
                        autoScroll: true
                    }, options));

                    this._appSettings.on('cancel', this._hideSettings, this);
                    this._appSettings.on('save', this._onSettingsSaved, this);
                    if (this.isExternal()) {
                        if (this.down('#settings_box').getComponent(this._appSettings.id) ==
                            undefined) {
                            this.down('#settings_box').add(this._appSettings);
                        }
                    } else {
                        this.hide();
                        this.up().add(this._appSettings);
                    }
                    return this._appSettings;
                },
                _onSettingsSaved: function (settings) {
                    Ext.apply(this.settings, settings);
                    this._hideSettings();
                    this.onSettingsUpdate(settings);
                },
                //onSettingsUpdate:  Override
                onSettingsUpdate: function (settings) {
                    //Build and save column settings...this means that we need to get the display names and multi-list
                    var cycleStateFields_setting = this.getSetting('cycleStateFields');
                    if (cycleStateFields_setting instanceof Array) {
                        cycleStateFields = cycleStateFields_setting;
                    } else {
                        cycleStateFields = cycleStateFields_setting.split(',');
                    }
                    this.logger.log('onSettingsUpdate', settings, cycleStateFields);
                    this._fetchFields(cycleStateFields).then({
                        scope: this,
                        success: function () {
                            this.logger.log('Valid fields for cycle and filter time',
                                this.cycleFields, this.filterFields);
                            this._initializeApp(this.cycleFields);
                        }
                    });


                }
            });

            Rally.launchApp('CustomApp', {
                name: 'Flow Efficiency'
            });
        });
    </script>

    <style type="text/css">
        .app {}

        .tsinfolink {
            position: absolute;
            right: 0px;
            width: 14px;
            height: 14px;
            border-radius: 7px;
            text-align: center;
            color: white;
            background: #C0C0C0;
            border-style: solid;
            border-width: 1px;
            margin-top: 25px;
            margin-right: 5px;
            cursor: pointer;
        }
    </style>

</head>

<body></body>

</html>
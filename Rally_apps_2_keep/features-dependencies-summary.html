<!DOCTYPE html>
<html>

<head>
    <title>Dependency Summary by Features</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/0.2.7/async.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function() {
            var app = null;
            Ext.define("CustomApp", {
                extend: "Rally.app.TimeboxScopedApp",
                scopeType: "release",
                componentCls: "app",
                items: {},
                config: {
                    defaultSettings: {
                        showDefects: !0,
                        showBlocked: !0,
                        showTime: !1,
                        showTasks: !0,
                        showDependencies: !0
                    }
                },
                getSettingsFields: function() {
                    return [{
                        name: "showDefects",
                        xtype: "rallycheckboxfield",
                        label: "Selected to show Defects column"
                    }, {
                        name: "showBlocked",
                        xtype: "rallycheckboxfield",
                        label: "Selected to show Blocked column"
                    }, {
                        name: "showTime",
                        xtype: "rallycheckboxfield",
                        label: "Selected to show Time Tracker column"
                    }, {
                        name: "showTasks",
                        xtype: "rallycheckboxfield",
                        label: "Selected to show Task columns"
                    }, {
                        name: "showDependencies",
                        xtype: "rallycheckboxfield",
                        label: "Selected to show Dependencies columns"
                    }]
                },
                onScopeChange: function(scope) {
                    console.log("launch"), app = this, app.iterations = null, app.showBlocked = app.getSetting("showBlocked"), app.showDefects = app.getSetting("showDefects"), app.showTime = app.getSetting("showTime"), app.showTasks = app.getSetting("showTasks"), app.showDependencies = app.getSetting("showDependencies"), app.releaseName = null;
                    var timeboxScope = this.getContext().getTimeboxScope();
                    if (timeboxScope) {
                        var record = timeboxScope.getRecord();
                        app.releaseName = "release" === timeboxScope.getType() ? record.get("Name") : null
                    } else app.releaseName = "2015 Q1";
                    console.log("Release", app.releaseName), this.addFeatureGrid()
                },
                timeColumn: {
                    text: "Time",
                    width: 100,
                    renderer: function(value, metaData, record, rowIdx, colIdx, store, view) {
                        var defects = record.get("Defects");
                        if (defects && defects.length > 0) {
                            var states = _.countBy(defects, function(d) {
                                return "Closed" != d.get("State") ? "Open" : "Closed"
                            });
                            states.Open = void 0 !== states.Open ? states.Open : 0, states.length = defects.length;
                            var tpl = Ext.create("Ext.Template", "{Open}/{length}", {
                                compiled: !0
                            });
                            return tpl.apply(states)
                        }
                        return ""
                    }
                },
                taskEstimateColumn: {
                    text: "Task Estimate",
                    width: 100,
                    renderer: function(value, metaData, record, rowIdx, colIdx, store, view) {
                        var tasks = record.get("Tasks"),
                            estimate = _.reduce(tasks, function(sum, task) {
                                return sum + (_.isNumber(task.get("Estimate")) ? task.get("Estimate") : 0)
                            }, 0);
                        return estimate > 0 ? estimate : ""
                    }
                },
                taskToDoColumn: {
                    text: "Task ToDo",
                    width: 100,
                    renderer: function(value, metaData, record, rowIdx, colIdx, store, view) {
                        var tasks = record.get("Tasks"),
                            todo = _.reduce(tasks, function(sum, task) {
                                return sum + (_.isNumber(task.get("ToDo")) ? task.get("ToDo") : 0)
                            }, 0);
                        return todo > 0 ? todo : ""
                    }
                },
                taskActualsColumn: {
                    text: "Task Actuals",
                    width: 100,
                    renderer: function(value, metaData, record, rowIdx, colIdx, store, view) {
                        var tasks = record.get("Tasks"),
                            actuals = _.reduce(tasks, function(sum, task) {
                                return sum + (_.isNumber(task.get("Actuals")) ? task.get("Actuals") : 0)
                            }, 0);
                        return actuals > 0 ? actuals : ""
                    }
                },
                defectColumn: {
                    text: "Defects",
                    width: 100,
                    renderer: function(value, metaData, record, rowIdx, colIdx, store, view) {
                        var defects = record.get("Defects");
                        if (defects && defects.length > 0) {
                            var states = _.countBy(defects, function(d) {
                                return "Closed" != d.get("State") ? "Open" : "Closed"
                            });
                            states.Open = void 0 !== states.Open ? states.Open : 0, states.length = defects.length;
                            var tpl = Ext.create("Ext.Template", "{Open}/{length}", {
                                compiled: !0
                            });
                            return tpl.apply(states)
                        }
                        return ""
                    }
                },
                blockedColumn: {
                    text: "Blocked",
                    width: 100,
                    renderer: function(value, metaData, record, rowIdx, colIdx, store, view) {
                        var blockedSnapshots = record.get("Blocked");
                        return !_.isUndefined(blockedSnapshots) && blockedSnapshots.length > 0 ? blockedSnapshots.length : ""
                    }
                },
                dependenciesColumn: {
                    text: "Dependencies",
                    width: 500,
                    flex: 1,
                    renderer: function(value, metaData, record, rowIdx, colIdx, store, view) {
                        var snapshots = record.get("Dependencies"),
                            s = app.renderDependencyTable(record);
                        return s.replace(/\,/g, "")
                    }
                },
                renderDependencyTable: function(feature) {
                    var snapshots = feature.get("Dependencies");
                    if (void 0 === snapshots) return ".";
                    var s = "<table class='financial'>" + (snapshots.length > 0 ? "<tr><th>Feature Stories</th><th>Predecessors</th></tr>" : "") + _.map(snapshots, function(fstory) {
                        return "<tr><td>" + app.renderId(fstory) + " : " + fstory.get("Name") + app.renderFeatureStoryIterationDate(fstory) + "</td>" + "<td><table>" + _.map(fstory.get("PredStories"), function(pstory) {
                            var it = app.getIteration(pstory);
                            return "<tr><td>" + app.renderState(pstory) + "</td>" + "<td>" + app.renderId(pstory) + " : " + pstory.get("Name") + app.renderProject(fstory, pstory) + "</td>" + "<td>" + app.renderPredecessorIterationDate(fstory, pstory) + "</td>" + "</tr>"
                        }) + "</table></td></tr>"
                    }) + "</table>";
                    return s
                },
                refToOid: function(ref) {
                    return new Rally.util.Ref(ref).getOid()
                },
                renderProject: function(story, pred) {
                    var fStoryID = story.get("Project"),
                        pStoryID = app.refToOid(pred.get("Project")._ref);
                    return fStoryID !== pStoryID ? " (" + pred.get("Project")._refObjectName + ")" : ""
                },
                renderState: function(story) {
                    var cls = story.get("Blocked") === !0 ? "state-legend-blocked" : "state-legend";
                    return "<span class='" + cls + "'>" + story.get("ScheduleState").charAt(0) + "</span>"
                },
                renderId: function(story) {
                    var fid = story.get("FormattedID"),
                        ref = story.get("_ref"),
                        l = "null";
                    if (_.isUndefined(ref)) var l = Rally.nav.DetailLink.getLink({
                        record: {
                            _ref: "/hierarchicalrequirement/" + story.get("ObjectID")
                        },
                        text: fid
                    });
                    else l = Rally.nav.DetailLink.getLink({
                        record: story,
                        text: fid
                    });
                    return l.replace(/\"/g, "'")
                },
                renderFeatureStoryIterationDate: function(fstory) {
                    var fit = app.getIteration(fstory);
                    if (null === fit) return "<span class = 'iteration-none'> (None)</span>";
                    var pdt = Rally.util.DateTime.fromIsoString(fit.get("EndDate")),
                        pdv = pdt.getMonth() + 1 + "/" + pdt.getDate();
                    return "<span> (" + pdv + ")</span>"
                },
                renderPredecessorIterationDate: function(fstory, pstory) {
                    var fit = app.getIteration(fstory),
                        pit = app.getIteration(pstory);
                    if (null === pit) return "<span class = 'iteration-none'>(None)</span>";
                    var pdt = Rally.util.DateTime.fromIsoString(pit.get("EndDate")),
                        pdv = pdt.getMonth() + 1 + "/" + pdt.getDate();
                    if (null === fit) return "<span>" + pdv + "</span>";
                    var fdt = Rally.util.DateTime.fromIsoString(fit.get("EndDate"));
                    return pdt > fdt ? "<span class='iteration-late'>" + pdv + "</span>" : "<span class='iteration-good'>" + pdv + "</span>"
                },
                createReleaseFilter: function(releaseNames) {
                    var filter = null;
                    return _.each(releaseNames.split(","), function(releaseName, i) {
                        if ("" !== releaseName) {
                            var f = Ext.create("Rally.data.wsapi.Filter", {
                                property: "Release.Name",
                                operator: "=",
                                value: app.trimString(releaseName)
                            });
                            filter = 0 === i ? f : filter.or(f)
                        }
                    }), filter
                },
                trimString: function(str) {
                    return str.replace(/^\s\s*/, "").replace(/\s\s*$/, "")
                },
                addFeatureGrid: function() {
                    Rally.data.ModelFactory.getModel({
                        type: "PortfolioItem/Feature",
                        success: function(userStoryModel) {
                            var columnCfgs = [{
                                dataIndex: "FormattedID",
                                text: "ID",
                                width: 10,
                                flex: 1
                            }, {
                                dataIndex: "Name",
                                width: 150,
                                flex: 1
                            }, {
                                dataIndex: "Owner",
                                width: 100,
                                flex: 1
                            }];
                            app.showDefects && columnCfgs.push(app.defectColumn), app.showBlocked && columnCfgs.push(app.blockedColumn), app.showTime && columnCfgs.push(app.timeColumn), app.showTasks && (columnCfgs.push(app.taskEstimateColumn), columnCfgs.push(app.taskToDoColumn), columnCfgs.push(app.taskActualsColumn)), app.showDependencies && (columnCfgs.push({
                                dataIndex: "Notes",
                                width: 200,
                                flex: 1
                            }), columnCfgs.push(app.dependenciesColumn)), _.isUndefined(app.grid) && _.isNull(app.grid) || app.remove(app.grid), app.grid = Ext.create("Rally.ui.grid.Grid", {
                                itemId: "mygrid",
                                height: 800,
                                xtype: "rallygrid",
                                model: userStoryModel,
                                storeConfig: {
                                    filters: null !== app.releaseName ? [app.createReleaseFilter(app.releaseName)] : null
                                },
                                listeners: {
                                    afterrender: function() {},
                                    load: function(items) {
                                        var features = items.data.items;
                                        async.series([function(callback) {
                                            async.map(features, app.getDefectSnapshots, function(err, results) {
                                                callback(null, results)
                                            })
                                        }, function(callback) {
                                            async.map(features, app.getBlockedSnapshots, function(err, results) {
                                                callback(null, results)
                                            })
                                        }, function(callback) {
                                            async.map(features, app.getTaskSnapshots, function(err, results) {
                                                callback(null, results)
                                            })
                                        }, function(callback) {
                                            async.map(features, app.getDependencySnapshots, function(err, results) {
                                                async.mapSeries(results, app.readPredecessors, function(err, preds) {
                                                    callback(null, results)
                                                })
                                            })
                                        }], function(err, results) {
                                            _.each(features, function(feature, i) {
                                                feature.set("Defects", results[0][i]), feature.set("Blocked", results[1][i]), feature.set("Tasks", results[2][i]), feature.set("Dependencies", results[3][i])
                                            }), null === app.iterations && app.loadIterations(features, function() {
                                                app.grid.fireEvent("iterationsLoaded")
                                            })
                                        })
                                    }
                                },
                                columnCfgs: columnCfgs
                            }), app.showTime && app.grid.columnCfgs.push(app.timeColumn), app.add(app.grid), app.grid.on("iterationsLoaded", function() {
                                app.grid.getView().refresh()
                            })
                        }
                    })
                },
                readPredecessors: function(stories, callback) {
                    async.mapSeries(stories, function(story, callback) {
                        async.mapSeries(story.get("Predecessors"), app.readStory, function(err, results) {
                            var preds = _.flatten(results);
                            story.set("PredStories", preds), callback(null, null)
                        })
                    }, function(err, stories) {
                        callback(null, null)
                    })
                },
                readStory: function(id, callback) {
                    var configs = [{
                        model: "HierarchicalRequirement",
                        fetch: !0,
                        filters: [{
                            property: "ObjectID",
                            operator: "=",
                            value: id
                        }],
                        context: {
                            project: null
                        }
                    }];
                    async.map(configs, app.wsapiQuery, function(err, results) {
                        callback(null, results[0])
                    })
                },
                readIteration: function(id, callback) {
                    var configs = [{
                        model: "Iteration",
                        fetch: !0,
                        filters: [{
                            property: "ObjectID",
                            operator: "=",
                            value: id
                        }],
                        context: {
                            project: null
                        }
                    }];
                    async.map(configs, app.wsapiQuery, function(err, results) {
                        callback(null, results[0])
                    })
                },
                getIteration: function(story) {
                    var id = null;
                    if (_.isUndefined(story.get("_ref"))) id = story.get("Iteration");
                    else {
                        var ref = null !== story.get("Iteration") ? story.get("Iteration")._ref : null;
                        if (null === ref) return null;
                        id = app.refToOid(ref)
                    }
                    var it = _.find(app.iterations, function(i) {
                        return i.get("ObjectID") === id
                    });
                    return _.isUndefined(it) ? null : it
                },
                loadIterations: function(features, callback) {
                    var iterations = _.map(features, function(f) {
                            var dIterations = _.map(f.get("Dependencies"), function(d) {
                                var pIterations = _.map(d.get("PredStories"), function(ps) {
                                    var ref = null !== ps.get("Iteration") ? ps.get("Iteration")._ref : null;
                                    return null !== ref ? app.refToOid(ref) : null
                                });
                                return [d.get("Iteration")].concat(pIterations)
                            });
                            return dIterations
                        }),
                        itOids = _.compact(_.uniq(_.flatten(iterations)));
                    async.map(itOids, app.readIteration, function(err, its) {
                        app.iterations = _.flatten(its), console.log("its", app.iterations), callback(app.iterations)
                    })
                },
                getDefectSnapshots: function(record, callback) {
                    var that = this,
                        fetch = ["ObjectID", "_UnformattedID", "State", "Priority", "Severity", "_ItemHierarchy", "_TypeHierarchy"],
                        hydrate = ["_TypeHierarchy", "State", "Priority", "Severity"],
                        find = {
                            _TypeHierarchy: {
                                $in: ["Defect"]
                            },
                            _ProjectHierarchy: {
                                $in: [app.getContext().getProject().ObjectID]
                            },
                            __At: "current",
                            _ItemHierarchy: {
                                $in: [record.get("ObjectID")]
                            }
                        },
                        storeConfig = {
                            find: find,
                            autoLoad: !0,
                            pageSize: 1e3,
                            limit: "Infinity",
                            fetch: fetch,
                            hydrate: hydrate,
                            listeners: {
                                scope: this,
                                load: function(store, snapshots, success) {
                                    callback(null, snapshots)
                                }
                            }
                        },
                        snapshotStore = Ext.create("Rally.data.lookback.SnapshotStore", storeConfig)
                },
                getBlockedSnapshots: function(record, callback) {
                    var that = this,
                        fetch = ["_TypeHierarchy", "FormattedID", "ObjectID", "_UnformattedID", "Name", "Owner", "Blocked", "ScheduleState"],
                        hydrate = ["_TypeHierarchy", "ScheduleState"],
                        find = {
                            _TypeHierarchy: {
                                $in: ["Defect", "HierarchicalRequirement"]
                            },
                            __At: "current",
                            _ItemHierarchy: {
                                $in: [record.get("ObjectID")]
                            },
                            Blocked: !0
                        },
                        storeConfig = {
                            find: find,
                            autoLoad: !0,
                            pageSize: 1e3,
                            limit: "Infinity",
                            fetch: fetch,
                            hydrate: hydrate,
                            listeners: {
                                scope: this,
                                load: function(store, snapshots, success) {
                                    callback(null, snapshots)
                                }
                            }
                        },
                        snapshotStore = Ext.create("Rally.data.lookback.SnapshotStore", storeConfig)
                },
                getTaskSnapshots: function(record, callback) {
                    var that = this,
                        fetch = ["ObjectID", "Estimate", "ToDo", "Actuals", "_ItemHierarchy", "_TypeHierarchy"],
                        hydrate = ["_TypeHierarchy"],
                        find = {
                            _TypeHierarchy: {
                                $in: ["Task"]
                            },
                            _ProjectHierarchy: {
                                $in: [app.getContext().getProject().ObjectID]
                            },
                            __At: "current",
                            _ItemHierarchy: {
                                $in: [record.get("ObjectID")]
                            }
                        },
                        storeConfig = {
                            find: find,
                            autoLoad: !0,
                            pageSize: 1e3,
                            limit: "Infinity",
                            fetch: fetch,
                            hydrate: hydrate,
                            listeners: {
                                scope: this,
                                load: function(store, snapshots, success) {
                                    callback(null, snapshots)
                                }
                            }
                        },
                        snapshotStore = Ext.create("Rally.data.lookback.SnapshotStore", storeConfig)
                },
                getAllFeatureSnapshots: function(record, callback) {
                    var that = this,
                        fetch = ["ObjectID", "_TypeHierarchy"],
                        hydrate = ["_TypeHierarchy"],
                        find = {
                            _TypeHierarchy: {
                                $in: ["Defect", "Task", "HierarchicalRequirement"]
                            },
                            _ProjectHierarchy: {
                                $in: [app.getContext().getProject().ObjectID]
                            },
                            __At: "current",
                            _ItemHierarchy: {
                                $in: [record.get("ObjectID")]
                            }
                        },
                        storeConfig = {
                            find: find,
                            autoLoad: !0,
                            pageSize: 1e3,
                            limit: "Infinity",
                            fetch: fetch,
                            hydrate: hydrate,
                            listeners: {
                                scope: this,
                                load: function(store, snapshots, success) {
                                    callback(null, snapshots)
                                }
                            }
                        },
                        snapshotStore = Ext.create("Rally.data.lookback.SnapshotStore", storeConfig)
                },
                getDependencySnapshots: function(record, callback) {
                    var that = this,
                        fetch = ["ObjectID", "Estimate", "ToDo", "Actuals", "_ItemHierarchy", "_TypeHierarchy", "Predecessors", "Successors", "Name", "FormattedID", "ScheduleState", "PlanEstimate", "Project", "Iteration", "Workspace"],
                        hydrate = ["_TypeHierarchy", "ScheduleState"],
                        find = {
                            _TypeHierarchy: {
                                $in: ["HierarchicalRequirement"]
                            },
                            _ProjectHierarchy: {
                                $in: [app.getContext().getProject().ObjectID]
                            },
                            __At: "current",
                            _ItemHierarchy: {
                                $in: [record.get("ObjectID")]
                            },
                            Predecessors: {
                                $exists: !0
                            }
                        },
                        storeConfig = {
                            find: find,
                            autoLoad: !0,
                            pageSize: 1e3,
                            limit: "Infinity",
                            fetch: fetch,
                            hydrate: hydrate,
                            listeners: {
                                scope: this,
                                load: function(store, snapshots, success) {
                                    callback(null, snapshots)
                                }
                            }
                        },
                        snapshotStore = Ext.create("Rally.data.lookback.SnapshotStore", storeConfig)
                },
                timeEntryItems: function(refs, callback) {
                    var configs = [{
                        model: "TypeDefinition",
                        fetch: !0,
                        filters: app.createTimeEntryFilter(refs)
                    }];
                    async.map(configs, app.wsapiQuery, function(err, results) {
                        callback(null, results)
                    })
                },
                createTimeEntryFilter: function(refs) {
                    var filter = null;
                    return _.each(refs, function(ref, i) {
                        var filterFieldName = -1 === ref.toLowerCase().indexOf("task") ? "WorkProduct" : "Task",
                            f = Ext.create("Rally.data.wsapi.Filter", {
                                property: filterFieldName,
                                operator: "=",
                                value: ref
                            });
                        filter = 0 === i ? f : filter.or(f)
                    }), filter
                },
                wsapiQuery: function(config, callback) {
                    Ext.create("Rally.data.WsapiDataStore", {
                        context: config.context,
                        autoLoad: !0,
                        limit: "Infinity",
                        model: config.model,
                        fetch: config.fetch,
                        filters: config.filters,
                        listeners: {
                            scope: this,
                            load: function(store, data) {
                                callback(null, data)
                            }
                        }
                    })
                }
            });

            Rally.launchApp('CustomApp', {
                name: "featuredefectsummary",
                parentRepos: ""
            });

        });

    </script>


    <style type="text/css">
        body {
            font-family: Arial, Verdana, sans-serif;
            color: #111111
        }

        table.financial {
            width: 500px
        }

        .financial th,
        .financial td {
            border: 1px solid #c6c6c6;
            padding: 3px 5px 5px 5px
        }

        .financial th {
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-size: 90%;
            border-bottom: 2px solid #111111;
            border-top: 1px solid #999;
            text-align: left
        }

        .financial tr.even {
            background-color: #efefef
        }

        .financial tr:hover {
            background-color: #c3e6e5
        }

        .financial tfoot td {
            border-top: 2px solid #111111;
            border-bottom: 1px solid #999
        }

        .money {
            text-align: right
        }

        .state-legend {
            background: #006600 none repeat scroll 0%;
            margin-right: 10px;
            border: 1px solid #DDDDDD;
            color: #FFFFFF;
            cursor: default;
            float: left;
            height: 14px;
            line-height: 14px;
            margin-right: 1px;
            text-align: center;
            width: 14px
        }

        .state-legend-blocked {
            background: transparent url(https://rally1.rallydev.com/slm/images/icon_blocked.gif) no-repeat scroll 0;
            margin-right: 10px;
            color: #FFFFFF;
            cursor: default;
            display: inline;
            float: left;
            height: 16px;
            line-height: 16px;
            margin-right: 1px;
            text-align: center;
            width: 16px
        }

        .iteration-none {
            background-color: #ECF6CE
        }

        .iteration-late {
            color: white;
            background-color: #FF0000
        }

        .iteration-good {
            background-color: #3ADF00
        }

    </style>
</head>

<body>
</body>

</html>

<!DOCTYPE html>
<html>

<head>
    <title>Filtered Cycle Time</title>
    <!--  (c) 2014 Rally Software Development Corp.  All Rights Reserved. -->
    <!--  Build Date: Wed Jun 08 2016 12:30:59 GMT-0400 (EDT) -->

    <script type="text/javascript">
        var APP_BUILD_DATE = "Wed Jun 08 2016 12:30:59 GMT-0400 (EDT)";
        var CHECKSUM = 123445556743;
    </script>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {

            /**
             * A link that pops up a version dialog box
             */

            Ext.define('Rally.technicalservices.InfoLink', {
                extend: 'Ext.Component',
                alias: 'widget.tsinfolink',

                /**
                 * @cfg {String} informationHtml
                 * Additional text to be displayed on the popup dialog (for exmaple,
                 * to add a description of the app's use or functionality)
                 */
                informationHtml: null,

                /**
                 * 
                 * cfg {String} title
                 * The title for the dialog box
                 */
                title: "Build Information",

                renderTpl: "<div id='{id}-infolinkWrap' class='tsinfolink'>i</div>",

                initComponent: function () {
                    this.callParent(arguments);

                },

                onRender: function () {
                    this.callParent(arguments);
                    this.mon(this.el, 'click', this.onClick, this);
                },
                _generateChecksum: function (string) {
                    var chk = 0x12345678,
                        i;
                    string = string.replace(/var CHECKSUM = .*;/, "");
                    string = string.replace(/\s/g, ""); //Remove all whitespace from the string.

                    for (i = 0; i < string.length; i++) {
                        chk += (string.charCodeAt(i) * i);
                    }

                    return chk;
                },
                _checkChecksum: function (container) {
                    var me = this;
                    Ext.Ajax.request({
                        url: document.URL,
                        params: {
                            id: 1
                        },
                        success: function (response) {
                            text = response.responseText;
                            if (CHECKSUM) {
                                if (CHECKSUM !== me._generateChecksum(text)) {
                                    console.log("Checksums don't match!");
                                    if (me.dialog) {
                                        me.dialog.add({
                                            xtype: 'container',
                                            html: 'Checksums do not match'
                                        });
                                    }
                                }
                            }
                        }
                    });
                },
                onClick: function (e) {
                    var me = this;
                    this._checkChecksum(this);

                    var dialog_items = [];

                    if (this.informationHtml) {
                        dialog_items.push({
                            xtype: 'container',
                            html: this.informationHtml
                        });
                    }

                    dialog_items.push({
                        xtype: 'container',
                        html: "This app was created by the Rally Technical Services Team."
                    });

                    if (APP_BUILD_DATE) {
                        dialog_items.push({
                            xtype: 'container',
                            html: 'Build date/time: ' + APP_BUILD_DATE
                        });
                    }

                    if (this.dialog) {
                        this.dialog.destroy();
                    }
                    this.dialog = Ext.create('Rally.ui.dialog.Dialog', {
                        defaults: {
                            padding: 5,
                            margin: 5
                        },
                        closable: true,
                        draggable: true,
                        title: me.title,
                        items: dialog_items
                    });
                    this.dialog.show();
                }
            });

            /*
             */
            Ext.define('Rally.technicalservices.Logger', {
                constructor: function (config) {
                    Ext.apply(this, config);
                },
                log: function (args) {
                    var timestamp = "[ " + Ext.util.Format.date(new Date(), "Y-m-d H:i:s.u") + " ]";
                    //var output_args = arguments;
                    //output_args.unshift( [ "[ " + timestamp + " ]" ] );
                    //output_args = Ext.Array.push(output_args,arguments);

                    var output_args = [];
                    output_args = Ext.Array.push(output_args, [timestamp]);
                    output_args = Ext.Array.push(output_args, Ext.Array.slice(arguments, 0));

                    window.console && console.log.apply(console, output_args);
                }

            });

            Ext.define('CycleCalculator', {
                //    extend: "Rally.data.lookback.calculator.BaseCalculator",
                logger: new Rally.technicalservices.Logger(),
                config: {
                    cycleField: 'ScheduleState',
                    cycleStartValue: 'Defined',
                    cycleEndValue: 'Accepted',
                    cyclePrecedence: [],
                    cycleNames: {},
                    startDate: null,
                    endDate: null,
                    granularity: "month",
                    dateFormat: "M yyyy",
                    dataFilters: [],
                    modelNames: [],
                    color: {
                        Defect: 'red',
                        HierarchicalRequirement: 'green',
                        Combined: 'blue',
                        PortfolioItem: 'blue'
                    },
                    excludeWeekends: false
                },
                cycleTimeData: null,
                snapsByOid: {},
                constructor: function (config) {
                    this.mergeConfig(config);
                },
                runCalculation: function (snapshots) {
                    var snaps_by_oid = Rally.technicalservices.Toolbox.aggregateSnapsByOid(
                        snapshots);
                    var date_buckets = Rally.technicalservices.Toolbox.getDateBuckets(this.startDate,
                        this.endDate, this.granularity);

                    var cycle_time_data = [];

                    Ext.Object.each(snaps_by_oid, function (oid, snaps) {
                        var ctd = this._getCycleTimeData(snaps, this.cycleField, this.cycleStartValue,
                            this.cycleEndValue, this.cyclePrecedence);
                        if (ctd.include) {
                            cycle_time_data.push(ctd);
                        }
                    }, this);


                    var series = [];

                    if (this.modelNames.length > 1) {
                        series.push(this._getSeries(cycle_time_data, date_buckets, this.granularity,
                            undefined));
                    }

                    Ext.Array.each(this.modelNames, function (type) {
                        series.push(this._getSeries(cycle_time_data, date_buckets, this.granularity,
                            type));
                    }, this);

                    Ext.Array.each(this.modelNames, function (type) {
                        series.push(this._getTrendline(this._getSeries(cycle_time_data,
                            date_buckets, this.granularity, type)));
                    }, this);

                    Ext.Array.each(this.modelNames, function (type) {
                        series.push(this._getPercentileLine(cycle_time_data, date_buckets,
                            this.granularity, type));
                    }, this);

                    categories = Rally.technicalservices.Toolbox.formatDateBuckets(date_buckets,
                        this.dateFormat);

                    var cycleTimeDataExport = [];
                    Ext.each(cycle_time_data, function (ctd) {
                        ctd.startDate = Rally.util.DateTime.fromIsoString(ctd.startDate);
                        ctd.endDate = Rally.util.DateTime.fromIsoString(ctd.endDate);
                        if (ctd.endDate > date_buckets[0]) { //Only export data that is within the requested time frame
                            cycleTimeDataExport.push(ctd);
                        }
                    });
                    this.cycleTimeDataExport = cycleTimeDataExport;


                    return {
                        series: series,
                        categories: categories
                    }
                },
                _getPercentileLine: function (cycletimedata, date_buckets, granularity, type) {
                    var series_raw_data = [];
                    var series_data = [];
                    var tooltip_data = [];

                    for (var i = 0; i < date_buckets.length; i++) {
                        series_raw_data[i] = [];
                        tooltip_data[i] = 0;
                        series_data[i] = {
                            y: null,
                            n: 0
                        };
                    }

                    Ext.each(cycletimedata, function (cdata) {
                        for (var i = 0; i < date_buckets.length; i++) {
                            if ((type == undefined || type == cdata.artifactType) && cdata.endDate >=
                                date_buckets[i] && cdata.endDate < Rally.util.DateTime.add(
                                    date_buckets[i], granularity, 1)) {
                                series_raw_data[i].push(cdata.days)
                            }
                        }
                    });

                    var series_data = _.range(date_buckets.length).map(function () {
                        return {
                            y: null,
                            n: 0
                        }
                    })
                    for (var i = 0; i < series_raw_data.length; i++) {
                        var pValue = Rally.technicalservices.Toolbox.calculatePercentileValue(this.percentileLineThreshold,
                            series_raw_data[i]);
                        this.logger.log('Calculate Percentile (len, value)', type, series_raw_data[
                            i].length, pValue);
                        if (pValue) {
                            series_data[i].y = pValue;
                            series_data[i].n = '(' + series_raw_data[i].length + ' Artifacts)';
                        }
                    }

                    return {
                        name: Ext.String.format("{0}% for {1}", this.percentileLineThreshold, this._getSeriesName(
                            type)),
                        color: this._getColorForSeries(type),
                        data: series_data,
                        display: 'line',
                        dashStyle: 'Dot'
                    };
                },
                _getTrendline: function (series) {
                    /**
                     * Regression Equation(y) = a + bx  
                     * Slope(b) = (NΣXY - (ΣX)(ΣY)) / (NΣX2 - (ΣX)2) 
                     * Intercept(a) = (ΣY - b(ΣX)) / N
                     */

                    var sum_xy = 0;
                    var sum_x = 0;
                    var sum_y = 0;
                    var sum_x_squared = 0;
                    var n = 0;
                    for (var i = 0; i < series.data.length; i++) {
                        if (series.data[i].y) {
                            sum_xy += series.data[i].y * i;
                            sum_x += i;
                            sum_y += series.data[i].y;
                            sum_x_squared += i * i;
                            n++;
                        }
                    }
                    var slope = (n * sum_xy - sum_x * sum_y) / (n * sum_x_squared - sum_x * sum_x);
                    var intercept = (sum_y - slope * sum_x) / n;

                    this.logger.log('trendline data (name, slope, intercept)', series.name, slope,
                        intercept);

                    var y = [];
                    if (!isNaN(slope) && !isNaN(intercept)) {
                        y = _.range(series.data.length).map(function () {
                            return null
                        })
                        for (var i = 0; i < series.data.length; i++) {
                            y[i] = intercept + slope * i;
                        }
                    }
                    this.logger.log('_getTrendline', y);
                    return {
                        name: series.name + ' Trendline',
                        color: series.color,
                        data: y,
                        display: 'line',
                        dashStyle: 'LongDash'
                    };

                },
                _getCycleTimeData: function (snaps, field, startValue, endValue, precedence) {
                    var start_index = -1;
                    if (!Ext.isEmpty(startValue)) { //This is in case there is no start value (which means grab the first snapshot)
                        var start_index = _.indexOf(precedence, startValue);
                    }
                    var end_index = _.indexOf(precedence, endValue);

                    var include = false;

                    //Assumes snaps are stored in ascending date order.  
                    var start_date = null,
                        end_date = null,
                        between_states = false,
                        days = null;
                    var type = snaps[0]._TypeHierarchy.slice(-1)[0];

                    var previous_state_index = -1;
                    var state_index = -1;
                    var seconds = null;
                    var days = null;
                    var include = false;

                    if (start_index == -1) {
                        start_date = Rally.util.DateTime.fromIsoString(snaps[0]._ValidFrom);
                    }

                    Ext.each(snaps, function (snap) {
                        if (snap[field]) {
                            previous_state_index = state_index;
                            state_index = _.indexOf(precedence, snap[field]);
                        } else {
                            if (previous_state_index > 0) {
                                //the field was cleared out
                                state_index = -1;
                            }
                        }
                        if (state_index >= start_index && previous_state_index <
                            start_index && start_index > -1) {
                            start_date = Rally.util.DateTime.fromIsoString(snap._ValidFrom);
                        }
                        if (state_index >= end_index && previous_state_index < end_index) {
                            end_date = Rally.util.DateTime.fromIsoString(snap._ValidFrom);

                            console.log('fred', start_date, end_date, snap.FormattedID,
                                include, days);

                            if (start_date != null) {
                                seconds = Rally.util.DateTime.getDifference(end_date,
                                    start_date, "second");
                                if (this.excludeWeekends) {
                                    days = Math.floor(seconds / 86400) + 1;
                                } else {
                                    days = Rally.technicalservices.util.Utilities.daysBetween(
                                        start_date, end_date, this.excludeWeekends);
                                }
                            }
                            include = this._snapMeetsFilterCriteria(snap);
                        }
                        console.log('start', start_date, end_date, snap.FormattedID,
                            include, days);

                    }, this);

                    return {
                        formattedId: snaps[0].FormattedID,
                        seconds: seconds,
                        days: days,
                        endDate: end_date,
                        startDate: start_date,
                        artifactType: type,
                        include: include
                    };
                },
                _snapMeetsFilterCriteria: function (snap) {
                    var is_filtered = true;
                    this.logger.log('_snapMeetsFilterCriteria', snap);
                    Ext.each(this.dataFilters, function (filter) {
                        var str_format = "{0} {1} {2}";
                        if (isNaN(snap[filter.property]) && isNaN(filter.value)) {
                            str_format = "\"{0}\" {1} \"{2}\"";
                        }
                        var operator = filter.operator;
                        if (operator == "=") {
                            operator = "==";
                        }

                        var val = filter.value || '';
                        if (val.length == 0 || snap[filter.property].length == 0) {
                            is_filtered = (val.length == 0 && snap[filter.property].length ==
                                0);
                            this.logger.log(
                                '_snapMeetsFilterCriteria filter property or value is blank',
                                filter.property, snap[filter.property], is_filtered);
                        } else {
                            var str_eval = Ext.String.format(str_format, snap[filter.property],
                                operator, val);
                            is_filtered = eval(str_eval);
                            this.logger.log('_snapMeetsFilterCriteria eval', filter,
                                str_eval, is_filtered);
                        }
                        return is_filtered; //if filtered is false, then we want to stop looping.  
                    }, this);

                    return is_filtered;
                },

                _getColorForSeries: function (type) {
                    var color = 'black';
                    if (this.color[type]) {
                        color = this.color[type];
                    }
                    if (/PortfolioItem/.test(type)) {
                        color = this.color.PortfolioItem;
                    }

                    return color;
                },
                _getSeries: function (cycle_time_data, date_buckets, granularity, type) {
                    var series_raw_data = [];
                    var series_data = [];
                    var tooltip_data = [];
                    for (var i = 0; i < date_buckets.length; i++) {
                        series_raw_data[i] = [];
                        tooltip_data[i] = 0;
                        series_data[i] = {
                            y: null,
                            n: 0
                        };
                    }

                    Ext.each(cycle_time_data, function (cdata) {
                        for (var i = 0; i < date_buckets.length; i++) {
                            if ((type == undefined || type == cdata.artifactType) && cdata.endDate >=
                                date_buckets[i] && cdata.endDate < Rally.util.DateTime.add(
                                    date_buckets[i], granularity, 1)) {
                                series_raw_data[i].push(cdata.days)
                            }
                        }
                    });

                    var validDataPoints = 0;
                    var series_data = _.range(date_buckets.length).map(function () {
                        return {
                            y: null,
                            n: 0
                        }
                    })
                    for (var i = 0; i < series_raw_data.length; i++) {
                        if (series_raw_data[i].length > 0) {
                            series_data[i].y = Ext.Array.mean(series_raw_data[i]);
                            series_data[i].n = '(' + series_raw_data[i].length + ' Artifacts)';
                        }
                    }

                    return {
                        name: this._getSeriesName(type),
                        color: this._getColorForSeries(type),
                        data: series_data
                    };
                },
                _getSeriesName: function (type) {
                    var type_text = "Combined";
                    if (type) {
                        type_text = type;
                        if (type == 'HierarchicalRequirement') {
                            type_text = "User Story";
                        }
                    }
                    return Ext.String.format(type_text);
                }
            });
            Ext.define('Rally.technicalservices.FileUtilities', {
                singleton: true,
                logger: new Rally.technicalservices.Logger(),

                saveTextAsFile: function (textToWrite, fileName) {
                    var textFileAsBlob = new Blob([textToWrite], {
                        type: 'text/plain'
                    });
                    var fileNameToSaveAs = fileName;

                    var downloadLink = document.createElement("a");
                    downloadLink.download = fileNameToSaveAs;
                    downloadLink.innerHTML = "Download File";
                    if (window.webkitURL != null) {
                        // Chrome allows the link to be clicked
                        // without actually adding it to the DOM.
                        downloadLink.href = window.webkitURL.createObjectURL(textFileAsBlob);
                    } else {
                        // Firefox requires the link to be added to the DOM
                        // before it can be clicked.
                        downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
                        downloadLink.onclick = this.destroyClickedElement;
                        downloadLink.style.display = "none";
                        document.body.appendChild(downloadLink);
                    }
                    downloadLink.click();
                },
                destroyClickedElement: function (event) {
                    document.body.removeChild(event.target);
                },
                convertDataArrayToCSVText: function (data_array, requestedFieldHash) {

                    var text = '';
                    Ext.each(Object.keys(requestedFieldHash), function (key) {
                        text += requestedFieldHash[key] + ',';
                    });
                    text = text.replace(/,$/, '\n');

                    Ext.each(data_array, function (d) {
                        Ext.each(Object.keys(requestedFieldHash), function (key) {
                            if (d[key]) {
                                if (typeof d[key] === 'object') {
                                    if (d[key].FormattedID) {
                                        text += Ext.String.format("\"{0}\",", d[key]
                                            .FormattedID);
                                    } else if (d[key].Name) {
                                        text += Ext.String.format("\"{0}\",", d[key]
                                            .Name);
                                    } else if (!isNaN(Date.parse(d[key]))) {
                                        text += Ext.String.format("\"{0}\",", Rally
                                            .util.DateTime.formatWithDefaultDateTime(
                                                d[key]));
                                    } else {
                                        text += Ext.String.format("\"{0}\",", d[key]
                                            .toString());
                                    }
                                } else {
                                    text += Ext.String.format("\"{0}\",", d[key]);
                                }
                            } else {
                                text += ',';
                            }
                        }, this);
                        text = text.replace(/,$/, '\n');
                    }, this);
                    return text;
                }
            });
            Ext.define('Rally.technicalservices.dialog.Filter', {
                extend: Rally.ui.dialog.Dialog,
                logger: new Rally.technicalservices.Logger(),
                autoShow: true,
                componentCls: "rly-popover dark-container",
                validFields: [],
                app: null,
                initComponent: function () {
                    this.items = this._getItems();
                    this.buttons = this._getButtonConfig();
                    this.callParent(arguments);
                    this._initializeFilters(this.filters);
                    this.addEvents(
                        'customFilter'
                    );
                },
                _initializeFilters: function (filters) {
                    this.logger.log('_initializeFilters', filters);

                    if (filters && filters.length > 0) {
                        Ext.each(filters, function (filter) {
                            this._addNewRow(filter.property, filter.operator, filter.value);
                        }, this);
                    } else {
                        this._addNewRow();
                    }
                },
                _getFieldStore: function () {
                    var fields = [];
                    Ext.each(this.validFields, function (field) {
                        fields.push({
                            name: field.name,
                            displayName: field.displayName,
                            attributeType: field.attributeDefinition.AttributeType,
                            schemaType: field.attributeDefinition.SchemaType,
                            modelType: field.modelType,
                            isConstrained: field.attributeDefinition.Constrained
                        });
                    }, this);

                    return Ext.create('Rally.data.custom.Store', {
                        data: fields
                    });
                },
                _addNewRow: function (property, operator, value) {
                    this.logger.log('_addNewRow', property, operator, value);

                    var field_store = this._getFieldStore();
                    var items = [];
                    items.push({
                        xtype: "rallybutton",
                        itemId: 'btn-remove',
                        text: '-',
                        scope: this,
                        margin: 5,
                        handler: function (btn) {
                            btn.bubble(this._removeRow, this);
                        }
                    });

                    items.push({
                        xtype: "rallycombobox",
                        itemId: 'cb-filter-field',
                        store: field_store,
                        displayField: 'displayName',
                        valueField: 'name',
                        listeners: {
                            scope: this,
                            select: function (cb) {
                                this._updateFilterCombos(cb, operator, value);
                            },
                            ready: function (cb) {
                                if (property) {
                                    cb.setValue(property);
                                    this._updateFilterCombos(cb, operator, value);
                                }
                            }
                        },
                        allowNoEntry: true,
                        noEntryText: 'Choose Field...',
                        noEntryValue: null,
                        margin: 5,
                        value: null
                    });

                    var row = Ext.create('Ext.Container', {
                        layout: {
                            type: 'hbox'
                        },
                        items: items

                    });
                    this.down('#ct-rows').add(row);
                    this._validateFilters();
                },
                _updateFilterCombos: function (cb, operator, value) {
                    var parent_ct = cb.up(null, 1);
                    var rec = cb.getRecord();

                    this.logger.log('_updateFilterCombos', cb.itemId, rec, operator, value);

                    if (parent_ct) {
                        if (parent_ct.down('#cb-filter-operator')) {
                            parent_ct.down('#cb-filter-operator').destroy();
                            parent_ct.down('#cb-filter-value').destroy();
                        }

                        var op_val = operator || '=';
                        var operator_ctl = this._getOperatorControl(rec, op_val,
                            'cb-filter-operator');
                        parent_ct.add(operator_ctl);

                        var value_val = value || null;
                        var value_ctl = this._getValueControl(rec, value_val, 'cb-filter-value');
                        parent_ct.add(value_ctl);

                    }
                },

                _removeRow: function (btn) {
                    var ct = btn.up(null, 1);
                    if (ct) {
                        ct.destroy();
                    }
                    this._validateFilters();
                },
                _getButtonConfig: function () {
                    return [{
                        xtype: "rallybutton",
                        itemId: "cancelButton",
                        cls: "secondary rly-small",
                        text: "Cancel",
                        width: 90,
                        handler: this._onCancelClick,
                        scope: this
                    }, {
                        xtype: "rallybutton",
                        itemId: "applyButton",
                        cls: "primary rly-small",
                        text: "Apply",
                        width: 90,
                        handler: this._onApplyClick,
                        scope: this,
                        disabled: true
                    }]
                },
                _onClearAll: function () {
                    this.down('#ct-rows').removeAll();
                    this._addNewRow();
                },
                _onCancelClick: function () {
                    this.destroy()
                },
                _validateFilters: function (ct) {
                    var disabled = false;
                    var add_disabled = false;

                    var rows = this.down('#ct-rows').items.items;
                    if (rows.length == 0) {
                        disabled = true;
                    }

                    Ext.each(this.down('#ct-rows').items.items, function (item) {
                        item.down('#btn-remove').setDisabled(rows.length == 1);

                        var property = null;
                        if (item.down('#cb-filter-field')) {
                            property = item.down('#cb-filter-field').getValue();
                        }
                        var operator = null;
                        if (item.down('#cb-filter-operator')) {
                            operator = item.down('#cb-filter-operator').getValue();
                        }

                        if (property == null || operator == null || property.length == 0 ||
                            operator.length == 0) {
                            disabled = true, add_disabled = true;
                        }

                        var val = null;
                        if (item.down('#cb-filter-value')) {
                            val = item.down('#cb-filter-value').getValue()
                            if (item.down('#cb-filter-value').xtype == 'rallynumberfield') {
                                if (val == null || val.toString.length == 0) {
                                    disabled = true, add_disabled = true;
                                }
                            }
                        };
                        if (rows.length == 1 && property == null && operator == null && val ==
                            null) {
                            disabled = false; //clear filters 
                        }
                    }, this);
                    this.logger.log('_validateFilters', disabled);
                    this.down('#applyButton').setDisabled(disabled);
                    this.down('#btn-add').setDisabled(add_disabled);
                },
                /* 
                 * In some cases, we want to strip the value returned or make it look
                 * different somehow.  (E.g., we want the preliminary estimate to just show the ID
                 */
                _cleanValue: function (val) {
                    if (/\/preliminaryestimate\//.test(val)) {
                        val = val.replace(/\/preliminaryestimate\//, "");
                        val = parseInt(val, 10);
                    }
                    if (/\/state\//.test(val)) {
                        val = val.replace(/\/state\//, "")
                        val = parseInt(val, 10);
                    }


                    return val;
                },
                _onApplyClick: function () {
                    var filters = [];
                    Ext.each(this.down('#ct-rows').items.items, function (item) {
                        if (this.down('#cb-filter-operator')) {
                            var property = item.down('#cb-filter-field').getValue();
                            var operator = item.down('#cb-filter-operator').getValue();
                            var val = this._cleanValue(item.down('#cb-filter-value').getValue());
                            var display_property = item.down('#cb-filter-field').getRecord()
                                .get('displayName');
                            var display_value = item.down('#cb-filter-value').displayValue ||
                                val;

                            console.log("DISPLAY:", display_value);
                            if (property && operator) {
                                filters.push({
                                    property: property,
                                    operator: operator,
                                    value: val,
                                    displayProperty: display_property,
                                    displayValue: display_value
                                });
                            }
                        }
                    }, this);

                    this.fireEvent("customfilter", filters);
                    this.destroy()
                },
                _getItems: function () {
                    return [{
                        xtype: "container",
                        cls: "custom-filter-header",
                        layout: {
                            type: 'hbox'
                        },
                        defaults: {
                            xtype: "component",
                            cls: "filter-panel-label"
                        },
                        items: [{
                            height: 1,
                            width: 30
                        }, {
                            html: "Field",
                            width: 155
                        }, {
                            html: "Operator",
                            width: 80
                        }, {
                            html: "Value",
                            width: 155
                        }]
                    }, {
                        xtype: "container",
                        itemId: "ct-rows",
                        layout: {
                            type: 'vbox'
                        }
                    }, {
                        xtype: "container",
                        itemId: 'ct-footer',
                        items: [{
                            xtype: 'rallybutton',
                            itemId: 'clearButton',
                            cls: "secondary rly-small",
                            text: 'Clear All',
                            width: 90,
                            align: 'right',
                            margin: '5 5 5 220',
                            scope: this,
                            handler: this._onClearAll
                        }, {
                            xtype: 'rallybutton',
                            itemId: 'btn-add',
                            text: 'Add New',
                            width: 90,
                            cls: "primary rly-small",
                            align: 'right',

                            margin: 5,
                            scope: this,
                            handler: this._addNewRow
                        }]
                    }]
                },
                _getOperatorControl: function (field, operatorValue, itemId) {
                    this.logger.log('_getOperatorControl', field, operatorValue);
                    var operators = ['='];
                    var operator_value = operatorValue || '=';
                    //We should be able to get these back from the field, but its not consistent
                    //so we are going to cheat and hardcode them
                    if (!field.get('isConstrained')) {
                        switch (field.get('attributeType')) {
                            case 'STRING':
                            case 'TEXT':
                                operators = ['=', 'contains'];
                                break;
                            case 'DECIMAL':
                            case 'INTEGER':
                            case 'QUANTITY':
                                operators = ['=', '<=', '>=', '<', '>'];
                                break;
                            case 'DATE':
                                operators = ['on', 'before', 'after'];
                        }
                    }

                    var op_ctl = {
                        xtype: "rallycombobox",
                        itemId: itemId,
                        store: operators,
                        margin: 5,
                        width: 80,
                        allowNoEntry: false,
                        noEntryText: '',
                        listeners: {
                            scope: this,
                            change: this._validateFilters,
                            ready: function (cb) {
                                cb.setValue(operator_value);
                            }
                        }
                    };
                    return op_ctl;
                },
                _getValueControl: function (field, value, item_id) {
                    this.logger.log('_getValueControl', field)

                    var ctl = {
                        xtype: 'rallytextfield'
                    };
                    var type = field.get('attributeType');
                    var hasAllowedValues = ((type == 'STATE') || (type == 'RATING') || field.get(
                        'isConstrained'));
                    var schema = field.get('schemaType');
                    var field_name = field.get('name');
                    var model_type = field.get('modelType');

                    var app = this.app;

                    switch (type) {
                        case 'BOOLEAN':
                            ctl = {
                                xtype: 'rallycombobox',
                                allowNoEntry: false,
                                store: ['true', 'false']
                            };
                            break;
                        case 'DATE':
                            ctl = {
                                xtype: 'rallydatefield',
                                allowNoEntry: false
                            };
                            break;
                        case 'TEXT':
                        case 'STRING':
                        case 'STATE':
                        case 'RATING':
                            if (hasAllowedValues) {
                                ctl = {
                                    xtype: 'rallyfieldvaluecombobox',
                                    model: model_type,
                                    field: field_name,
                                    allowNoEntry: false
                                };
                            }
                            break;
                        case 'OBJECT':
                            //Release, Iteration, User, Project, artifact links
                            if (schema == 'Iteration') {
                                ctl = {
                                    xtype: 'rallyiterationcombobox',
                                    allowNoEntry: false
                                };
                            } else if (schema == 'Release') {
                                ctl = {
                                    xtype: 'rallyreleasecombobox',
                                    allowNoEntry: false
                                };
                            } else if (schema == 'User') {
                                ctl = {
                                    xtype: 'rallyusersearchcombobox',
                                    project: app.getContext().getProject(),
                                    allowNoEntry: false,
                                    valueField: 'ObjectID'
                                };
                            } else if (schema == 'Project') {
                                ctl = {
                                    xtype: 'rallyprojectpicker',
                                    allowNoEntry: false
                                };

                            } else if ((schema == 'State') || (schema == 'PreliminaryEstimate')) {
                                ctl = {
                                    xtype: 'rallyfieldvaluecombobox',
                                    prefix: Ext.util.Format.lowercase(schema),
                                    model: model_type,
                                    field: field_name,
                                    allowNoEntry: false
                                };
                            }
                            break;
                        case 'DECIMAL':
                        case 'INTEGER':
                        case 'QUANTITY':
                            ctl = {
                                xtype: 'rallynumberfield',
                                allowBlank: false
                            }
                    }
                    _.extend(ctl, {
                        itemId: item_id,
                        margin: 5,
                        listeners: {
                            scope: this,
                            change: function (cb) {
                                if (cb.xtype == "rallyfieldvaluecombobox") {
                                    cb.displayValue = cb.getRecord().get("name");
                                }

                                if (cb.xtype == "rallyusersearchcombobox") {
                                    cb.displayValue = cb.getRecord().get(
                                        "_refObjectName");
                                }
                                this._validateFilters();
                            },
                            ready: function (cb) {
                                if (value) {
                                    cb.setValue(value);
                                }
                            },
                            render: function (cb) {
                                if (value) {
                                    if (cb.xtype == "rallyusersearchcombobox") {
                                        value = "/user/" + value;
                                    }
                                    if (cb.prefix && value > 0) {
                                        value = "/" + cb.prefix + "/" + value;
                                    }

                                    cb.setValue(value);
                                }
                            }
                        }
                    });
                    return ctl;
                }
            });
            Ext.override(Rally.ui.picker.FieldPicker, {
                _shouldShowField: function (field) {
                    var allowed_attribute_types = ['STATE', 'STRING'];
                    if (field.attributeDefinition) {
                        var attr_def = field.attributeDefinition;
                        //console.log(attr_def.ElementName, attr_def.AttributeType, attr_def);

                        var can_use = false;
                        if (attr_def.ElementName == "State") {
                            can_use = true;
                        }

                        if (attr_def.Constrained && Ext.Array.contains(allowed_attribute_types,
                                attr_def.AttributeType) && attr_def.ReadOnly == false) {
                            can_use = true;
                        }

                        var forbidden_fields = ['c_ProjectManager', 'c_ImpactScore'];

                        if (Ext.Array.contains(forbidden_fields, attr_def.ElementName)) {
                            can_use = false;
                        }


                        return can_use
                    }
                    return false;
                }
            });

            Ext.override(Ext.data.proxy.Server, {
                timeout: 60000,
                processResponse: function (success, operation, request, response, callback, scope) {
                    var me = this,
                        reader,
                        result;

                    if (success === true) {
                        reader = me.getReader();
                        reader.applyDefaults = operation.action === 'read';
                        result = reader.read(me.extractResponseData(response));

                        if (result.success !== false) {

                            Ext.apply(operation, {
                                response: response,
                                resultSet: result
                            });

                            operation.commitRecords(result.records);
                            operation.setCompleted();
                            operation.setSuccessful();
                        } else {
                            operation.setException(result.message);
                            me.fireEvent('exception', this, response, operation);
                        }
                    } else {
                        if (response) {
                            me.setException(operation, response);
                        }
                        me.fireEvent('exception', this, response, operation);
                    }


                    if (typeof callback == 'function') {
                        callback.call(scope || me, operation);
                    }

                    me.afterRequest(request, success);
                },


                setException: function (operation, response) {
                    operation.setException({
                        status: response.status,
                        statusText: response.statusText
                    });
                },


                extractResponseData: Ext.identityFn,


                applyEncoding: function (value) {
                    return Ext.encode(value);
                }
            });

            Ext.define('Rally.technicalservices.Toolbox', {
                singleton: true,
                /**
                 * Returns beginnig of month as date for the current time zone
                 * 
                 */
                calculatePercentileValue: function (percentileThreshold, arrayValues) {

                    if (arrayValues && arrayValues.length > 0) {

                        arrayValues.sort(function (a, b) {
                            return a - b
                        });

                        var rank = percentileThreshold / 100 * (arrayValues.length - 1) + 1,
                            k = Math.floor(rank),
                            d = rank - k,
                            pValue = 0;

                        console.log('percentile calcs (len, rank, idx, decimal, value', arrayValues
                            .length, rank, k, d, pValue);

                        if (k == 0 || arrayValues.length == 1) {
                            pValue = arrayValues[0];
                        } else if (k == arrayValues.length) { //this.shouldn't happen if percentile can't be greater than 100
                            pValue = arrayValues[arrayValues.length - 1];
                        } else {
                            pValue = arrayValues[k - 1] + d * (arrayValues[k] - arrayValues[k - 1]);
                        }
                        console.log('percentile calcs (len, rank, idx, decimal, value', arrayValues
                            .length, rank, k, d, pValue);
                        return pValue;
                        return Ext.String.format(
                            "rank={0}, k={1}, d={2}, pValue={3}, arrayValues = {4}", rank, k, d,
                            pValue, arrayValues);

                        //    var pIdx = arrayValues.length * percentileThreshold/ 100 - 1,
                        //        roundedIdx = Math.ceil(pIdx),
                        //        pValue = 0;
                        //
                        //    if (roundedIdx == pIdx && roundedIdx != (arrayValues.length-1)){
                        //        pValue = (arrayValues[roundedIdx] + arrayValues[roundedIdx + 1])/2
                        //    } else {
                        //        pValue = arrayValues[roundedIdx];
                        //    }
                        //    console.log('percentile calcs (len, idx, rounded idx, value, array', arrayValues.length, pIdx, roundedIdx, pValue,arrayValues);
                        //    return pValue;
                    }
                    return null;
                },
                getBeginningOfMonthAsDate: function (dateInMonth) {
                    var year = dateInMonth.getFullYear();
                    var month = dateInMonth.getMonth();
                    return new Date(year, month, 1, 0, 0, 0, 0);
                },
                getEndOfMonthAsDate: function (dateInMonth) {
                    var year = dateInMonth.getFullYear();
                    var month = dateInMonth.getMonth();
                    var day = new Date(year, month + 1, 0).getDate();
                    return new Date(year, month, day, 0, 0, 0, 0);
                },
                aggregateSnapsByOid: function (snaps) {
                    //Return a hash of objects (key=ObjectID) with all snapshots for the object
                    var snaps_by_oid = {};
                    Ext.each(snaps, function (snap) {
                        var oid = snap.ObjectID || snap.get('ObjectID');
                        if (snaps_by_oid[oid] == undefined) {
                            snaps_by_oid[oid] = [];
                        }
                        snaps_by_oid[oid].push(snap);

                    });
                    return snaps_by_oid;
                },
                getCaseInsensitiveKey: function (obj, inputStr) {
                    var new_key = inputStr;
                    Ext.Object.each(obj, function (key, val) {
                        if (new_key.toLowerCase() == key.toLowerCase()) {
                            new_key = key;
                        }
                    });
                    return new_key;

                },
                aggregateSnapsByOidForModel: function (snaps) {
                    //Return a hash of objects (key=ObjectID) with all snapshots for the object
                    var snaps_by_oid = {};
                    Ext.each(snaps, function (snap) {
                        var oid = snap.ObjectID || snap.get('ObjectID');
                        if (snaps_by_oid[oid] == undefined) {
                            snaps_by_oid[oid] = [];
                        }
                        snaps_by_oid[oid].push(snap.getData());

                    });
                    return snaps_by_oid;
                },
                getDateBuckets: function (startDate, endDate, granularity) {

                    var bucketStartDate = Rally.technicalservices.Toolbox.getBeginningOfMonthAsDate(
                        startDate);
                    var bucketEndDate = Rally.technicalservices.Toolbox.getEndOfMonthAsDate(endDate);

                    var date = bucketStartDate;

                    var buckets = [];
                    while (date < bucketEndDate && bucketStartDate < bucketEndDate) {
                        buckets.push(date);
                        date = Rally.util.DateTime.add(date, granularity, 1);
                    }
                    return buckets;
                },
                formatDateBuckets: function (buckets, dateFormat) {
                    var categories = [];
                    Ext.each(buckets, function (bucket) {
                        categories.push(Rally.util.DateTime.format(bucket, dateFormat));
                    });
                    categories[categories.length - 1] += "*";
                    return categories;
                }
            });
            Ext.define('Rally.technicalservices.util.Utilities', {
                singleton: true,
                hashToArray: function (hash) {
                    var result = [];
                    for (var key in hash) {
                        result.push(hash[key]);
                    }
                    return result;
                },
                daysBetweenWithFraction: function (begin_date_js, end_date_js, skip_weekends) {

                    var days_between = Rally.technicalservices.util.Utilities.daysBetween(
                        begin_date_js, end_date_js, skip_weekends);

                    if (typeof (begin_date_js) == "string") {
                        begin_date_js = Rally.util.DateTime.fromIsoString(begin_date_js);
                    }
                    if (typeof (end_date_js) == "string") {
                        end_date_js = Rally.util.DateTime.fromIsoString(end_date_js);
                    }

                    var end_date_beginning_of_day = new Date(Ext.clone(end_date_js).setHours(0, 0,
                            0, 0)),
                        begin_date_beginning_of_day = new Date(Ext.clone(begin_date_js).setHours(0,
                            0, 0, 0)),
                        add_minutes = 0,
                        delta_minutes = 0;

                    if (this.isWeekday(end_date_js)) {
                        add_minutes = Rally.util.DateTime.getDifference(end_date_js,
                            end_date_beginning_of_day, 'minute');
                    }
                    if (this.isWeekday(begin_date_js)) {
                        delta_minutes = Rally.util.DateTime.getDifference(begin_date_js,
                            begin_date_beginning_of_day, 'minute');
                    }
                    var min = days_between * 1440 + add_minutes - delta_minutes;
                    if (min > 0) {
                        min = Math.max(min / 1440, 0.01);
                    } else {
                        min = 0;
                    }
                    return Number(min.toFixed(2));
                },
                daysBetween: function (begin_date_js, end_date_js, skip_weekends) {

                    if (typeof (begin_date_js) == "string") {
                        begin_date_js = Rally.util.DateTime.fromIsoString(begin_date_js);
                    }
                    if (typeof (end_date_js) == "string") {
                        end_date_js = Rally.util.DateTime.fromIsoString(end_date_js);
                    }

                    var dDate1 = Ext.clone(begin_date_js).setHours(0, 0, 0, 0);
                    var dDate2 = Ext.clone(end_date_js).setHours(0, 0, 0, 0);

                    if (dDate1 == dDate2) {
                        return 1;
                    }
                    if (typeof dDate1 === "number") {
                        dDate1 = new Date(dDate1);
                    }
                    if (typeof dDate2 === "number") {
                        dDate2 = new Date(dDate2);
                    }

                    if (!skip_weekends) {
                        //changing the calculation (rounding up) to match previous version of app
                        return Math.floor(Math.abs(Rally.util.DateTime.getDifference(dDate1, dDate2,
                            'second')) / 86400) + 1;
                    } else {
                        // shift to the following Monday
                        if (!this.isWeekday(dDate1)) {
                            dDate1 = this.shiftDateToMonday(dDate1);
                        }
                        if (!this.isWeekday(dDate2)) {
                            dDate2 = this.shiftDateToMonday(dDate2);
                        }


                        // from the sOverflow
                        var iWeeks, iDateDiff, iAdjust = 0;
                        if (dDate2 < dDate1) {
                            var x = dDate2;
                            dDate2 = dDate1;
                            dDate1 = x;
                        }
                        var iWeekday1 = dDate1.getDay(); // day of week
                        var iWeekday2 = dDate2.getDay();
                        iWeekday1 = (iWeekday1 == 0) ? 7 : iWeekday1; // change Sunday from 0 to 7
                        iWeekday2 = (iWeekday2 == 0) ? 7 : iWeekday2;
                        if ((iWeekday1 > 5) && (iWeekday2 > 5)) iAdjust = 1; // adjustment if both days on weekend
                        iWeekday1 = (iWeekday1 > 5) ? 5 : iWeekday1; // only count weekdays
                        iWeekday2 = (iWeekday2 > 5) ? 5 : iWeekday2;

                        // calculate differnece in weeks (1000mS * 60sec * 60min * 24hrs * 7 days = 604800000)
                        iWeeks = Math.floor((dDate2.getTime() - dDate1.getTime()) / 604800000)

                        if (iWeekday1 <= iWeekday2) {
                            iDateDiff = (iWeeks * 5) + (iWeekday2 - iWeekday1)
                        } else {
                            iDateDiff = ((iWeeks + 1) * 5) - (iWeekday1 - iWeekday2)
                        }

                        iDateDiff -= iAdjust // take into account both days on weekend

                        if (iDateDiff < 1) {
                            iDateDiff = 1;
                        }
                        console.log(iDateDiff, begin_date_js, end_date_js);
                        return (iDateDiff);
                    }
                },

                isWeekday: function (check_date) {
                    var weekday = true;
                    var day = check_date.getDay();

                    if (day === 0 || day === 6) {
                        weekday = false;
                    }
                    return weekday;
                },
                shiftDateToMonday: function (check_date) {
                    var day = check_date.getDay();

                    var delta = 0;

                    if (day === 0) {
                        // it's Sunday
                        delta = 1;
                    }
                    if (day === 6) {
                        delta = 2;
                    }

                    var shifted_date = check_date;
                    if (delta > 0) {
                        shifted_date = new Date(check_date.setHours(0));
                        shifted_date = Rally.util.DateTime.add(shifted_date, "day", delta);
                    }
                    return shifted_date;
                },
                /*
                 * compress size is the point at which to move to weeks instead of days
                 */
                arrayOfDaysBetween: function (begin_date_js, end_date_js, skip_weekends, compress_size) {
                    var the_array = [];
                    if (typeof (begin_date_js) == "string") {
                        begin_date_js = Rally.util.DateTime.fromIsoString(begin_date_js);
                    }
                    if (typeof (end_date_js) == "string") {
                        end_date_js = Rally.util.DateTime.fromIsoString(end_date_js);
                    }
                    if (begin_date_js > end_date_js) {
                        var swap_holder = end_date_js;
                        end_date_js = begin_date_js;
                        begin_date_js = swap_holder;
                    }

                    var dDate1 = Ext.clone(begin_date_js).setHours(0, 0, 0, 0);
                    var dDate2 = Ext.clone(end_date_js).setHours(0, 0, 0, 0);

                    var number_of_days = this.daysBetween(begin_date_js, end_date_js, skip_weekends);

                    var add_value = 1;
                    var add_unit = 'day';

                    if (Ext.isNumber(compress_size) && number_of_days > compress_size) {
                        add_value = 7;
                    }

                    if (number_of_days <= 2) {
                        add_value = 30;
                        add_unit = 'minute';
                        dDate2 = Ext.clone(end_date_js).setHours(23, 59, 0, 0);
                    }


                    var check_date = new Date(dDate1);

                    while (check_date <= dDate2) {
                        if (!skip_weekends || this.isWeekday(check_date) || add_value === 7 ||
                            add_unit == 'minute') {
                            the_array.push(check_date);
                        }
                        check_date = Rally.util.DateTime.add(check_date, add_unit, add_value);
                    }

                    return the_array;
                }

            });
            Ext.define('CustomApp', {
                extend: 'Rally.app.App',
                componentCls: 'app',
                logger: new Rally.technicalservices.Logger(),
                exportHash: {
                    formattedId: 'Formatted ID',
                    days: 'Cycle Time (Days)',
                    startDate: 'Start Date',
                    endDate: 'End Date'
                },
                items: [{
                        xtype: 'container',
                        itemId: 'settings_box'
                    },
                    {
                        xtype: 'container',
                        itemId: 'type_selector_box',
                        layout: {
                            type: 'hbox'
                        }
                    },
                    {
                        xtype: 'container',
                        itemId: 'value_selector_box',
                        layout: {
                            type: 'hbox'
                        }
                    },
                    {
                        xtype: 'container',
                        itemId: 'time_box',
                        layout: {
                            type: 'hbox'
                        }
                    },
                    {
                        xtype: 'container',
                        itemId: 'button_box',
                        layout: {
                            type: 'hbox'
                        }
                    },
                    //    {xtype:'container',itemId:'filter_box', layout: {type: 'vbox'}, title: 'Filter by', border: 1, style: {borderColor: 'gray', borderStyle: 'solid'}},
                    {
                        xtype: 'container',
                        itemId: 'display_box'
                    },
                    {
                        xtype: 'container',
                        itemId: 'filter_box',
                        padding: 10,
                        margin: 10,
                        tpl: '<div class="ts-filter"><b>Applied Filters:</b><br><tpl for=".">{displayProperty} {operator} {displayValue}<br></tpl></div>'
                    },
                    {
                        xtype: 'tsinfolink'
                    }
                ],
                config: {
                    defaultSettings: {
                        cycleStateFields: "ScheduleState",
                        modelNames: ['HierarchicalRequirement', 'Defect'],
                        percentileLineThreshold: 85
                    }
                },
                defaultField: 'ScheduleState',
                cycleFields: [],
                granularityStore: [{
                    displayName: 'Month',
                    value: 'month',
                    dateFormat: 'M yyyy',
                    tickInterval: 1
                }, {
                    displayName: 'Week',
                    value: 'week',
                    dateFormat: 'M dd yyyy',
                    tickInterval: 5
                }],
                hiddenSeries: [],
                dateRangeStore: [{
                        name: 'Last Complete Month',
                        value: -1
                    },
                    {
                        name: 'Last 2 Complete Months',
                        value: -2
                    },
                    {
                        name: 'Last 3 Complete Months',
                        value: -3
                    },
                    {
                        name: 'Last 6 Complete Months',
                        value: -6
                    },
                    {
                        name: 'Last 12 Complete Months',
                        value: -12
                    }
                ],
                defaultDateRange: -3,
                dataFilters: [],
                launch: function () {
                    if (this.isExternal()) {
                        this.showSettings(this.config);
                    } else {
                        this.onSettingsUpdate(this.getSettings()); //(this.config.type,this.config.pageSize,this.config.fetch,this.config.columns);
                    }
                },
                _getValidFields: function (type) {
                    var cycleStateFields = [],
                        defaultFields = ['ScheduleState'];

                    if (type) {
                        this.modelNames = type.split(',');
                        this.logger.log('_getValidFields', type, this.modelNames);


                        if (/PortfolioItem/.test(this.modelNames[0])) {
                            cycleStateFields = this.getSetting('portfolioItemCycleStateFields');
                            defaultFields = ['State'];
                        } else {
                            //Story/Defect fields
                            cycleStateFields = this.getSetting('storyDefectCycleStateFields');
                        }
                        this.logger.log('cycleStateFields', cycleStateFields);
                        if (cycleStateFields && !Ext.isArray(cycleStateFields)) {
                            cycleStateFields = cycleStateFields.split(',');
                        }

                        this.logger.log("Settings fields:", cycleStateFields);
                        if (!cycleStateFields || cycleStateFields.length === 0 || Ext.isEmpty(
                                cycleStateFields[0])) {
                            cycleStateFields = defaultFields;
                        }

                        this._fetchFields(cycleStateFields).then({
                            scope: this,
                            success: function () {
                                this.logger.log(
                                    'Valid fields for cycle and filter time', this.cycleFields,
                                    this.filterFields);
                                this._addFieldPicker(this.cycleFields);
                            }
                        });
                    }
                },
                _addFieldPicker: function (validFields) {

                    if (this.down('#cb-field')) {
                        this.down('#cb-field').destroy();
                    }

                    var field_store = Ext.create('Rally.data.custom.Store', {
                        data: validFields,
                        autoLoad: true
                    });

                    this.down('#type_selector_box').add({

                        xtype: 'rallycombobox',
                        itemId: 'cb-field',
                        store: field_store,
                        valueField: 'name',
                        displayField: 'displayName',
                        fieldLabel: 'Field',
                        labelAlign: 'right',
                        labelWidth: 65,
                        queryMode: 'local',
                        allowNoEntry: false,
                        margin: 10,
                        scope: this,
                        listeners: {
                            scope: this,
                            select: this._updateDropdowns,
                            ready: function (cb) {
                                this._updateDropdowns(cb);
                            }
                        }
                    });
                },
                _addTypePicker: function (type) {

                    this.down('#type_selector_box').add({
                        xtype: 'rallycombobox',
                        autoExpand: true,
                        storeConfig: {
                            model: 'TypeDefinition',
                            filters: [{
                                property: 'TypePath',
                                operator: 'contains',
                                value: 'PortfolioItem/'
                            }],
                            autoLoad: true
                        },
                        displayField: 'DisplayName',
                        valueField: 'TypePath',
                        fieldLabel: 'Type',
                        labelAlign: 'right',
                        minWidth: 250,
                        labelWidth: 65,
                        margin: 10,
                        listeners: {
                            scope: this,
                            ready: function (cb) {
                                this._addArtifactToChoices(cb.getStore());
                                if (type) {
                                    cb.setValue(type);
                                }
                                this._getValidFields(cb.getValue());
                            },
                            select: function (cb) {
                                this._getValidFields(cb.getValue());
                            }
                        }
                    });
                },
                _getGroupNames: function () {
                    var group_names = {}; // key will be objectID
                    var data = this.down('#cb-from-state').getStore().data;

                    Ext.each(data.items, function (rec) {
                        var oid = rec.get('ObjectID');
                        var trimmed_oid = oid.replace(/\/state\//, "").replace(
                            /\/preliminaryestimate\//, "");
                        if (oid !== trimmed_oid) {
                            oid = parseInt(trimmed_oid, 10);
                        }
                        group_names[oid] = rec.get('name');

                    });
                    return group_names;
                },
                _getGroupPrecedence: function () {
                    var data = this.down('#cb-from-state').getStore().data;

                    var group = [];
                    Ext.each(data.items, function (rec) {
                        var oid = rec.get('ObjectID');
                        var trimmed_oid = oid.replace(/\/state\//, "").replace(
                            /\/preliminaryestimate\//, "");
                        if (oid !== trimmed_oid) {
                            oid = parseInt(trimmed_oid, 10);
                        }
                        group.push(oid);

                    });
                    this.logger.log('_getGroupPrecedence', this.down('#cb-from-state').getStore(),
                        group);
                    return group;
                },
                _fetchFields: function (cycleStateFields) {
                    var deferred = Ext.create('Deft.Deferred');
                    this.logger.log('_fetchFields', cycleStateFields, this.modelNames);
                    var allowed_attribute_types = ['STATE', 'STRING'];
                    var additional_filterable_fields = ['PlanEstimate', 'Owner',
                        'PreliminaryEstimate'
                    ];
                    var valid_fields = [];
                    var filter_fields = [];

                    var promises = [];
                    Ext.Array.each(this.modelNames, function (model_name) {
                        promises.push(this._fetchModelFields(model_name));
                    }, this);

                    Deft.Promise.all(promises).then({
                        scope: this,
                        success: function (fields) {
                            fields = _.flatten(fields);
                            this.logger.log('_fetchFields success', fields);
                            var field_names = [];
                            Ext.each(fields, function (f) {
                                if (f.hidden === false && f.attributeDefinition) {
                                    var attr_def = f.attributeDefinition;
                                    //this.logger.log(attr_def.ElementName, attr_def.Constrained, attr_def.AttributeType);

                                    if (!Ext.Array.contains(field_names,
                                            attr_def.ElementName)) {
                                        if (Ext.Array.contains(cycleStateFields,
                                                attr_def.ElementName)) {
                                            valid_fields.push(f);
                                        }
                                        if (Ext.Array.contains(
                                                additional_filterable_fields,
                                                attr_def.ElementName) ||
                                            (attr_def.Constrained && Ext.Array.contains(
                                                    allowed_attribute_types,
                                                    attr_def.AttributeType) &&
                                                attr_def.ReadOnly == false)) {
                                            field_names.push(attr_def.ElementName);
                                            filter_fields.push(f);
                                        }
                                    }
                                }
                            }, this);
                            this.filterFields = _.uniq(filter_fields);
                            this.cycleFields = _.uniq(valid_fields);
                            deferred.resolve();
                        }
                    });
                    return deferred;
                },
                _fetchModelFields: function (type) {
                    var deferred = Ext.create('Deft.Deferred');
                    Rally.data.ModelFactory.getModel({
                        type: type,
                        scope: this,
                        success: function (model) {
                            this.logger.log('_fetchModelFields', type, model.getFields());
                            deferred.resolve(model.getFields());

                        }
                    });
                    return deferred;
                },
                /**
                 * Called when the field is updated.  
                 */
                _updateDropdowns: function (cb) {
                    var me = this;
                    this.logger.log('_updateDropdowns', cb.getValue(), cb.getRecord());

                    if (this.down('#cb-from-state')) {
                        this.down('#cb-date-range').destroy();
                        this.down('#cb-from-state').destroy();
                        this.down('#cb-to-state').destroy();
                        this.down('#cb-excludeWeekends').destroy();
                        this.down('#cb-granularity').destroy();
                        this.down('#rb-time-box').destroy();
                        this.down('#btn-update').destroy();
                        this.down('#btn-filter').destroy();
                        this.down('#btn-export').destroy();

                    }

                    var field = cb.getValue();

                    if (cb.getRecord()) {
                        var model = cb.getRecord().get('modelType');

                        this.down('#type_selector_box').add({
                            xtype: 'rallyfieldvaluecombobox',
                            itemId: 'cb-from-state',
                            model: model,
                            field: field,
                            valueField: 'ObjectID',
                            allowNoEntry: false,
                            fieldLabel: 'Start',
                            labelAlign: 'right',
                            width: 200,
                            labelWidth: 50,
                            margin: 10
                        });

                        this.down('#type_selector_box').add({
                            xtype: 'rallyfieldvaluecombobox',
                            itemId: 'cb-to-state',
                            model: model,
                            field: field,
                            fieldLabel: 'End',
                            labelAlign: 'right',
                            labelWidth: 50,
                            margin: 10
                        });

                        this.down('#type_selector_box').add({
                            name: 'excludeWeekends',
                            itemId: 'cb-excludeWeekends',
                            xtype: 'rallycheckboxfield',
                            boxLabelAlign: 'after',
                            fieldLabel: '',
                            margin: 10,
                            boxLabel: 'Exclude Weekends'
                        });

                        var granularity_store = Ext.create('Rally.data.custom.Store', {
                            data: this.granularityStore
                        });
                        this.down('#value_selector_box').add({
                            xtype: 'rallycombobox',
                            itemId: 'cb-granularity',
                            store: granularity_store,
                            displayField: 'displayName',
                            valueField: 'value',
                            fieldLabel: 'Granularity',
                            labelAlign: 'right',
                            width: 200,
                            labelWidth: 65,
                            margin: 10
                        });

                        var date_store = Ext.create('Rally.data.custom.Store', {
                            data: this.dateRangeStore
                        });

                        this.down('#time_box').add({
                            xtype: 'rallycombobox',
                            itemId: 'cb-date-range',
                            store: date_store,
                            displayField: 'name',
                            valueField: 'value',
                            fieldLabel: 'Date Range',
                            labelAlign: 'right',
                            labelWidth: 65,
                            width: 250,
                            value: this.defaultDateRange,
                            margin: 10
                        });

                        this.down('#value_selector_box').add({
                            xtype: 'radiogroup',
                            fieldLabel: 'Select data for ',
                            itemId: 'rb-time-box',
                            defaults: {
                                flex: 1
                            },
                            margin: '10 5 5 25',
                            layout: 'hbox',
                            items: [{
                                boxLabel: 'Time Period',
                                name: 'timebox',
                                inputValue: 'T',
                                id: 'radio1',
                                checked: true,
                                margin: '0 0 0 10'
                            }, {
                                boxLabel: 'Iteration',
                                name: 'timebox',
                                inputValue: 'I',
                                id: 'radio2',
                                margin: '0 0 0 10'
                            }, {
                                boxLabel: 'Release',
                                name: 'timebox',
                                inputValue: 'R',
                                id: 'radio3',
                                margin: '0 0 0 10'
                            }],
                            listeners: {
                                change: function (rb) {
                                    if (rb.lastValue.timebox == 'T') {
                                        me.down('#time_box').removeAll();
                                        me.down('#time_box').add({
                                            xtype: 'rallycombobox',
                                            itemId: 'cb-date-range',
                                            store: date_store,
                                            displayField: 'name',
                                            valueField: 'value',
                                            fieldLabel: 'Date Range',
                                            labelWidth: 65,
                                            width: 250,
                                            value: this.defaultDateRange,
                                            margin: 10
                                        });

                                    } else if (rb.lastValue.timebox == 'I') {
                                        //console.log('me>>',me);
                                        me.down('#time_box').removeAll();
                                        me.down('#time_box').add({
                                            xtype: 'rallyiterationcombobox',
                                            fieldLabel: 'Iteration:',
                                            minWidth: 300,
                                            margin: 10,
                                            listeners: {
                                                scope: me,
                                                select: function (icb) {
                                                    me._getReleaseOrIterationOids(
                                                        icb);
                                                },
                                                ready: function (icb) {
                                                    me._getReleaseOrIterationOids(
                                                        icb);
                                                }
                                            }
                                        });

                                    } else if (rb.lastValue.timebox == 'R') {
                                        me.down('#time_box').removeAll();
                                        me.down('#time_box').add({
                                            xtype: 'rallyreleasecombobox',
                                            fieldLabel: 'Release:',
                                            minWidth: 300,
                                            margin: 10,
                                            listeners: {
                                                scope: me,
                                                select: function (icb) {
                                                    me._getReleaseOrIterationOids(
                                                        icb);
                                                },
                                                ready: function (icb) {
                                                    me._getReleaseOrIterationOids(
                                                        icb);
                                                }
                                            }
                                        });
                                    }
                                }
                            }
                        });

                        var button_width = 75;
                        this.down('#value_selector_box').add({
                            xtype: 'rallybutton',
                            itemId: 'btn-update',
                            text: 'Update',
                            scope: this,
                            width: button_width,
                            margin: '10 5 5 25',
                            handler: this._createChart
                        });

                        this.down('#value_selector_box').add({
                            xtype: 'rallybutton',
                            itemId: 'btn-filter',
                            scope: this,
                            text: 'Filter',
                            width: button_width,
                            margin: '10 5 5 5',
                            handler: this._filter
                        });
                        this.down('#value_selector_box').add({
                            xtype: 'rallybutton',
                            itemId: 'btn-export',
                            scope: this,
                            text: 'Export',
                            width: button_width,
                            margin: '10 5 5 5',
                            handler: this._export
                        });
                    }
                },
                _getStartState: function () {
                    var state = this.down('#cb-from-state').getValue().replace(/\/state\//, ""); // for the pi states

                    if (parseInt(state, 10) > 0) {
                        state = parseInt(state, 10);
                    }
                    return state
                },
                _getEndState: function () {
                    var state = this.down('#cb-to-state').getValue().replace(/\/state\//, ""); // for the pi states

                    if (parseInt(state, 10) > 0) {
                        state = parseInt(state, 10);
                    }
                    return state;
                },

                _getReleaseOrIterationOids: function (cb) {
                    var me = this;
                    me.logger.log('_getReleaseOrIterationOids', cb);
                    me.timeboxValue = cb;
                    Deft.Chain.parallel([
                        me._getReleasesOrIterations
                    ], me).then({
                        scope: me,
                        success: function (results) {
                            me.logger.log('Results:', results);

                            me.timebox_oids = Ext.Array.map(results[0], function (
                                timebox) {
                                return timebox.get('ObjectID');
                            });
                        },
                        failure: function (msg) {
                            Ext.Msg.alert('Problem Loading Timebox data', msg);
                        }
                    });
                },


                _getReleasesOrIterations: function () {
                    var deferred = Ext.create('Deft.Deferred');
                    var me = this;
                    this.logger.log('_getReleasesOrIterations>>', me.timeboxValue);

                    var timeboxModel = '';
                    var filters = [];

                    if (me.timeboxValue.name == 'Iteration') {
                        timeboxModel = 'Iteration';
                        filters = [{
                                property: 'Name',
                                operator: '=',
                                value: me.timeboxValue.getRecord().get('Name')
                            },
                            {
                                property: 'StartDate',
                                operator: '=',
                                value: me.timeboxValue.getRecord().get('StartDate').toISOString()
                            },
                            {
                                property: 'EndDate',
                                operator: '=',
                                value: me.timeboxValue.getRecord().get('EndDate').toISOString()
                            }
                        ];
                    } else if (me.timeboxValue.name == 'Release') {
                        timeboxModel = 'Release';
                        filters = [{
                                property: 'Name',
                                operator: '=',
                                value: me.timeboxValue.getRecord().get('Name')
                            },
                            {
                                property: 'ReleaseStartDate',
                                operator: '=',
                                value: me.timeboxValue.getRecord().get('ReleaseStartDate').toISOString()
                            },
                            {
                                property: 'ReleaseDate',
                                operator: '=',
                                value: me.timeboxValue.getRecord().get('ReleaseDate').toISOString()
                            }
                        ];
                    }

                    Ext.create('Rally.data.wsapi.Store', {
                        model: timeboxModel,
                        fetch: ['ObjectID'],
                        filters: Rally.data.wsapi.Filter.and(filters)
                    }).load({
                        callback: function (records, operation, successful) {
                            if (successful) {
                                //console.log('records',records,'operation',operation,'successful',successful);
                                deferred.resolve(records);
                            } else {
                                me.logger.log("Failed: ", operation);
                                deferred.reject('Problem loading: ' + operation.error.errors
                                    .join('. '));
                            }
                        }
                    });
                    return deferred.promise;
                },


                _createChart: function () {
                    var me = this;
                    var field = this.down('#cb-field').getValue();
                    var granularity_rec = this.down('#cb-granularity').getRecord();
                    var granularity = granularity_rec.get('value');
                    var start_date, end_date = new Date();
                    var excludeWeekends = me.down('#cb-excludeWeekends').value;

                    me.logger.log('Timebox value >>', me.timeboxValue);

                    if (this.down('#rb-time-box').getValue().timebox == 'I') {
                        // find["Iteration"] = { '$in': this.timebox_oids };
                        if (me.timeboxValue) {
                            start_date = new Date(me.timeboxValue.getRecord().get('StartDate'));
                            end_date = new Date(me.timeboxValue.getRecord().get('EndDate'));
                        }
                    } else if (this.down('#rb-time-box').getValue().timebox == 'R') {
                        // find["Release"] = { '$in': this.timebox_oids };
                        if (me.timeboxValue) {
                            start_date = new Date(me.timeboxValue.getRecord().get(
                                'ReleaseStartDate'));
                            end_date = new Date(me.timeboxValue.getRecord().get('ReleaseDate'));
                        }
                    } else {
                        var date_range = this.down('#cb-date-range').getValue();
                        start_date = Rally.util.DateTime.add(new Date(), "month", date_range);
                    }

                    me.logger.log('Dates Before running calculator>>', start_date, end_date);

                    var start_state = this._getStartState();
                    var filters = this.dataFilters;

                    this.logger.log('_createChart', field, start_state, this._getEndState(),
                        granularity, start_date, end_date);

                    this.setLoading('Fetching data...');
                    var store_configs = [];

                    Ext.Array.each(this.modelNames, function (model_name) {
                        store_configs.push(this._getStoreConfig(model_name));
                    }, this);

                    this.loadSnapshots(store_configs).then({
                        scope: this,
                        success: function (snapshots) {
                            var calc = Ext.create('CycleCalculator', {
                                cycleField: field,
                                cycleStartValue: start_state,
                                cycleEndValue: this._getEndState(),
                                cyclePrecedence: this._getGroupPrecedence(),
                                cycleNames: this._getGroupNames(),
                                modelNames: this.modelNames,
                                startDate: start_date,
                                endDate: end_date,
                                granularity: granularity,
                                dateFormat: granularity_rec.get('dateFormat'),
                                dataFilters: filters,
                                percentileLineThreshold: this.getSetting(
                                    'percentileLineThreshold'),
                                excludeWeekends: excludeWeekends
                            });
                            this.setLoading(false);
                            var chart_data = calc.runCalculation(snapshots);
                            this._drawChart(chart_data);
                            this.exportData = calc.cycleTimeDataExport;
                        }
                    });
                },
                _export: function () {
                    if (this.exportData) {

                        this.logger.log('_exportData', this.exportHash);
                        var text = Rally.technicalservices.FileUtilities.convertDataArrayToCSVText(
                            this.exportData, this.exportHash);
                        Rally.technicalservices.FileUtilities.saveTextAsFile(text, 'cycle-time.csv');
                    }
                },
                _getChartColors: function () {
                    if (this.modelNames.length > 1) {
                        return ['#000000', '#8bbc21', '#c42525', '#8bbc21', '#c42525'];
                    }
                    return ['#8bbc21', '#8bbc21', '#8bbc21', '#8bbc21'];
                },
                _drawChart: function (chart_data) {
                    this.logger.log('_drawChart');

                    var me = this;
                    var chart = this.down('#rally-chart')
                    if (chart) {
                        this.down('#rally-chart').destroy();
                    }

                    var granularity_rec = this.down('#cb-granularity').getRecord();

                    var state_names = this._getGroupNames();

                    var start_state = state_names[this._getStartState()] || this._getStartState() ||
                        '(None)';
                    var end_state = state_names[this._getEndState()] || this._getEndState() ||
                        '(None)';

                    var title_text = 'Average Cycle Time from ' + start_state + ' to ' + end_state;
                    var tick_interval = granularity_rec.get('tickInterval');

                    var chart_colors = this._getChartColors();

                    this.down('#display_box').add({
                        xtype: 'rallychart',
                        itemId: 'rally-chart',
                        chartData: chart_data,
                        loadMask: false,
                        chartColors: chart_colors,
                        updateAfterRender: function () {
                            if (me.hiddenSeries && me.hiddenSeries.length > 0) {
                                Ext.each(this.chartData.series, function (s) {
                                    if (Ext.Array.contains(me.hiddenSeries, s.name)) {
                                        s.visible = false;
                                    }
                                });
                            }
                        },
                        updateBeforeRender: this._beforeChartRender,
                        chartConfig: {
                            chart: {
                                zoomType: 'xy',
                                type: 'line'
                            },
                            title: {
                                text: title_text
                            },
                            xAxis: {
                                tickInterval: tick_interval,
                                title: {
                                    text: 'Date Entered ' + end_state
                                }
                            },
                            yAxis: [{
                                title: {
                                    text: 'Days'
                                },
                                min: 0
                            }],
                            plotOptions: {
                                series: {
                                    dataLabels: {
                                        format: '{point.y:.1f}'
                                    },
                                    marker: {
                                        enabled: false
                                    },
                                    events: {
                                        legendItemClick: function () {
                                            if (this.visible) {
                                                //we are hiding it
                                                me.hiddenSeries = _.union(me.hiddenSeries, [
                                                    this.name
                                                ]);
                                            } else {
                                                me.hiddenSeries = _.without(me.hiddenSeries,
                                                    this.name);
                                            }
                                        }
                                    }

                                },
                                line: {
                                    connectNulls: true,
                                    tooltip: {
                                        pointFormat: '<span style="color:{series.color}">\u25CF</span> {series.name}: <b>{point.y:.1f}</b><br/>'
                                    }
                                }
                            }

                        }
                    });
                },
                _beforeChartRender: function () {
                    this.chartConfig.plotOptions.line.tooltip.pointFormat =
                        '<span style="color:{series.color}">\u25CF</span> {series.name}: <b>{point.y:.1f} {point.n}</b><br/>';
                },
                _setFilters: function (filters) {
                    this.dataFilters = filters;
                    this.down('#filter_box').update(filters);
                },
                _filter: function () {
                    this.logger.log('_filter', this.filterFields);
                    Ext.create('Rally.technicalservices.dialog.Filter', {
                        validFields: this.filterFields,
                        filters: this.dataFilters,
                        app: this,
                        listeners: {
                            scope: this,
                            customFilter: function (filters) {
                                this.logger.log('_filter event fired', filters);
                                this._setFilters(filters);
                                this._createChart();
                            }
                        }
                    });
                },
                /**
                 * Functions to load the snapshots upfront
                 * 
                 */
                loadSnapshots: function (storeConfigs) {
                    var deferred = Ext.create('Deft.Deferred');
                    this.logger.log('loadSnapshots', storeConfigs);

                    var promises = [];
                    Ext.each(storeConfigs, function (storeConfig) {
                        promises.push(this._loadStore(storeConfig));
                    }, this);

                    Deft.Promise.all(promises).then({
                        scope: this,
                        success: function (snapshots) {
                            this.logger.log('loadSnapshots success', snapshots);
                            var hydrated_snaps = [];
                            for (var i = 0; i < snapshots.length; i++) {
                                var type = storeConfigs[i]["find"]["_TypeHierarchy"];
                                //Now we will hydrate the type ourselves
                                hydrated_snaps.push(_.map(snapshots[i], function (snap) {
                                    var obj = snap.getData();
                                    obj["_TypeHierarchy"] = [type];
                                    return obj;
                                }));

                            }
                            hydrated_snaps = _.flatten(hydrated_snaps);
                            deferred.resolve(hydrated_snaps);
                        }
                    });
                    return deferred;
                },
                _loadStore: function (storeConfig) {
                    var deferred = Ext.create('Deft.Deferred');

                    this.logger.log('_loadStore', storeConfig);

                    storeConfig = _.extend(storeConfig, {
                        limit: 'Infinity',
                        removeUnauthorizedSnapshots: true,
                        autoLoad: true,
                        sort: {
                            _ValidFrom: 1
                        },
                        listeners: {
                            scope: this,
                            load: function (store, records, success) {
                                this.logger.log('_loadStore load returned', records.length,
                                    success, records);
                                if (success) {
                                    deferred.resolve(records);
                                } else {
                                    deferred.resolve([]);
                                }
                            }
                        }
                    });
                    this.logger.log('_loadStore create store');
                    Ext.create('Rally.data.lookback.SnapshotStore', storeConfig);

                    return deferred;
                },
                _getStoreConfig: function (type) {
                    var field = this.down('#cb-field').getValue();
                    var fetch = this._getFetchFields();
                    this.logger.log('_getStoreConfig', type, field, fetch);

                    var rb = this.down('#rb-time-box');
                    console.log('>>>>>>>>>>>', rb)
                    var find = {
                        "Children": null,
                        "_TypeHierarchy": type
                    };

                    if (this.getContext().getProjectScopeDown()) {
                        find["_ProjectHierarchy"] = {
                            $in: [this.getContext().getProject().ObjectID]
                        };
                    } else {
                        find["Project"] = this.getContext().getProject().ObjectID;
                    }

                    if (rb && rb.lastValue.timebox == 'I') {
                        find["Iteration"] = {
                            '$in': this.timebox_oids
                        };
                    } else if (rb && rb.lastValue.timebox == 'R') {
                        find["Release"] = {
                            '$in': this.timebox_oids
                        };
                    }


                    var store_config = {
                        find: find,
                        fetch: fetch,
                        hydrate: ['ScheduleState'],
                        //compress: true,
                        sort: {
                            _ValidFrom: 1
                        },
                        context: this.getContext().getDataContext()
                    }
                    this.logger.log('_getStoreConfig', store_config);
                    return store_config;
                },
                _getFetchFields: function () {
                    var field = this.down('#cb-field').getValue();
                    var fetch_fields = ['ObjectID', field, '_TypeHierarchy', '_SnapshotNumber',
                        'ScheduleState', 'FormattedID'
                    ];

                    var filter_fields = [];
                    Ext.each(this.dataFilters, function (f) {
                        if (f.property != field) {
                            filter_fields.push(f.property);
                        }
                    }, this);
                    this.logger.log('_getFetchFields', Ext.Array.merge(fetch_fields, filter_fields));
                    return Ext.Array.merge(fetch_fields, filter_fields);
                },
                _addArtifactToChoices: function (store) {
                    store.add({
                        DisplayName: 'Story/Defect',
                        TypePath: ['HierarchicalRequirement', 'Defect']
                    });
                },
                /********************************************
                /* Overrides for App class
                /*
                /********************************************/
                //getSettingsFields:  Override for App    
                getSettingsFields: function () {
                    var me = this;

                    return [{
                        name: 'percentileLineThreshold',
                        xtype: 'rallynumberfield',
                        minValue: 0,
                        maxValue: 100,
                        labelWidth: 225,
                        margin: '10 0 10 10',
                        fieldLabel: 'Percentile Line Threshold (%)',
                        labelAlign: 'right'
                    }, {
                        name: 'portfolioItemCycleStateFields',
                        itemId: 'portfoliofields_box',
                        xtype: 'rallyfieldpicker',
                        modelTypes: ['PortfolioItem'],
                        labelWidth: 225,
                        fieldLabel: 'Valid Portfolio Item Cycle States',
                        labelAlign: 'right',
                        minWidth: 450,
                        margin: '10 0 10 10',
                        autoExpand: true,
                        alwaysExpanded: false,
                        storeConfig: {
                            context: {
                                project: null
                            }
                        },
                        listeners: {
                            ready: function (cb) {
                                cb.setValue(['State']);
                                cb.collapse();
                            }
                        },
                        readyEvent: 'ready'
                    }, {
                        name: 'storyDefectCycleStateFields',
                        itemId: 'storyfields_box',
                        xtype: 'rallyfieldpicker',
                        modelTypes: ['HierarchicalRequirement', 'Defect'],
                        labelWidth: 225,
                        fieldLabel: 'Valid User Story/Defect Cycle States',
                        labelAlign: 'right',
                        minWidth: 450,
                        margin: '10 0 250 10',
                        autoExpand: true,
                        alwaysExpanded: false,
                        storeConfig: {
                            context: {
                                project: null
                            }
                        },
                        listeners: {
                            ready: function (cb) {
                                cb.setValue(['ScheduleState']);
                                cb.collapse();
                            }
                        },
                        readyEvent: 'ready'
                    }];
                },
                isExternal: function () {
                    return typeof (this.getAppId()) == 'undefined';
                },
                //showSettings:  Override
                showSettings: function (options) {
                    this._appSettings = Ext.create('Rally.app.AppSettings', Ext.apply({
                        fields: this.getSettingsFields(),
                        settings: this.getSettings(),
                        defaultSettings: this.getDefaultSettings(),
                        context: this.getContext(),
                        settingsScope: this.settingsScope,
                        autoScroll: true
                    }, options));

                    this._appSettings.on('cancel', this._hideSettings, this);
                    this._appSettings.on('save', this._onSettingsSaved, this);
                    if (this.isExternal()) {
                        if (this.down('#settings_box').getComponent(this._appSettings.id) ==
                            undefined) {
                            this.down('#settings_box').add(this._appSettings);
                        }
                    } else {
                        this.hide();
                        this.up().add(this._appSettings);
                    }
                    return this._appSettings;
                },
                _onSettingsSaved: function (settings) {
                    Ext.apply(this.settings, settings);
                    this._hideSettings();
                    this.onSettingsUpdate(settings);
                },
                onSettingsUpdate: function (settings) {
                    this._addTypePicker();
                }
            });

            Rally.launchApp('CustomApp', {
                name: 'Filtered Cycle Time'
            });
        });
    </script>

    <style type="text/css">
        .app {}

        .tsinfolink {
            position: absolute;
            right: 0px;
            width: 14px;
            height: 14px;
            border-radius: 7px;
            text-align: center;
            color: white;
            background: #C0C0C0;
            border-style: solid;
            border-width: 1px;
            margin-top: 25px;
            margin-right: 5px;
            cursor: pointer;
        }

        .ts-filter {
            text-align: center;
        }
    </style>

</head>

<body></body>

</html>
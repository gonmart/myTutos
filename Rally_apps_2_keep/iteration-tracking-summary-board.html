<!DOCTYPE html>
<html>

<head>
    <title>Iteration Tracking Summary Board</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function() {
            (function() {
                var Ext = window.Ext4 || window.Ext;

                /**
                 * Abstract class to handle expanding / collapsing for banner widgets
                 */
                Ext.define('Rally.apps.iterationtracking.statsbanner.BannerWidget', {
                    extend: 'Ext.Component',
                    alias: 'widget.bannerwidget',

                    config: {
                        expanded: true
                    },

                    cls: 'stat-panel',

                    data: {},

                    tpl: [
                        '<div class="expanded-widget"></div>',
                        '<div class="collapsed-widget"></div>'
                    ],

                    onRender: function() {
                        if (this.expanded) {
                            this.removeCls('collapsed');
                        } else {
                            this.addCls('collapsed');
                        }
                        this.callParent(arguments);
                    },

                    expand: function() {
                        this.removeCls('collapsed');
                        this.setExpanded(true);
                    },

                    collapse: function() {
                        this.addCls('collapsed');
                        this.setExpanded(false);
                    }
                });
            })();

            (function() {
                var Ext = window.Ext4 || window.Ext;

                /**
                 * gauge chart for stats banner
                 * abstract class
                 */
                Ext.define('Rally.apps.iterationtracking.statsbanner.Gauge', {
                    extend: 'Rally.apps.iterationtracking.statsbanner.BannerWidget',
                    alias: 'widget.statsbannergauge',

                    requires: [
                        'Rally.ui.chart.Chart',
                        'Rally.util.Timebox',
                        'Rally.util.Colors'
                    ],

                    config: {
                        context: null,
                        store: null,
                        iteration: null
                    },

                    onDataChanged: Ext.emptyFn,
                    getChartEl: Ext.emptyFn,
                    _getChartConfig: Ext.emptyFn,

                    _tzOffsetPromises: {},

                    initComponent: function() {
                        this.mon(this.store, 'datachanged', this.onDataChanged, this);
                        this.callParent(arguments);
                    },

                    expand: function() {
                        this.callParent();
                        if (this.chart) {
                            this.chart.doLayout();
                        } else {
                            this._addChart(this._getChartConfig({}));
                        }
                    },

                    onRender: function() {
                        this.callParent(arguments);
                        if (!this.getContext().getTimeboxScope().getRecord()) {
                            this._addEmptyChart();
                        }
                    },

                    _addEmptyChart: function() {
                        this._cleanupChart();
                        this._addChart({
                            chartData: {
                                series: [{
                                    data: [{
                                        name: '',
                                        y: 100,
                                        color: Rally.util.Colors.grey1
                                    }]
                                }]
                            }
                        });
                    },

                    _cleanupChart: function() {
                        if (this.chart) {
                            this.chart.destroy();
                            delete this.chart;
                        }
                    },

                    onDestroy: function() {
                        this._cleanupChart();
                        this.callParent(arguments);
                    },

                    onResize: function() {
                        if (this.chart && !this.getEl().up('.stats-banner.collapsed')) {
                            this.chart.updateLayout();
                        }
                        this.callParent(arguments);
                    },

                    refreshChart: function(chartConfig) {
                        Ext.suspendLayouts();
                        this._cleanupChart();
                        if (this.rendered && this.expanded) {
                            this._addChart(chartConfig);
                        }
                        Ext.resumeLayouts();
                        this.fireEvent('ready', this);
                    },

                    _addChart: function(chartConfig) {
                        var height = 62;
                        this.chart = Ext.create('Rally.ui.chart.Chart', Ext.apply({
                            loadMask: false,
                            renderTo: this.getChartEl(),
                            cls: 'gauge',
                            chartConfig: {
                                chart: {
                                    backgroundColor: 'rgba(255, 255, 255, 0.1)',
                                    defaultSeriesType: 'pie',
                                    height: height,
                                    spacingTop: 0,
                                    spacingRight: 0,
                                    spacingBottom: 0,
                                    spacingLeft: 0
                                },
                                plotOptions: {
                                    pie: {
                                        borderWidth: 0,
                                        center: ['50%', '50%'],
                                        dataLabels: {
                                            enabled: false
                                        },
                                        size: height - 4,
                                        innerSize: height - 14,
                                        enableMouseTracking: false, //turns off chart hover, but for tooltips you'll need this on
                                        shadow: false
                                    }
                                },
                                title: '',
                                tooltip: {
                                    enabled: false
                                }
                            }
                        }, chartConfig));
                    },

                    getTimeboxData: function() {
                        return this._getTZOffset().then({
                            success: function(tzOffset) {
                                var timebox = this.getContext().getTimeboxScope().getRecord();
                                if (timebox) {
                                    return Rally.util.Timebox.getCounts(
                                        timebox.get('StartDate'),
                                        timebox.get('EndDate'),
                                        this.getContext().getWorkspace().WorkspaceConfiguration.WorkDays,
                                        tzOffset);
                                } else {
                                    return {
                                        remaining: 0,
                                        workdays: 0
                                    };
                                }
                            },
                            scope: this
                        });
                    },

                    _getTZOffset: function() {
                        var projectRef = Rally.util.Ref.getRelativeUri(this.getContext().getProject());
                        if (!Ext.isDefined(this._tzOffsetPromises[projectRef])) {
                            var deferred = this._tzOffsetPromises[projectRef] = Ext.create('Deft.Deferred');
                            Rally.environment.getIoProvider().httpGet({
                                url: Rally.environment.getServer().getWsapiUrl() + '/iteration',
                                params: {
                                    includeSchema: true,
                                    pagesize: 1,
                                    fetch: false,
                                    project: projectRef
                                },
                                success: function(results) {
                                    deferred.resolve((results.Schema.properties.EndDate.format.tzOffset || 0) / 60);
                                },
                                requester: this,
                                scope: this
                            });
                        }
                        return this._tzOffsetPromises[projectRef];
                    },

                    getAcceptanceData: function() {
                        var acceptanceData = {
                            accepted: 0,
                            total: 0,
                            acceptedCount: 0,
                            count: 0
                        };

                        var data = _.pluck(this.store.getRange(), 'raw');

                        acceptanceData.accepted = _.chain(data)
                            .where({
                                'ScheduleState': 'Accepted'
                            })
                            .reduce(function(sum, rec) {
                                return sum + rec.PlanEstimate;
                            }, 0)
                            .value();
                        acceptanceData.total = this.store.sum('PlanEstimate');
                        acceptanceData.acceptedCount = _.where(data, {
                            'ScheduleState': 'Accepted'
                        }).length;
                        acceptanceData.count = this.store.count()

                        // _.each(this.store.getRange(), function (rec) {
                        //   acceptanceData.accepted += rec.get('AcceptedLeafStoryPlanEstimateTotal');
                        //   acceptanceData.total += rec.get('LeafStoryPlanEstimateTotal');
                        //   acceptanceData.acceptedCount += rec.get('AcceptedLeafStoryCount');
                        //   acceptanceData.count += rec.get('LeafStoryCount');
                        // });

                        return Deft.Promise.when(acceptanceData);
                    },

                    getEstimatedData: function() {
                        var acceptanceData = {
                            accepted: 0,
                            total: 0
                        };

                        acceptanceData.accepted = this.store.sum('PlanEstimate', true).Accepted;
                        acceptanceData.total = this.store.sum('PlanEstimate');

                        // _.each(this.store.getRange(), function (rec) {
                        //   acceptanceData.accepted += rec.get('LeafStoryCount') - rec.get('UnEstimatedLeafStoryCount');
                        //   acceptanceData.total += rec.get('LeafStoryCount');
                        // });

                        return Deft.Promise.when(acceptanceData);
                    },

                    _getScheduleStates: function() {
                        if (this._scheduleStates) {
                            return Deft.Promise.when(this._scheduleStates);
                        } else {
                            return this.store.model.getField('ScheduleState').getAllowedValueStore().load().then({
                                success: function(records) {
                                    this._scheduleStates = _.map(records, function(record) {
                                        return record.get('StringValue');
                                    });
                                    return this._scheduleStates;
                                },
                                scope: this,
                                requester: this
                            });
                        }
                    }
                });
            })();

            (function() {
                var Ext = window.Ext4 || window.Ext;

                /**
                 * shows planned velocity for timebox
                 */
                Ext.define('Rally.apps.iterationtracking.statsbanner.PlannedVelocity', {
                    extend: 'Rally.apps.iterationtracking.statsbanner.Gauge',
                    alias: 'widget.statsbannerplannedvelocity',
                    require: ['Rally.util.Colors'],

                    tpl: [
                        '<div class="expanded-widget">',
                        '<div class="stat-title">Planned Velocity</div>',
                        '<div class="stat-metric">',
                        '<div class="metric-chart"></div>',
                        '<div class="metric-chart-text percent-offset">',
                        '{percentage}<div class="metric-percent">%</div>',
                        '</div>',
                        '<div class="metric-subtext">{estimate} of {plannedVelocity} {unit}</div>',
                        '</div>',
                        '</div>',
                        '<div class="collapsed-widget">',
                        '<div class="stat-title">Planned Velocity</div>',
                        '<div class="stat-metric">{percentage}<span class="metric-percent">%</span></div>',
                        '</div>'
                    ],

                    config: {
                        data: {
                            percentage: 0,
                            estimate: 0,
                            plannedVelocity: 0,
                            unit: ''
                        }
                    },

                    onDataChanged: function() {
                        var renderData = this._getRenderData();
                        this.update(renderData);

                        this.refreshChart(this._getChartConfig(renderData));
                    },

                    getChartEl: function() {
                        return this.getEl().down('.metric-chart');
                    },

                    _getTimeboxUnits: function() {
                        return this.getContext().getTimeboxScope().getType() === 'iteration' ?
                            this.getContext().getWorkspace().WorkspaceConfiguration.IterationEstimateUnitName :
                            this.getContext().getWorkspace().WorkspaceConfiguration.ReleaseEstimateUnitName;
                    },

                    _getRenderData: function() {
                        var estimate = _.reduce(this.store.getRange(), function(accum, record) {
                            return accum + record.get('PlanEstimate') || 0;
                        }, 0);

                        estimate = Math.round(estimate * 100) / 100;

                        var plannedVelocity = 0;

                        var timeboxRecord = this.getContext().getTimeboxScope().getRecord();
                        if (this.iteration) {
                            plannedVelocity = this.iteration.get('PlannedVelocity') || 0
                        } else {
                            plannedVelocity = (timeboxRecord && timeboxRecord.get('ChildrenPlannedVelocity')) || 0;
                        }

                        var percentage = plannedVelocity === 0 ? 0 : Math.round(estimate / plannedVelocity * 100);

                        var data = {
                            estimate: estimate,
                            percentage: percentage,
                            plannedVelocity: plannedVelocity,
                            unit: this.unitLabel ? this.unitLabel : this._getTimeboxUnits()
                        };

                        return data;
                    },

                    _getChartConfig: function(renderData) {
                        var percentage = renderData.percentage,
                            percentagePlanned = percentage % 100 || 100,
                            color = Rally.util.Colors.cyan_med,
                            secondaryColor = Rally.util.Colors.grey1;

                        if (percentage > 100) {
                            color = Rally.util.Colors.blue;
                            secondaryColor = Rally.util.Colors.cyan;
                        } else if (percentage > 70) {
                            color = Rally.util.Colors.cyan;
                        } else if (percentage === 0) {
                            color = Rally.util.Colors.grey1;
                        }

                        return {
                            chartData: {
                                series: [{
                                    data: [{
                                            name: 'Planned Estimate Total',
                                            y: percentagePlanned,
                                            color: color
                                        },
                                        {
                                            name: '',
                                            y: 100 - percentagePlanned,
                                            color: secondaryColor
                                        }
                                    ]
                                }]
                            }
                        };
                    }
                });
            })();

            (function() {
                var Ext = window.Ext4 || window.Ext;

                /**
                 * shows days remaining for timebox
                 */
                Ext.define('Rally.apps.iterationtracking.statsbanner.TimeboxEnd', {
                    extend: 'Rally.apps.iterationtracking.statsbanner.Gauge',
                    alias: 'widget.statsbannertimeboxend',
                    requires: [
                        'Rally.util.Timebox',
                        'Rally.util.Colors'
                    ],

                    tpl: [
                        '<div class="expanded-widget">',
                        '<div class="stat-title">{type} End</div>',
                        '<div class="stat-metric">',
                        '<div class="metric-chart"></div>',
                        '<div class="metric-chart-text">',
                        '{remaining}',
                        '</div>',
                        '<div class="metric-subtext">days left of {workdays}</div>',
                        '</div>',
                        '</div>',
                        '<div class="collapsed-widget">',
                        '<div class="stat-title">{type} End</div>',
                        '<div class="stat-metric">{remaining}<span class="stat-metric-secondary"> days</span></div>',
                        '</div>'
                    ],

                    config: {
                        data: {
                            type: 'Iteration',
                            remaining: 0,
                            workdays: 0
                        }
                    },

                    onDataChanged: function() {
                        Deft.Promise.all([
                            this.getAcceptanceData(),
                            this.getTimeboxData()
                        ]).then({
                            success: this._onDataAssembled,
                            scope: this
                        });
                    },

                    getChartEl: function() {
                        return this.getEl().down('.metric-chart');
                    },

                    _getRenderData: function() {
                        var data = _.merge({
                                type: Ext.String.capitalize(this.getContext().getTimeboxScope().getType())
                            },
                            this.acceptanceData,
                            this.timeboxData
                        );

                        return data;
                    },

                    _onDataAssembled: function(results) {
                        this.acceptanceData = results[0];
                        this.timeboxData = results[1];

                        var renderData = this._getRenderData();
                        this.update(renderData);

                        this.refreshChart(this._getChartConfig(renderData));
                    },

                    _getChartConfig: function(renderData) {
                        var decimal = renderData.remaining / renderData.workdays,
                            percentLeft = decimal < 1 ? Math.round(decimal * 100) : 0,
                            color = Rally.util.Colors.cyan;

                        if (renderData.remaining === 0) {
                            color = Rally.util.Colors.grey1;
                        } else if (percentLeft === 0) {
                            color = renderData.remaining === renderData.workdays ? Rally.util.Colors.lime : Rally.util.Colors.blue;
                        } else if (percentLeft <= 25) {
                            color = Rally.util.Colors.blue;
                        }

                        return {
                            chartData: {
                                series: [{
                                    data: [{
                                            name: 'Days Done',
                                            y: 100 - percentLeft,
                                            color: color
                                        },
                                        {
                                            name: 'Days Left',
                                            y: percentLeft,
                                            color: Rally.util.Colors.grey1
                                        }
                                    ]
                                }]
                            }
                        };
                    }
                });
            })();

            (function() {
                var Ext = window.Ext4 || window.Ext;

                Ext.define('Rally.apps.iterationtracking.statsbanner.popover.Defects', {
                    alias: 'widget.defectspopover',
                    extend: 'Rally.ui.popover.Popover',

                    constructor: function(config) {
                        config.items = [{
                            xtype: 'rallygrid',
                            model: 'Defect',
                            headerCls: 'leftright-header-text',
                            columnCfgs: ['FormattedID', 'Name', 'Iteration', 'Project', 'Owner', 'State', 'ScheduleState'],
                            pagingToolbarCfg: {
                                pageSizes: [5, 10, 15]
                            },
                            store: config.store
                        }];

                        this.callParent(arguments);
                    }
                });
                /**
                 * shows defects active for timebox
                 */
                Ext.define('Rally.apps.iterationtracking.statsbanner.Defects', {
                    extend: 'Rally.apps.iterationtracking.statsbanner.BannerWidget',
                    alias: 'widget.statsbannerdefects',
                    requires: [],

                    config: {
                        context: null,
                        store: null,
                        data: {
                            activeCount: 0
                        }
                    },

                    tpl: [
                        '<div class="expanded-widget">',
                        // '<span style="cursor: pointer">',
                        '<div class="stat-title">Defects</div>',
                        '<div class="stat-metric">',
                        '<div class="metric-icon icon-defect"></div>{activeCount}',
                        '<div class="stat-secondary">active</div>',
                        '</span>',
                        '</div>',
                        '</div>',
                        '<div class="collapsed-widget">',
                        '<span class="metric-icon icon-defect"></span>',
                        '<div class="stat-title">Defects</div>',
                        '<div class="stat-metric">{activeCount}</div>',
                        '</div>'
                    ],

                    initComponent: function() {
                        this.mon(this.store, 'datachanged', this.onDataChanged, this);
                        /*this.on('render', function () {
                          this.getEl().on('click', function () {
                            this._onClickDefects();
                          }, this);
                        }, this);*/
                        this.callParent(arguments);
                    },

                    onDataChanged: function() {
                        this.update(this._getRenderData());
                        this.fireEvent('ready', this);
                    },

                    _getDefectsCount: function() {
                        var defects = 0;
                        _.each(this.store.getRange(), function(record) {

                            if (record.get('_type') === 'defect' && record.get('State') !== 'Closed') {
                                if (!(record.get('Requirement') && record.get('Requirement').Iteration && record.get('Requirement').Iteration.Name)) {
                                    defects++;
                                }
                            } else {
                                if (record.get('Summary').Defects) {
                                    _.each(record.get('Summary').Defects.State, function(count, state) {
                                        if (state !== 'Closed') {
                                            defects += count;
                                        }
                                    })
                                }
                            }
                        }, this);
                        return defects;
                    },

                    _getRenderData: function() {
                        return {
                            activeCount: this._getDefectsCount()
                        };
                    },

                    _onClickDefects: function() {
                        var record = this.store.getAt(0);
                        //record = _(this.store.getRange()).filter(function (r) { return r.data.UserStories !== ''; }).first();

                        var
                            target = this.getEl();
                        //targetSelector = this.targetSelector;
                        //
                        var store = Ext.create('Rally.data.wsapi.Store', {
                            model: 'Defect',
                            fetch: ['FormattedID', 'Name', 'Iteration', 'Project', 'Owner', 'State', 'ScheduleState', 'Requirement'],
                            filters: [{
                                    property: 'State',
                                    operator: '!=',
                                    value: 'Closed'
                                },
                                Rally.data.wsapi.Filter.or([{
                                    property: 'Iteration.Name',
                                    value: this.getContext().getTimeboxScope().getRecord().get('Name')
                                }, {
                                    property: 'Requirement.Iteration.Name',
                                    value: this.getContext().getTimeboxScope().getRecord().get('Name')
                                }])
                            ],
                            autoLoad: true,
                            pageSize: 5
                        });

                        var reloadStoreCallback;
                        Ext.create('Rally.apps.iterationtracking.statsbanner.popover.Defects', {
                            target: target,
                            autoShow: false,
                            store: store,
                            title: 'Active Defects',
                            width: 800
                        }).show();
                    }
                });
            })();

            (function() {
                var Ext = window.Ext4 || window.Ext;

                /**
                 * shows defects active for timebox
                 */
                Ext.define('Rally.apps.iterationtracking.statsbanner.Tasks', {
                    extend: 'Rally.apps.iterationtracking.statsbanner.BannerWidget',
                    alias: 'widget.statsbannertasks',
                    requires: [],

                    config: {
                        context: null,
                        store: null,
                        data: {
                            activeCount: 0
                        }
                    },

                    tpl: [
                        '<div class="expanded-widget">',
                        '<div class="stat-title">Tasks</div>',
                        '<div class="stat-metric">',
                        '<div class="metric-icon icon-task"></div>{activeCount}',
                        '<div class="stat-secondary">active</div>',
                        '</span>',
                        '</div>',
                        '</div>',
                        '<div class="collapsed-widget">',
                        '<span class="metric-icon icon-task"></span>',
                        '<div class="stat-title">Tasks</div>',
                        '<div class="stat-metric">{activeCount}</div>',
                        '</div>'
                    ],

                    initComponent: function() {
                        this.mon(this.store, 'datachanged', this.onDataChanged, this);

                        this.callParent(arguments);
                    },

                    onDataChanged: function() {
                        this.update(this._getRenderData());
                        this.fireEvent('ready', this);
                    },

                    _getTasksCount: function() {
                        var tasks = 0;
                        _.each(this.store.getRange(), function(record) {
                            if (record.get('Summary').Tasks) {
                                _.each(record.get('Summary').Tasks.State, function(count, state) {
                                    if (state !== 'Completed') {
                                        tasks += count;
                                    }
                                })
                            }
                        }, this);
                        return tasks;
                    },

                    _getRenderData: function() {
                        return {
                            activeCount: this._getTasksCount()
                        };
                    }
                });
            })();

            (function() {
                var Ext = window.Ext4 || window.Ext;

                /**
                 * shows accepted work units for timebox
                 */
                Ext.define('Rally.apps.iterationtracking.statsbanner.Accepted', {
                    extend: 'Rally.apps.iterationtracking.statsbanner.Gauge',
                    alias: 'widget.statsbanneraccepted',
                    requires: ['Rally.util.Colors'],

                    tpl: [
                        '<div class="expanded-widget">',
                        '<div class="stat-title">Accepted</div>',
                        '<div class="stat-metric">',
                        '<div class="metric-chart"></div>',
                        '<div class="metric-chart-text percent-offset">',
                        '{percentage}<div class="metric-percent">%</div>',
                        '</div>',
                        '<div class="metric-subtext">{accepted} of {total} {unit}</div>',
                        '</div>',
                        '</div>',
                        '<div class="collapsed-widget">',
                        '<div class="stat-title">Accepted Stories</div>',
                        '<div class="stat-metric">{percentage}<span class="metric-percent">%</span></div>',
                        '</div>'
                    ],

                    config: {
                        data: {
                            percentage: 0,
                            accepted: 0,
                            total: 0,
                            unit: ''
                        }
                    },

                    //constructor: function (config) {
                    //this.callParent(arguments);
                    //},

                    onDataChanged: function() {
                        Deft.Promise.all([
                            this.getAcceptanceData(),
                            this.getTimeboxData()
                        ]).then({
                            success: this._onDataAssembled,
                            scope: this
                        });
                    },

                    getChartEl: function() {
                        return this.getEl().down('.metric-chart');
                    },

                    _getTimeboxUnits: function() {
                        return this.getContext().getTimeboxScope().getType() === 'iteration' ?
                            this.getContext().getWorkspace().WorkspaceConfiguration.IterationEstimateUnitName :
                            this.getContext().getWorkspace().WorkspaceConfiguration.ReleaseEstimateUnitName;
                    },

                    _getRenderData: function() {
                        var data = _.merge({
                                unit: this._getTimeboxUnits()
                            },
                            this.acceptanceData,
                            this.timeboxData
                        );

                        if (this.byCount) {
                            data.accepted = Ext.util.Format.round(data.acceptedCount, 2);
                            data.total = Ext.util.Format.round(data.count, 2);
                            data.unit = '';
                        } else {
                            data.accepted = Ext.util.Format.round(data.accepted, 2);
                            data.total = Ext.util.Format.round(data.total, 2);
                        }

                        data.percentage = Math.round((data.accepted / data.total) * 100) || 0;

                        return data;
                    },

                    _onDataAssembled: function(results) {
                        this.acceptanceData = results[0];
                        this.timeboxData = results[1];

                        var renderData = this._getRenderData();
                        this.update(renderData);

                        this.refreshChart(this._getChartConfig(renderData));
                    },

                    _getChartConfig: function(renderData) {
                        var color = Rally.util.Colors.cyan,
                            daysRemaining = renderData.remaining / renderData.workdays,
                            percentage = renderData.percentage;

                        if (percentage === 100) {
                            color = Rally.util.Colors.lime;
                        } else if (daysRemaining === 0) {
                            color = Rally.util.Colors.blue;
                        }

                        return {
                            chartData: {
                                series: [{
                                    data: [{
                                            name: 'Accepted Stories',
                                            y: percentage,
                                            color: color
                                        },
                                        {
                                            name: '',
                                            y: 100 - percentage,
                                            color: Rally.util.Colors.grey1
                                        }
                                    ]
                                }]
                            }
                        };
                    }
                });
            })();

            (function() {
                var Ext = window.Ext4 || window.Ext;

                Ext.define("Rally.apps.iterationtracking.statsbanner.iterationprogresscharts.IterationProgressMixin", {
                    requires: [
                        "Rally.ui.chart.Chart"
                    ],

                    _configureYAxis: function(ticks, axis) {

                        var intervalY = (this.chartComponentConfig.chartConfig.yAxis[axis].max - 0) / (ticks - 1);
                        var ticksY = [];
                        for (var i = 0; i < ticks; i++) {
                            ticksY.push(i * intervalY);
                        }
                        this.chartComponentConfig.chartConfig.yAxis[axis].tickPositions = ticksY;
                    },

                    _configureYAxisIntervals: function() {
                        var ticks = 5; // not much chart space, limit to 5
                        this._configureYAxis(ticks, 0);
                        if (this.chartType === "burndown") { // cumulative flow only has y axis 0
                            this._configureYAxis(ticks, 1);
                        }
                    },

                    _getElementValue: function(element) {
                        if (element.textContent !== undefined) {
                            return element.textContent;
                        }
                        return element.text;
                    },

                    _getStringValues: function(elements) {
                        var i;
                        var strings = [];
                        for (i = 0; i < elements.length; i++) {
                            strings.push(this._getElementValue(elements[i]));
                        }
                        return strings;
                    },

                    _transformStringToNumber: function(element) {
                        return element.replace(',', '') * 1;
                    },

                    _getNumberFromXMLString: function(element) {
                        return this._transformStringToNumber(element.split(' ')[0]);
                    },

                    _getNumberValues: function(elements) {
                        var i;
                        var numbers = [];
                        for (i = 0; i < elements.length; i++) {
                            if (this._getElementValue(elements[i])) {
                                numbers.push(this._getNumberFromXMLString(this._getElementValue(elements[i])));
                            } else {
                                numbers.push(0);
                            }

                        }
                        return numbers;
                    },

                    _computeMaxYAxisValue: function(series) {
                        var i, j, max = 0.0;
                        // sum each day's values and find the largest sum
                        for (i = 0; i < series[0].data.length; i++) {
                            var val = 0.0;
                            for (j = 0; j < series.length; j++) {
                                // if is for insurance, _should_ always be true
                                if (series[j].data.length === series[0].data.length) {
                                    val += series[j].data[i];
                                }
                            }
                            if (val > max) {
                                max = val;
                            }
                        }
                        max = Math.ceil(max / 4) * 4; // round up to multiple of 4 so we will create 5 integral tick marks

                        return (max === 0) ? 4 : max;
                    },

                    _createChartDatafromXML: function(xml) {
                        var parseXml;

                        if (typeof window.DOMParser !== "undefined") {
                            parseXml = function(xmlStr) {
                                return (new window.DOMParser()).parseFromString(xmlStr, "text/xml");
                            };
                        } else if (typeof window.ActiveXObject !== "undefined" &&
                            new window.ActiveXObject("Microsoft.XMLDOM")) {
                            parseXml = function(xmlStr) {
                                var xmlDoc = new window.ActiveXObject("Microsoft.XMLDOM");
                                xmlDoc.async = "false";
                                xmlDoc.loadXML(xmlStr);
                                return xmlDoc;
                            };
                        } else {
                            throw new Error("No XML parser found");
                        }

                        return parseXml(xml);
                    }
                });
            }());

            (function() {
                var Ext = window.Ext4 || window.Ext;

                Ext.define("Rally.apps.iterationtracking.statsbanner.iterationprogresscharts.IterationProgressChart", {
                    requires: [
                        "Rally.ui.chart.Chart"
                    ],

                    chartComponentConfig: {
                        xtype: "rallychart",
                        suppressClientMetrics: true /* keeps rallychart::lookback query time from displaying in client metrics */
                    }
                });
            }());

            (function() {
                var Ext = window.Ext4 || window.Ext;

                Ext.define("Rally.apps.iterationtracking.statsbanner.iterationprogresscharts.BurndownChart", {
                    alias: "widget.statsbannerburndownchart",
                    extend: "Ext.Container",
                    requires: [
                        'Rally.ui.chart.Chart'
                    ],
                    mixins: [
                        "Rally.apps.iterationtracking.statsbanner.iterationprogresscharts.IterationProgressMixin",
                        "Rally.apps.iterationtracking.statsbanner.iterationprogresscharts.IterationProgressChart"
                    ],

                    currentScope: undefined,
                    context: undefined,
                    height: undefined,
                    width: undefined,
                    displayTitle: 'Burndown',
                    minimalMode: false,
                    onChartDataLoaded: Ext.emptyFn,

                    initComponent: function() {
                        this.callParent(arguments);

                        var ioid = 0;
                        var cpoid = 0;

                        var itrcnt = {};
                        _.each(this.store.getRange(), function(record) {
                            itrcnt[record.get('Iteration')._ref] = null;
                        })

                        var cnt = Object.keys(itrcnt).length

                        if (this.store.first()) {
                            ioid = this.store.first().get('Iteration').ObjectID;
                            cpoid = this.store.first().get('Project').ObjectID;
                        }

                        if (cnt > 1) {
                            ioid = this.context.getTimeboxScope().getRecord().getId();
                            cpoid = this.context.getProject().ObjectID;
                        }

                        Ext.Ajax.request({
                            url: '/slm/charts/itsc.sp',
                            params: {
                                iterationOid: ioid, //this.context.getTimeboxScope().getRecord().getId(),
                                cpoid: cpoid //this.context.getProject().ObjectID
                            },
                            method: 'GET',
                            withCredentials: true,
                            success: function(response, request) {
                                this._loadData(response.responseText);
                            },
                            requester: this,
                            scope: this
                        });
                    },

                    _loadData: function(chartData) {
                        var xmlDoc = this._createChartDatafromXML(chartData);
                        this._createBurndownChartDatafromXML(xmlDoc);
                    },

                    _createChartConfig: function(overrides) {
                        var clickChartHandler = _.isFunction(this.clickHandler) ? this.clickHandler : Ext.emptyFn;

                        return Ext.Object.merge({
                            xtype: 'rallychart',
                            chartColors: ["#005eb8", "#666666", "#8dc63f"],
                            updateAfterRender: Ext.bind(this._onLoad, this),

                            chartConfig: {
                                chart: {
                                    height: this.height,
                                    width: this.width,
                                    spacingTop: 2,
                                    spacingRight: 0,
                                    spacingBottom: 8,
                                    spacingLeft: 0,
                                    zoomType: 'xy',
                                    alignTicks: false,
                                    animation: true,
                                    events: {
                                        click: clickChartHandler
                                    }
                                },
                                plotOptions: {
                                    series: {
                                        animation: true,
                                        shadow: false,
                                        borderWidth: 0,
                                        marker: {
                                            enabled: false,
                                            states: {
                                                hover: {
                                                    enabled: false
                                                }
                                            }
                                        },
                                        events: {
                                            click: clickChartHandler
                                        }
                                    },
                                    column: {
                                        point: {
                                            events: {
                                                click: clickChartHandler
                                            }
                                        }
                                    }
                                },
                                legend: {
                                    enabled: true
                                },
                                title: {
                                    text: null
                                },
                                xAxis: {
                                    tickmarkPlacement: 'on',
                                    tickInterval: 1
                                },
                                yAxis: [{
                                        title: {
                                            text: null
                                        },
                                        min: 0,
                                        labels: {
                                            style: {
                                                color: "#005eb8"
                                            }
                                        }
                                    },
                                    {
                                        title: {
                                            text: null
                                        },
                                        min: 0,
                                        opposite: true,
                                        labels: {
                                            style: {
                                                color: "#8dc63f"
                                            }
                                        }
                                    }
                                ]
                            },
                            chartData: {
                                categories: [],
                                series: [{
                                        name: "To Do",
                                        type: "column",
                                        data: [],
                                        tooltip: {
                                            enabled: false
                                        }
                                    },
                                    {
                                        name: "Ideal",
                                        type: "line",
                                        dashStyle: "Solid",
                                        data: [],
                                        marker: {
                                            enabled: true,
                                            radius: 3
                                        },
                                        tooltip: {
                                            enabled: false
                                        }
                                    },
                                    {
                                        name: "Accepted",
                                        type: "column",
                                        data: [],
                                        yAxis: 1,
                                        tooltip: {
                                            enabled: false
                                        }
                                    }
                                ]
                            }
                        }, overrides || {});
                    },

                    _createMinimalConfig: function() {
                        var config = this._createChartConfig();
                        delete config.chartConfig.xAxis;
                        delete config.chartConfig.yAxis;
                        delete config.chartData.series[1].marker;

                        config = Ext.Object.merge(config, {
                            chartConfig: {
                                chart: {
                                    zoomType: ''
                                },
                                tooltip: {
                                    formatter: function() {
                                        return false;
                                    }
                                },
                                legend: {
                                    enabled: false
                                },
                                xAxis: {
                                    labels: {
                                        enabled: false
                                    },
                                    tickPositions: []
                                },

                                yAxis: [{
                                        title: {
                                            text: null
                                        },
                                        min: 0,
                                        labels: {
                                            enabled: false
                                        }
                                    },
                                    {
                                        title: {
                                            text: null
                                        },
                                        min: 0,
                                        opposite: true,
                                        labels: {
                                            enabled: false
                                        }
                                    }
                                ],
                                title: {
                                    text: null
                                }
                            }
                        });
                        return config;
                    },

                    _createBurndownChartDatafromXML: function(xmlDoc) {

                        this.chartComponentConfig = this.minimalMode ? this._createMinimalConfig() : this._createChartConfig();

                        var xmlChartData = xmlDoc.getElementsByTagName("chart_data")[0];
                        var xmlChartValueText = xmlDoc.getElementsByTagName("chart_value_text")[0];
                        var draw = xmlDoc.getElementsByTagName("draw")[0];
                        var axis_value = xmlDoc.getElementsByTagName("axis_value")[1];

                        var rows = xmlChartData.getElementsByTagName("row");

                        // this makes no sense...The thing labeled Accepted in the <chart_data> element, isn't.
                        // The thing that is Accepted, is buried in the <chart_value_text> element

                        this.chartComponentConfig.chartData.categories = this._getStringValues(rows[0].getElementsByTagName("string")); // categories
                        this.chartComponentConfig.chartData.series[0].data = this._getNumberValues(rows[1].getElementsByTagName("number")); //todo;
                        this.chartComponentConfig.chartData.series[1].data = this._getNumberValues(rows[3].getElementsByTagName("number")); //ideal;
                        this.chartComponentConfig.chartData.series[2].data = this._getNumberValues(xmlChartValueText.getElementsByTagName("row")[2].getElementsByTagName("number")); //accepted;
                        this.chartComponentConfig.chartConfig.yAxis[0].max = axis_value.getAttribute("max") * 1;

                        var texts = draw.getElementsByTagName("text");
                        // find the last <text element with orientation="vertical_down" attribute, that's the max y-axis 2 setting
                        for (i = 0; i < texts.length; i++) {
                            if (texts[i].getAttribute("orientation") === "vertical_down") {
                                this.chartComponentConfig.chartConfig.yAxis[1].max = (this._getNumberFromXMLString(this._getElementValue(texts[i])));
                            }
                        }
                        this._configureYAxisIntervals();

                        this.chartComponentConfig.chartConfig.xAxis.tickInterval = Math.floor(this.chartComponentConfig.chartData.series[0].data.length / 4);

                        this.add(this.chartComponentConfig);
                    },

                    _onLoad: function() {
                        this.fireEvent('contentupdated', this);
                        this.fireEvent('ready', this);
                        if (Rally.BrowserTest) {
                            Rally.BrowserTest.publishComponentReady(this);
                        }
                    }
                });
            })();

            (function() {
                var Ext = window.Ext4 || window.Ext;

                Ext.define("Rally.apps.iterationtracking.statsbanner.iterationprogresscharts.CumulativeFlowChart", {
                    alias: "widget.statsbannercumulativeflowchart",
                    extend: "Ext.Container",
                    requires: ['Rally.ui.chart.Chart'],
                    mixins: [
                        "Rally.apps.iterationtracking.statsbanner.iterationprogresscharts.IterationProgressMixin",
                        "Rally.apps.iterationtracking.statsbanner.iterationprogresscharts.IterationProgressChart"
                    ],
                    cls: 'rally-iteration-progress-cumulative-flow-chart',
                    currentScope: undefined,
                    context: undefined,
                    height: undefined,
                    width: undefined,
                    displayTitle: 'Cumulative Flow',
                    minimalMode: false,
                    initComponent: function() {
                        this.callParent(arguments);

                        var ioid = 0;
                        var cpoid = 0;

                        var itrcnt = {};
                        _.each(this.store.getRange(), function(record) {
                            itrcnt[record.get('Iteration')._ref] = null;
                        })

                        var cnt = Object.keys(itrcnt).length
                        if (this.store.getCount() === 0) {
                            cnt = 1;
                        }

                        if (this.store.first()) {
                            ioid = this.store.first().get('Iteration').ObjectID;
                            cpoid = this.store.first().get('Project').ObjectID;
                        }

                        if (cnt > 1) {
                            ioid = this.context.getTimeboxScope().getRecord().getId();
                            cpoid = this.context.getProject().ObjectID;
                        }

                        Ext.Ajax.request({
                            url: '/slm/charts/icfc.sp',
                            params: {
                                iterationOid: ioid, //this.context.getTimeboxScope().getRecord().getId(),
                                cpoid: cpoid, //this.context.getProject().ObjectID,
                                bigChart: true
                            },
                            method: 'GET',
                            withCredentials: true,
                            success: function(response, request) {
                                this._loadData(response.responseText);
                            },
                            requester: this,
                            scope: this
                        });
                    },

                    _loadData: function(chartData) {
                        var xmlDoc = this._createChartDatafromXML(chartData);
                        this._createCumulativeFlowChartDatafromXML(xmlDoc);
                    },

                    _createMinimalConfig: function() {
                        var config = this._createChartConfig();
                        delete config.chartConfig.xAxis;
                        delete config.chartConfig.yAxis;

                        return Ext.Object.merge(config, {
                            chartConfig: {
                                tooltip: {
                                    formatter: function() {
                                        return false;
                                    }
                                },
                                legend: {
                                    enabled: false
                                },
                                xAxis: {
                                    labels: {
                                        enabled: false
                                    },
                                    tickPositions: []
                                },
                                yAxis: [{
                                    title: {
                                        text: null
                                    },
                                    min: 0,
                                    labels: {
                                        enabled: false
                                    }
                                }],
                                title: {
                                    text: null
                                }
                            }
                        });
                    },

                    _createChartConfig: function(overrides) {
                        var clickChartHandler = _.isFunction(this.clickHandler) ? this.clickHandler : Ext.emptyFn;

                        return Ext.Object.merge({
                            xtype: 'rallychart',
                            updateAfterRender: Ext.bind(this._onLoad, this),

                            chartColors: [ // RGB values obtained from here: http://ux-blog.rallydev.com/?cat=23
                                "#C0C0C0", // $grey4
                                "#FF8200", // $orange
                                "#F6A900", // $gold
                                "#FAD200", // $yellow
                                "#CADDA3", // $lime
                                "#1E7C00"
                            ],
                            chartConfig: {
                                chart: {
                                    height: this.height,
                                    width: this.width,
                                    spacingTop: 2,
                                    spacingRight: 0,
                                    spacingBottom: 8,
                                    spacingLeft: 0,
                                    alignTicks: false,
                                    animation: true,
                                    type: "area",
                                    events: {
                                        click: clickChartHandler
                                    }
                                },
                                plotOptions: {
                                    series: {
                                        animation: true,
                                        marker: {
                                            enabled: false,
                                            states: {
                                                hover: {
                                                    enabled: false
                                                }
                                            }
                                        }
                                    },
                                    area: {
                                        point: {
                                            events: {
                                                click: clickChartHandler
                                            }
                                        },
                                        stacking: 'normal'
                                    }
                                },
                                legend: {
                                    enabled: true
                                },
                                title: {
                                    text: null
                                },
                                xAxis: {
                                    tickmarkPlacement: 'on',
                                    tickInterval: 1
                                },
                                yAxis: [{
                                    title: {
                                        text: null
                                    },
                                    min: 0,
                                    labels: {
                                        style: {
                                            color: "#005eb8"
                                        }
                                    }
                                }]
                            },
                            chartData: {
                                categories: [],
                                series: []
                            }
                        }, overrides || {});
                    },

                    _createCumulativeFlowChartDatafromXML: function(xmlDoc) {

                        this.chartComponentConfig = this.minimalMode ? this._createMinimalConfig() : this._createChartConfig();

                        var xmlChartData = xmlDoc.getElementsByTagName("chart_data")[0];

                        var rows = xmlChartData.getElementsByTagName("row");
                        var i, j;
                        this.chartComponentConfig.chartData.categories = this._getStringValues(rows[0].getElementsByTagName("string")); // categories
                        for (j = rows.length - 1, i = 0; j > 0; j--, i++) {
                            this.chartComponentConfig.chartData.series[i] = {};
                            this.chartComponentConfig.chartData.series[i].data = this._getNumberValues(rows[j].getElementsByTagName("number"));
                            this.chartComponentConfig.chartData.series[i].name = this._getStringValues(rows[j].getElementsByTagName("string"))[0];
                        }

                        // the 'max' y axis value in the xml isn't correct, so we'll calculate it ourselves...
                        this.chartComponentConfig.chartConfig.yAxis[0].max = this._computeMaxYAxisValue(this.chartComponentConfig.chartData.series);

                        this._configureYAxisIntervals();


                        // Use number of ScheduleState values to show as a surrogate for with of the legend text.
                        if (this.chartComponentConfig.chartData.series.length === 6) {
                            this.chartComponentConfig.chartConfig.legend.itemStyle = {
                                fontSize: '8px'
                            };
                        } else if (this.chartComponentConfig.chartData.series.length === 5) {
                            this.chartComponentConfig.chartConfig.legend.itemStyle = {
                                fontSize: '10px'
                            };
                        } // else it will default to 12px

                        this.chartComponentConfig.chartConfig.xAxis.tickInterval = Math.floor(this.chartComponentConfig.chartData.series[0].data.length / 4);

                        this.add(this.chartComponentConfig);
                    },


                    _onLoad: function() {
                        this.fireEvent('contentupdated', this);
                        this.fireEvent('ready', this);
                        if (Rally.BrowserTest) {
                            Rally.BrowserTest.publishComponentReady(this);
                        }
                    }
                });

            })();

            (function() {
                var Ext = window.Ext4 || window.Ext;

                Ext.define("Rally.apps.iterationtracking.statsbanner.iterationprogresscharts.PieChart", {
                    alias: "widget.statsbannerpiechart",
                    extend: "Ext.Container",
                    requires: [
                        'Rally.ui.chart.Chart'
                    ],
                    mixins: {
                        recordable: 'Rally.clientmetrics.ClientMetricsRecordable'
                    },

                    currentScope: undefined,
                    height: undefined,
                    width: undefined,
                    displayTitle: 'Pie',
                    config: {
                        context: null
                    },

                    initComponent: function() {
                        this.callParent(arguments);

                        if (this._storyStates === undefined) {
                            Rally.data.ModelFactory.getModels({
                                types: ['UserStory', 'Defect', 'DefectSuite', 'TestSet'],
                                context: this.getContext(),
                                scope: this,
                                requester: this,
                                success: this._createStateMap
                            });
                        } else {
                            this._loadArtifacts();
                        }
                    },

                    _createStateMap: function(models) {
                        var stateMap = ['Defined', 'In-Progress', 'Completed'],
                            stateMapIndex = 0,
                            storyStates = {};

                        _.each(models.UserStory.getField('ScheduleState').getAllowedStringValues(), function(state) {
                            if (state === stateMap[stateMapIndex + 1]) {
                                stateMapIndex++;
                            }
                            storyStates[state] = stateMap[stateMapIndex];
                        });

                        this._storyStates = storyStates;
                        this._loadArtifacts();
                    },

                    _loadArtifacts: function() {
                        this._chartData = [];
                        this._childChartData = [];

                        /*this.store = Ext.create('Rally.data.wsapi.artifact.Store', {
                            models: ['User Story', 'Defect', 'Defect Suite', 'Test Set'],
                            fetch: ['Defects', 'PlanEstimate', 'Requirement', 'FormattedID', 'Name', 'Blocked', 'BlockedReason', 'ScheduleState', 'State', 'Tasks', 'TestCases'],
                            filters: [this.context.getTimeboxScope().getQueryFilter()],
                            sorters: [
                                {property: 'ScheduleState'}
                            ],
                            context: this.context.getDataContext(),
                            limit: Infinity,
                            requester: this,
                            autoLoad: true,
                            listeners: {
                                load: this._loadChildCollections,
                                scope: this
                            }
                        });*/
                        this._loadChildCollections()
                    },

                    _loadChildCollections: function() {
                        var records = this.store.getRange();
                        var promises = [];
                        _.each(records, function(record) {
                            if (record.get('Defects') && record.get('Defects').Count) {
                                promises.push(record.getCollection('Defects', {
                                    fetch: ['FormattedID', 'Name', 'ScheduleState', 'Blocked', 'BlockedReason', 'Requirement', 'State']
                                }).load({
                                    requester: this,
                                    callback: function(defects) {
                                        record.get('Defects').Results = defects;
                                    }
                                }));
                            }
                            if (record.get('Tasks') && record.get('Tasks').Count) {
                                promises.push(record.getCollection('Tasks', {
                                    fetch: ['FormattedID', 'Name', 'Blocked', 'BlockedReason', 'WorkProduct', 'State']
                                }).load({
                                    requester: this,
                                    callback: function(tasks) {
                                        record.get('Tasks').Results = tasks;
                                    }
                                }));
                            }
                            if (record.get('TestCases') && record.get('TestCases').Count) {
                                promises.push(record.getCollection('TestCases', {
                                    fetch: ['FormattedID', 'Name', 'Type', 'WorkProduct']
                                }).load({
                                    requester: this,
                                    callback: function(testCases) {
                                        record.get('TestCases').Results = testCases;
                                    }
                                }));
                            }
                        });

                        if (promises.length > 0) {
                            Deft.Promise.all(promises).then({
                                success: this._onAllDataLoaded,
                                scope: this
                            });
                        } else {
                            this._onAllDataLoaded();
                        }
                    },

                    _onAllDataLoaded: function() {
                        _.each(this.store.getRange(), function(record) {
                            var defects = record.get('Defects');
                            var defectCount = (defects && defects.Count) || 0;
                            var tasks = record.get('Tasks');
                            var taskCount = (tasks && tasks.Count) || 0;
                            var testCases = record.get('TestCases');
                            var testCaseCount = (testCases && testCases.Count) || 0;
                            var relatedCount = taskCount + defectCount + testCaseCount;
                            var planEstimate = record.get('PlanEstimate') || 1;
                            var pointSizeForChildren = (planEstimate / relatedCount) || 1;
                            var nullPointString = 'No tasks or defects.';

                            this._addPointForTopLevelItem(record, relatedCount);

                            if (relatedCount === 0) {
                                this._childChartData.push({
                                    name: nullPointString,
                                    y: planEstimate,
                                    color: '#FFF',
                                    rallyName: null,
                                    status: '',
                                    blocked: false,
                                    blockedReason: '',
                                    hasChildren: false,
                                    relatedCount: 0,
                                    ref: null,
                                    parentFormattedID: null
                                });
                            } else {
                                if (defects && defects.Results) {
                                    _.each(defects.Results, function(defect) {
                                        this._addPointForChildItem(defect, record.get('FormattedID'), pointSizeForChildren);
                                    }, this);
                                }

                                if (tasks && tasks.Results) {
                                    _.each(tasks.Results, function(task) {
                                        this._addPointForChildItem(task, record.get('FormattedID'), pointSizeForChildren);
                                    }, this);
                                }

                                if (testCases && testCases.Results) {
                                    _.each(testCases.Results, function(testCase) {
                                        this._addPointForChildItem(testCase, record.get('FormattedID'), pointSizeForChildren, record.get('ScheduleState'), record.get('Blocked'));
                                    }, this);
                                }
                            }
                        }, this);

                        var chart = this._createChartConfig();
                        this.add(chart);

                        this.recordLoadEnd();
                    },

                    _onLoad: function() {
                        this.fireEvent('contentupdated', this);
                        this.fireEvent('ready', this);
                        if (Rally.BrowserTest) {
                            Rally.BrowserTest.publishComponentReady(this);
                        }
                    },

                    _createChartConfig: function(overrides) {
                        var me = this;
                        var clickChartHandler = _.isFunction(this.clickHandler) ? this.clickHandler : Ext.emptyFn;
                        var height = this.height;
                        var pieHeight = this.height * 0.9;

                        return Ext.Object.merge({
                            xtype: 'rallychart',
                            loadMask: false,
                            updateAfterRender: Ext.bind(this._onLoad, this),

                            chartData: {
                                series: [{
                                        type: 'pie',
                                        name: 'Parents',
                                        data: this._chartData,
                                        size: pieHeight,
                                        allowPointSelect: false,
                                        dataLabels: {
                                            enabled: false
                                        }
                                    },
                                    {
                                        type: 'pie',
                                        name: 'Children',
                                        data: this._childChartData,
                                        size: pieHeight,
                                        innerSize: 0.8 * pieHeight,
                                        allowPointSelect: false,
                                        dataLabels: {
                                            enabled: false
                                        }
                                    }
                                ]
                            },

                            chartConfig: {
                                chart: {
                                    type: 'pie',
                                    height: height,
                                    width: this.width,
                                    spacingTop: 0,
                                    spacingRight: 3,
                                    spacingBottom: 0,
                                    spacingLeft: 3,
                                    events: {
                                        click: clickChartHandler
                                    }
                                },
                                subtitle: {
                                    useHTML: true,
                                    text: '<table align="center" class="pie-chart-legend"><tr><td><span class="legend-swatch defined-sample-swatch"></span><span>Defined</td>' +
                                        '<td><span class="legend-swatch in-progress-sample-swatch"></span>In-Progress</td>' +
                                        '<td><span class="legend-swatch completed-sample-swatch"></span>Completed</td>' +
                                        '<td><span class="legend-swatch blocked-sample-swatch"></span>Blocked</td></tr></table>',
                                    verticalAlign: 'bottom',
                                    floating: true,
                                    x: -10,
                                    y: -20
                                },
                                tooltip: {
                                    formatter: this._formatTooltip,
                                    useHTML: true
                                },
                                spacingTop: 0,
                                title: {
                                    text: null
                                },
                                plotOptions: {
                                    pie: {
                                        cursor: 'pointer',
                                        shadow: false,
                                        center: ['50%', '45%'],
                                        point: {
                                            events: {
                                                click: function() {
                                                    var ref = this.ref;
                                                    if (ref) {
                                                        me.up('rallydialog').destroy();
                                                        Rally.nav.Manager.showDetail(ref);
                                                    }
                                                }
                                            }
                                        },
                                        showInLegend: false
                                    }
                                }
                            }
                        }, overrides || {});
                    },

                    _addPointForTopLevelItem: function(record, relatedCount) {
                        var blocked = record.get('Blocked');
                        var color = this._colorFromStatus(this._storyStates[record.get('ScheduleState')], blocked);
                        var pointSize = record.get('PlanEstimate') || 1;

                        this._chartData.push({
                            name: record.get('FormattedID'),
                            y: pointSize,
                            color: color,
                            rallyName: record.get('Name'),
                            status: record.get('ScheduleState'),
                            blocked: blocked,
                            blockedReason: blocked ? record.get('BlockedReason') : null,
                            hasChildren: relatedCount > 0,
                            relatedCount: relatedCount,
                            ref: record.get('_ref'),
                            parentFormattedID: null
                        });
                    },

                    _colorFromStatus: function(state, blocked) { //refactor into css and classes, should get cleaner
                        var progressColors = {
                            'Defined': '#C0C0C0', // light gray
                            'In-Progress': '#00A9E0', // cyan
                            'Completed': '#8DC63F', // lime
                            'Blocked': '#EE1C25' // red
                        };
                        var color = progressColors[state];
                        if (blocked) {
                            color = progressColors.Blocked;
                        }
                        return color;
                    },

                    _addPointForChildItem: function(record, parentFormattedID, pointSize, parentState, isParentBlocked) {
                        var blocked = record.get('Blocked');
                        var state = record.get('ScheduleState') || record.get('State') || record.get('Type');
                        var color = this._colorFromStatus(this._storyStates[parentState || state], blocked || isParentBlocked);

                        this._childChartData.push({
                            name: record.get('FormattedID'),
                            y: pointSize,
                            color: color,
                            rallyName: record.get('Name'),
                            status: state,
                            blocked: blocked,
                            blockedReason: blocked ? record.get('BlockedReason') : null,
                            hasChildren: false,
                            relatedCount: 0,
                            ref: record.get('_ref'),
                            parentFormattedID: parentFormattedID
                        });
                    },

                    _formatTooltip: function() {
                        var relatedMessage = '';
                        var blockedMessage = '';
                        var artifactName = this.point.rallyName ? '<b>' + this.point.name + '</b>: ' + this.point.rallyName + '<br/>' : this.point.name;

                        if (this.point.blocked) {
                            blockedMessage = '<br/><b>Blocked</b>';
                            if (this.point.blockedReason) {
                                blockedMessage += ': ' + this.point.blockedReason;
                            }
                        }

                        if (this.point.series && this.point.series.name === 'Parents') {
                            relatedMessage = (this.point.relatedCount) ? '<br/>Related Items: ' + this.point.relatedCount : '';
                        }

                        return '<div style="min-width:200px;white-space:normal">' + artifactName + this.point.status + relatedMessage + blockedMessage + '</div>';
                    }
                });
            })();

            (function() {
                var Ext = window.Ext4 || window.Ext;

                Ext.define("Rally.apps.iterationtracking.statsbanner.iterationprogresscharts.MinimalPieChart", {
                    alias: "widget.statsbannerminimalpiechart",
                    extend: "Rally.apps.iterationtracking.statsbanner.iterationprogresscharts.PieChart",

                    _loadArtifacts: function() {
                        this._chartData = [];
                        this._childChartData = [];
                        this._createDataPointsFromSummary();
                    },

                    _createDataPointsFromSummary: function() {
                        _.each(this.store.getRange(), function(record) {
                            var summary = record.get('Summary');
                            var totalChildItems = 0;
                            var planEstimate = record.get('PlanEstimate') || 1;
                            var nullPointString = 'No tasks or defects.';
                            var testCases = record.get('TestCases');
                            var keys, state, scheduleState, blocked, count;

                            totalChildItems += summary.Defects ? summary.Defects.Count : 0;
                            totalChildItems += summary.Tasks ? summary.Tasks.Count : 0;
                            totalChildItems += testCases ? testCases.Count : 0;

                            var pointSizeForChildren = (planEstimate / totalChildItems) || 1;

                            this._addPointForTopLevelItem(record, totalChildItems);

                            if (totalChildItems === 0) {
                                this._childChartData.push({
                                    name: nullPointString,
                                    y: planEstimate,
                                    color: '#FFF',
                                    rallyName: null,
                                    status: '',
                                    blocked: false,
                                    blockedReason: '',
                                    hasChildren: false,
                                    relatedCount: 0,
                                    ref: null,
                                    parentFormattedID: null
                                });
                            }
                            if (summary.Tasks && summary.Tasks.Count) {
                                keys = _.keys(summary.Tasks['state+blocked']);
                                _.each(keys, function(key) {
                                    state = key.split('+');
                                    scheduleState = state[0];
                                    blocked = state[1] === 'true';
                                    count = summary.Tasks['state+blocked'][key];
                                    _.each(_.range(0, count), function(point) {
                                        this._addPointForChildItem(record.get('FormattedID'), pointSizeForChildren, scheduleState, blocked);
                                    }, this);
                                }, this);
                            }
                            if (summary.Defects && summary.Defects.Count) {
                                keys = _.keys(summary.Defects['schedulestate+blocked']);
                                _.each(keys, function(key) {
                                    state = key.split('+');
                                    scheduleState = state[0];
                                    blocked = state[1] === 'true';
                                    count = summary.Defects['schedulestate+blocked'][key];
                                    _.each(_.range(0, count), function(point) {
                                        this._addPointForChildItem(record.get('FormattedID'), pointSizeForChildren, scheduleState, blocked);
                                    }, this);
                                }, this);
                            }
                            if (testCases && testCases.Count) {
                                _.each(_.range(0, testCases.Count), function(point) {
                                    this._addPointForChildItem(record.get('FormattedID'), pointSizeForChildren, record.get('ScheduleState'), record.get('Blocked'));
                                }, this);
                            }
                        }, this);

                        var chart = this._createChartConfig();
                        this.add(chart);

                    },

                    _onAllDataLoaded: function() {
                        _.each(this.store.getRange(), function(record) {
                            var defects = record.get('Defects');
                            var defectCount = (defects && defects.Count) || 0;
                            var tasks = record.get('Tasks');
                            var taskCount = (tasks && tasks.Count) || 0;
                            var testCases = record.get('TestCases');
                            var testCaseCount = (testCases && testCases.Count) || 0;
                            var relatedCount = taskCount + defectCount + testCaseCount;
                            var planEstimate = record.get('PlanEstimate') || 1;
                            var pointSizeForChildren = (planEstimate / relatedCount) || 1;
                            var nullPointString = 'No tasks or defects.';

                            this._addPointForTopLevelItem(record, relatedCount);

                            if (relatedCount === 0) {
                                this._childChartData.push({
                                    name: nullPointString,
                                    y: planEstimate,
                                    color: '#FFF',
                                    rallyName: null,
                                    status: '',
                                    blocked: false,
                                    blockedReason: '',
                                    hasChildren: false,
                                    relatedCount: 0,
                                    ref: null,
                                    parentFormattedID: null
                                });
                            } else {
                                if (defects && defects.Results) {
                                    _.each(defects.Results, function(defect) {
                                        this._addPointForChildItem(defect, record.get('FormattedID'), pointSizeForChildren);
                                    }, this);
                                }

                                if (tasks && tasks.Results) {
                                    _.each(tasks.Results, function(task) {
                                        this._addPointForChildItem(task, record.get('FormattedID'), pointSizeForChildren);
                                    }, this);
                                }

                                if (testCases && testCases.Results) {
                                    _.each(testCases.Results, function(testCase) {
                                        this._addPointForChildItem(testCase, record.get('FormattedID'), pointSizeForChildren, record.get('ScheduleState'), record.get('Blocked'));
                                    }, this);
                                }
                            }
                        }, this);

                        var chart = this._createChartConfig();
                        this.add(chart);

                        this.recordLoadEnd();
                    },

                    _createChartConfig: function(overrides) {
                        var clickChartHandler = _.isFunction(this.clickHandler) ? this.clickHandler : Ext.emptyFn;
                        var height = this.height;
                        return Ext.Object.merge({
                            xtype: 'rallychart',
                            loadMask: false,
                            updateAfterRender: Ext.bind(this._onLoad, this),

                            chartData: {
                                series: [{
                                        type: 'pie',
                                        name: 'Parents',
                                        data: this._chartData,
                                        size: height,
                                        allowPointSelect: false,
                                        dataLabels: {
                                            enabled: false
                                        }
                                    },
                                    {
                                        type: 'pie',
                                        name: 'Children',
                                        data: this._childChartData,
                                        size: height,
                                        innerSize: 0.8 * height,
                                        allowPointSelect: false,
                                        dataLabels: {
                                            enabled: false
                                        }
                                    }
                                ]
                            },

                            chartConfig: {
                                chart: {
                                    type: 'pie',
                                    height: height,
                                    width: this.width,
                                    spacingTop: 0,
                                    spacingRight: 0,
                                    spacingBottom: 0,
                                    spacingLeft: 0,
                                    events: {
                                        click: clickChartHandler
                                    }
                                },
                                tooltip: {
                                    formatter: function() {
                                        return false;
                                    }
                                },
                                spacingTop: 0,
                                title: {
                                    text: null
                                },
                                plotOptions: {
                                    pie: {
                                        shadow: false,
                                        center: ['50%', '50%'],
                                        point: {
                                            events: {
                                                click: clickChartHandler
                                            }
                                        },
                                        showInLegend: false
                                    }
                                }
                            }
                        }, overrides || {});
                    },

                    _addPointForTopLevelItem: function(record, relatedCount) {
                        var blocked = record.get('Blocked');
                        var color = this._colorFromStatus(this._storyStates[record.get('ScheduleState')], blocked);
                        var pointSize = record.get('PlanEstimate') || 1;

                        this._chartData.push({
                            name: record.get('FormattedID'),
                            y: pointSize,
                            color: color,
                            rallyName: record.get('Name'),
                            status: record.get('ScheduleState'),
                            blocked: blocked,
                            blockedReason: blocked ? record.get('BlockedReason') : null,
                            hasChildren: relatedCount > 0,
                            relatedCount: relatedCount,
                            ref: record.get('_ref'),
                            parentFormattedID: null
                        });
                    },

                    _addPointForChildItem: function(parentFormattedID, pointSize, state, blocked) {
                        var color = this._colorFromStatus(this._storyStates[state], blocked);

                        this._childChartData.push({
                            y: pointSize,
                            color: color,
                            status: state,
                            blocked: blocked,
                            hasChildren: false,
                            relatedCount: 0,
                            parentFormattedID: parentFormattedID
                        });
                    }

                });
            })();

            (function() {
                var Ext = window.Ext4 || window.Ext;

                Ext.define('Rally.apps.iterationtracking.statsbanner.IterationProgressDialogChartToggle', {
                    requires: ['Rally.ui.Button'],
                    extend: 'Ext.Container',
                    alias: 'widget.iterationprogressdialogcharttoggle',

                    componentCls: 'iteration-progress-toggle-button-group',
                    layout: 'hbox',
                    border: 1,
                    width: 106,
                    activeButtonCls: 'rly-active',

                    defaultType: 'rallybutton',

                    config: {
                        startingIndex: 0
                    },

                    items: [{
                            cls: 'toggle rly-right cumulativeflow',
                            iconCls: 'icon-graph',
                            frame: false,
                            toggleGroup: 'iterationprogressviewtoggle',
                            toolTipConfig: {
                                html: 'Cumulative Flow',
                                anchor: 'top',
                                hideDelay: 0
                            },
                            userAction: 'IterationProgressApp - User clicked CFD'
                        }, {
                            cls: 'toggle rly-left pie-chart',
                            iconCls: 'icon-pie',
                            frame: false,
                            toggleGroup: 'iterationprogressviewtoggle',
                            style: {
                                fontSize: '15px'
                            },
                            toolTipConfig: {
                                html: 'Pie',
                                anchor: 'top',
                                hideDelay: 0
                            },
                            userAction: 'IterationProgressApp - User clicked pie chart'
                        },
                        {
                            cls: 'toggle center burndown',
                            iconCls: 'icon-bars',
                            frame: false,
                            toggleGroup: 'iterationprogressviewtoggle',
                            toolTipConfig: {
                                html: 'Burndown',
                                anchor: 'top',
                                hideDelay: 0
                            },
                            userAction: 'IterationProgressApp - User clicked burndown'
                        }
                    ],

                    initComponent: function(config) {
                        this.initConfig(config);
                        this.callParent(arguments);

                        this.addEvents([
                            /**
                             * @event toggle
                             * Fires when the toggle value is changed.
                             * @param {String} toggleState 'burndown' or 'cumulativeflow' or 'pie'.
                             */
                            'toggle'
                        ]);

                        this.items.each(function(item) {
                            item.on('click', this._onButtonClick, this);
                        }, this);

                        this.setCurrentItem(this.startingIndex);
                    },

                    _onButtonClick: function(btn) {
                        var btnIndex = this.items.indexOf(btn);
                        if (btnIndex !== this._activeIndex) {
                            this._setActive(btn);
                            this.fireEvent('toggle', this, btnIndex);
                        }
                    },

                    _setActive: function(btn) {
                        this.items.each(function(item, btnIndex) {
                            if (item === btn) {
                                if (!item.hasCls(this.activeButtonCls.split(' ')[0])) {
                                    item.addCls(this.activeButtonCls);
                                    this._activeIndex = btnIndex;
                                }
                            } else {
                                item.removeCls(this.activeButtonCls);
                            }
                        }, this);
                    },

                    setCurrentItem: function(itemIndex) {
                        this._setActive(this.items.get(itemIndex));
                    }
                });
            })();


            (function() {

                var Ext = window.Ext4 || window.Ext;

                /**
                 * shows burndown for timebox
                 */
                Ext.define('Rally.apps.iterationtracking.statsbanner.IterationProgressDialog', {
                    extend: 'Rally.ui.dialog.Dialog',
                    alias: 'widget.statsbanneriterationprogressdialog',
                    requires: [
                        'Rally.apps.iterationtracking.statsbanner.IterationProgressDialogChartToggle',
                        'Rally.apps.iterationtracking.statsbanner.iterationprogresscharts.BurndownChart',
                        'Rally.apps.iterationtracking.statsbanner.iterationprogresscharts.CumulativeFlowChart',
                        'Rally.apps.iterationtracking.statsbanner.iterationprogresscharts.PieChart',
                        'Rally.ui.carousel.Carousel'
                    ],
                    config: {
                        startingIndex: 0,
                        autoShow: true,
                        draggable: true,
                        disableScroll: true,
                        width: 820,
                        height: 490,
                        closable: true,
                        constrain: true,
                        store: null,
                        context: null
                    },
                    layout: {
                        type: 'vbox',
                        align: 'center'
                    },
                    cls: 'iteration-progress-dialog',

                    constructor: function(config) {
                        this.initConfig(config || {});
                        this.callParent(arguments);
                    },

                    initComponent: function() {
                        var chartWidth = 704;
                        var chartHeight = 400;

                        this.callParent(arguments);
                        this.toggle = this.add({
                            xtype: 'iterationprogressdialogcharttoggle',
                            startingIndex: this.startingIndex,
                            listeners: {
                                toggle: this._toggleButtonClick,
                                scope: this
                            }
                        });
                        this.carousel = this.add({
                            xtype: 'rallycarousel',
                            showDots: false,
                            enableAnimations: false,
                            carouselItems: [{
                                    xtype: 'statsbannercumulativeflowchart',
                                    width: chartWidth,
                                    height: chartHeight,
                                    context: this.context,
                                    store: this.store
                                },
                                {
                                    xtype: 'statsbannerpiechart',
                                    width: chartWidth,
                                    height: chartHeight,
                                    context: this.context,
                                    store: this.store
                                },
                                {
                                    xtype: 'statsbannerburndownchart',
                                    width: chartWidth,
                                    height: chartHeight,
                                    context: this.context,
                                    store: this.store
                                }
                            ],
                            startingIndex: this.startingIndex,
                            listeners: {
                                carouselmove: {
                                    fn: this._onCarouselMove,
                                    scope: this
                                },
                                afterlayout: {
                                    fn: this._afterLayout,
                                    single: true,
                                    scope: this
                                }
                            }
                        });
                    },

                    _toggleButtonClick: function(toggleBtnContainer, buttonIndex) {
                        this._setChart(buttonIndex);
                    },

                    _afterLayout: function() {
                        Ext.defer(this._setChart, 10, this, [this.startingIndex]);
                    },

                    _setChart: function(chartIndex) {
                        this.carousel.setCurrentItem(chartIndex);
                        this.toggle.setCurrentItem(chartIndex);
                        // need to bypass the setTitle method as it causes a relayout of the page messing up the carousel
                        this.header.titleCmp.textEl.update(this.carousel.getCurrentItem().displayTitle);
                    },

                    _onCarouselMove: function(carousel) {
                        this._setChart(carousel.getCurrentItemIndex());
                    }
                });
            })();

            (function() {
                var Ext = window.Ext4 || window.Ext;

                /**
                 * shows burndown for timebox
                 */
                Ext.define('Rally.apps.iterationtracking.statsbanner.IterationProgress', {
                    extend: 'Rally.apps.iterationtracking.statsbanner.BannerWidget',
                    alias: 'widget.statsbanneriterationprogress',
                    requires: [
                        'Rally.ui.carousel.Carousel',
                        'Rally.apps.iterationtracking.statsbanner.iterationprogresscharts.BurndownChart',
                        'Rally.apps.iterationtracking.statsbanner.iterationprogresscharts.CumulativeFlowChart',
                        'Rally.apps.iterationtracking.statsbanner.iterationprogresscharts.MinimalPieChart',
                        'Rally.apps.iterationtracking.statsbanner.iterationprogresscharts.PieChart',
                        'Rally.apps.iterationtracking.statsbanner.IterationProgressDialog',
                        'Ext.state.Manager'
                    ],

                    config: {
                        context: null,
                        store: null
                    },

                    currentChartDisplayed: 0,

                    stateId: 'stats-banner-iteration-progress',
                    stateful: true,

                    clientMetrics: {
                        method: '_onChartClick',
                        description: 'opened IterationProgressDialog'
                    },

                    tpl: [
                        '<div class="expanded-widget">',
                        '<div class="stat-title"></div>',
                        '<div class="stat-metric">',
                        '<div class="stat-carousel"></div>',
                        '</div>',
                        '</div>',
                        '<div class="collapsed-widget">',
                        '<span class="metric-icon icon-pie"></span>',
                        '<div class="stat-title"></div>',
                        '</div>'
                    ],

                    constructor: function(config) {
                        this.stateId = Rally.environment.getContext().getScopedStateId(this.stateId);
                        this.callParent(arguments);
                    },

                    initComponent: function() {
                        this.mon(this.store, 'datachanged', this.onDataChanged, this);
                        this.callParent(arguments);
                        var boundClickHandler = Ext.bind(this._onChartClick, this);

                        this.carouselItems = [{
                                xtype: 'statsbannercumulativeflowchart',
                                width: 150,
                                height: 63,
                                minimalMode: true,
                                clickHandler: boundClickHandler,
                                context: this.context,
                                store: this.store
                            },
                            {
                                xtype: 'statsbannerminimalpiechart',
                                width: 150,
                                height: 60,
                                minimalMode: true,
                                clickHandler: boundClickHandler,
                                context: this.context,
                                store: this.store
                            },
                            {
                                xtype: 'statsbannerburndownchart',
                                width: 150,
                                height: 63,
                                minimalMode: true,
                                clickHandler: boundClickHandler,
                                context: this.context,
                                store: this.store
                            }
                        ];

                        _.each(this.carouselItems, function(carouselItem) {
                            carouselItem.listeners = {
                                ready: this._onChartReady,
                                scope: this
                            };
                        }, this);

                        this._pendingChartReadies = this.carouselItems.length;
                    },

                    expand: function() {
                        this.callParent();
                        // Carousel was updated while hidden so it needs to die
                        // and we create a new one since it can't lay itself out
                        if (!this.carousel || this.carousel.getWidth() === 0) {
                            this.onDataChanged();
                        }
                    },

                    _onChartReady: function() {
                        this._pendingChartReadies -= 1;

                        if (this._pendingChartReadies === 0) {
                            this.fireEvent('ready', this);
                        }
                    },

                    _onChartClick: function() {
                        var currentIndex = this.carousel.getCurrentItemIndex();
                        Ext.create('Rally.apps.iterationtracking.statsbanner.IterationProgressDialog', {
                            startingIndex: currentIndex,
                            store: this.store,
                            context: this.context
                        });
                    },

                    _cleanupCarousel: function() {
                        if (this.carousel) {
                            this.carousel.destroy();
                            delete this.carousel;
                        }
                    },

                    onDestroy: function() {
                        this._cleanupCarousel();
                        this.callParent(arguments);
                    },

                    onRender: function() {
                        this.callParent(arguments);
                        if (!this.getContext().getTimeboxScope().getRecord()) {
                            this._addPlaceholder();
                        }
                    },

                    applyState: function(state) {
                        if (state) {
                            if (state.currentChartDisplayed > this.carouselItems.length - 1 || state.currentChartDisplayed < 0) {
                                this.currentChartDisplayed = 0;
                            } else {
                                this.currentChartDisplayed = state.currentChartDisplayed;
                            }
                        }
                    },

                    getState: function() {
                        return {
                            currentChartDisplayed: this.currentChartDisplayed
                        };
                    },

                    onDataChanged: function() {
                        this._cleanupCarousel();

                        if (this.rendered) {
                            if (this.getContext().getTimeboxScope().getRecord()) {
                                this.update();

                                this.createCarousel();
                            } else {
                                this._addPlaceholder();
                            }
                        }
                    },

                    createCarousel: function() {
                        this.carousel = Ext.create('Rally.ui.carousel.Carousel', {
                            showHeader: false,
                            showDots: true,
                            smallDots: true,
                            renderTo: this.getEl().down('.stat-carousel'),
                            height: 75,
                            layout: {
                                type: 'vbox',
                                align: 'center'
                            },
                            listeners: {
                                currentitemset: this._updateTitle,
                                carouselmove: this._updateTitle,
                                scope: this
                            },
                            carouselItems: this.carouselItems
                        });

                        if (!Ext.isIE8m) {
                            // if such next line runs IE8 or < goes boom! WOW!
                            this.carousel.setCurrentItem(this.currentChartDisplayed);
                        }

                        this.carousel.on('carouselmove', this._chartShownChanged, this);
                    },

                    _updateTitle: function(carousel) {
                        _.each(this.getEl().query('.stat-title'), function(el) {
                            Ext.fly(el).update(carousel.getCurrentItem().displayTitle);
                        }, this);
                    },

                    _chartShownChanged: function() {
                        var chartShown = _.findIndex(this.carouselItems, {
                            xtype: this.carousel.getCurrentItem().xtype
                        });
                        this.currentChartDisplayed = chartShown || 0;
                        this.saveState();
                    },

                    _addPlaceholder: function() {
                        this.update();

                        if (this.expanded) {
                            this.carousel = Ext.create('Ext.Container', {
                                renderTo: this.getEl().down('.stat-carousel'),
                                html: 'no iteration data'
                            });
                        }
                    }
                });
            })();

            (function() {
                var Ext = window.Ext4 || window.Ext;

                /**
                 * shows collapse/expand toggle for stats banner
                 */
                Ext.define('Rally.apps.iterationtracking.statsbanner.CollapseExpand', {
                    extend: 'Rally.apps.iterationtracking.statsbanner.BannerWidget',
                    alias: 'widget.statsbannercollapseexpand',
                    requires: [],

                    tpl: [
                        '<div class="expanded-widget">',
                        '<div class="toggle-icon icon-chevron-up"></div>',
                        '</div>',
                        '<div class="collapsed-widget">',
                        '<div class="toggle-icon icon-chevron-down"></div>',
                        '</div>'
                    ],

                    componentCls: 'collapse-expand',

                    bubbleEvents: ['collapse', 'expand'],

                    afterRender: function() {
                        this.callParent(arguments);
                        this.getEl().on('click', this._onCollapseExpandClick, this);
                        this.fireEvent('ready', this);
                    },

                    _onCollapseExpandClick: function() {
                        if (this.expanded) {
                            this.fireEvent('collapse', this);
                        } else {
                            this.fireEvent('expand', this);
                        }
                    },

                    expand: function() {
                        this.callParent(arguments);
                        this.doComponentLayout();
                    },

                    collapse: function() {
                        this.callParent(arguments);
                        this.doComponentLayout();
                    }
                });
            })();

            (function() {
                var Ext = window.Ext4 || window.Ext;

                /**
                 * Allows user to see stats for a timebox in a horizontal bar format
                 */
                Ext.define('Rally.apps.iterationtracking.StatsBanner', {
                    extend: 'Ext.Container',
                    alias: 'widget.statsbanner',
                    requires: [
                        'Rally.apps.iterationtracking.statsbanner.PlannedVelocity',
                        'Rally.apps.iterationtracking.statsbanner.TimeboxEnd',
                        'Rally.apps.iterationtracking.statsbanner.Defects',
                        'Rally.apps.iterationtracking.statsbanner.Tasks',
                        'Rally.apps.iterationtracking.statsbanner.Accepted',
                        'Rally.apps.iterationtracking.statsbanner.IterationProgress',
                        'Rally.apps.iterationtracking.statsbanner.CollapseExpand'
                    ],
                    mixins: [
                        'Rally.Messageable',
                        'Rally.clientmetrics.ClientMetricsRecordable'
                    ],
                    cls: 'stats-banner',
                    layout: 'hbox',
                    border: 0,
                    width: '100%',
                    stateful: true,
                    stateEvents: ['expand', 'collapse'],

                    config: {
                        context: null,
                        expanded: true
                    },

                    items: [{
                            xtype: 'statsbannerplannedvelocity',
                            unitLabel: ' points'
                        },
                        {
                            xtype: 'statsbannertimeboxend'
                        },
                        {
                            xtype: 'statsbanneraccepted',
                            byCount: false
                        },
                        {
                            xtype: 'statsbannerdefects'
                        },
                        {
                            xtype: 'statsbannertasks'
                        },
                        {
                            xtype: 'statsbanneriterationprogress',
                            flex: 2
                        },
                        {
                            xtype: 'statsbannercollapseexpand',
                            flex: 0
                        }
                    ],

                    constructor: function() {
                        this.stateId = Rally.environment.getContext().getScopedStateId('stats-banner');
                        this.callParent(arguments);
                    },

                    initComponent: function() {
                        this.addEvents(
                            /**
                             * @event
                             * Fires when expand is clicked
                             */
                            'expand',
                            /**
                             * @event
                             * Fires when collapse is clicked
                             */
                            'collapse'
                        );

                        this.subscribe(this, Rally.Message.objectDestroy, this._update, this);
                        this.subscribe(this, Rally.Message.objectCreate, this._update, this);
                        this.subscribe(this, Rally.Message.objectUpdate, this._update, this);
                        this.subscribe(this, Rally.Message.bulkUpdate, this._update, this);

                        //var tbs = this.context.getTimeboxScope();
                        var filters = [];
                        if (this.iteration) {
                            filters.push({
                                property: 'Iteration.ObjectID',
                                value: this.iteration.data.ObjectID
                            })
                        } else {
                            filters.push(this.context.getTimeboxScope().getQueryFilter())
                        }

                        this.store = Ext.create('Rally.data.wsapi.artifact.Store', {
                            models: ['userstory', 'defect'],
                            fetch: [
                                'FormattedID',
                                'Name',
                                'PlanEstimate',
                                'ScheduleState',
                                'Defects[FormattedID;Name;ScheduleState]',
                                'Defects:summary[State]',
                                'Requirement[Iteration]',
                                'Iteration[Name;PlannedVelocity;ObjectID]',
                                'Project[Name;ObjectID]',
                                'State',
                                'Tasks[FormattedID;Name;State]',
                                'Tasks:summary[State]',
                                'Blocked',
                                'PlanEstimate'
                            ],
                            useShallowFetch: true,
                            filters: filters,
                            context: this.context.getDataContext(),
                            limit: Infinity,
                            requester: this
                        });

                        //need to configure the items at the instance level, not the class level (i.e. don't use the 'defaults' config)
                        this.items = this._configureItems(this.items);

                        this.on('expand', this._onExpand, this);
                        this.on('collapse', this._onCollapse, this);
                        this.callParent(arguments);

                        this._update();
                    },

                    onRender: function() {
                        if (this.expanded) {
                            this.removeCls('collapsed');
                        } else {
                            this.addCls('collapsed');
                        }
                        this._setExpandedOnChildItems();
                        this.callParent(arguments);
                    },

                    applyState: function(state) {
                        if (Ext.isDefined(state.expanded)) {
                            this.setExpanded(state.expanded);
                        }
                        this._setExpandedOnChildItems();
                    },

                    getState: function() {
                        return {
                            expanded: this.expanded
                        };
                    },

                    _setExpandedOnChildItems: function() {
                        _.each(this.items.getRange(), function(item) {
                            item.setExpanded(this.expanded);
                        }, this);
                    },

                    _getItemDefaults: function() {
                        return {
                            flex: 1,
                            context: this.context,
                            store: this.store,
                            iteration: this.iteration,
                            listeners: {
                                ready: this._onReady,
                                scope: this
                            }
                        };
                    },

                    _onReady: function() {
                        this._readyCount = (this._readyCount || 0) + 1;
                        if (this._readyCount === this.items.getCount()) {
                            this.recordComponentReady();
                            delete this._readyCount;
                        }
                    },

                    _onCollapse: function() {
                        this.addCls('collapsed');
                        this.setExpanded(false);

                        _.invoke(this.items.getRange(), 'collapse');
                    },

                    _onExpand: function() {
                        this.removeCls('collapsed');
                        this.setExpanded(true);

                        _.invoke(this.items.getRange(), 'expand');
                    },

                    _hasTimebox: function() {
                        return !!this.context.getTimeboxScope().getRecord();
                    },

                    _configureItems: function(items) {
                        var defaults = this._getItemDefaults();

                        return _.map(items, function(item) {
                            return _.defaults(_.cloneDeep(item), defaults);
                        });
                    },

                    _update: function() {
                        if (this._hasTimebox()) {
                            this.store.load();
                        }
                    }
                });
            })();

            (function() {
                var Ext = window.Ext4 || window.Ext;

                /**
                 * Iteration Tracking Board App
                 * The Iteration Tracking Board can be used to visualize and manage your User Stories and Defects within an Iteration.
                 */
                Ext.define('Rally.apps.iterationtracking.IterationTrackingApp', {
                    extend: 'Rally.app.TimeboxScopedApp',
                    componentCls: 'iterationtrackingboard',
                    alias: 'widget.rallyiterationtrackingapp',

                    settingsScope: 'project',
                    scopeType: 'iteration',
                    comboboxConfig: {
                        storeConfig: {
                            fetch: ['ObjectID', 'Name', 'StartDate', 'EndDate', 'ChildrenPlannedVelocity', 'PlannedVelocity', 'Project']
                        }
                    },

                    onScopeChange: function() {
                        this._addStatsBanner();
                    },

                    _addStatsBanner: function() {
                        this.remove('statsBanner');

                        this.add({
                            xtype: 'container',
                            itemId: 'statsBanner',
                            items: [{
                                xtype: 'statsbanner',
                                context: this.getContext(),
                                margin: '0 0 50px 0'
                            }]
                        });

                        Ext.create('Rally.data.wsapi.Store', {
                            model: 'iteration',
                            autoLoad: true,
                            filters: [{
                                property: 'Name',
                                value: this.getContext().getTimeboxScope().getRecord().get('Name')
                            }, {
                                property: 'Project.Name',
                                operator: '!=',
                                value: this.getContext().getProject().Name
                            }, {
                                property: 'Project.Children.ObjectID',
                                value: null
                            }, {
                                property: 'PlannedVelocity',
                                operator: '>',
                                value: 0
                            }],
                            sorters: {
                                property: 'Project.Name',
                                direction: 'asc'
                            },
                            limit: Infinity,
                            listeners: {
                                load: function(store, records) {
                                    _.each(records, function(record) {


                                        this.down('#statsBanner').add([{
                                            xtype: 'container',
                                            html: '<h3>' + record.get('Project')._refObjectName + '</h3>'
                                        }, {
                                            xtype: 'statsbanner',
                                            context:
                                                // {
                                                //   project: record.get('Project')._ref,
                                                // },
                                                this.getContext(),
                                            margin: '0 0 5px 0',
                                            iteration: record
                                        }]);


                                    }, this)
                                },
                                scope: this
                            }
                        })


                    }
                });
            })();


            Rally.launchApp('Rally.apps.iterationtracking.IterationTrackingApp', {
                name: "Release Tracking Board",
                parentRepos: ""
            });

        });

    </script>



    <style type="text/css">
        .stat-panel .collapsed-widget,
        .stat-panel .collapsed-widget>div {
            display: none;
        }

        .stat-panel .expanded-widget,
        .stat-panel .expanded-widget>div {
            display: block;
        }

        .stat-panel.collapsed .collapsed-widget,
        .stat-panel.collapsed .collapsed-widget>div {
            display: inline-block;
        }

        .stat-panel.collapsed .expanded-widget,
        .stat-panel.collapsed .expanded-widget>div {
            display: none;
        }

        .stats-banner .stat-panel {
            border-top: 1px solid #d6d6d6;
            border-left: 1px solid #d6d6d6;
            border-bottom: 1px solid #d6d6d6;
            height: 110px;
            text-align: center;
        }

        .stats-banner .stat-panel:first-child {
            border-left: 0;
        }

        .stats-banner .stat-panel:last-child {
            border-left-width: 2px;
        }

        .stats-banner .stat-panel .stat-title {
            color: #222222;
            font-family: ProximaNovaSemiBold, Helvetica, Arial;
            font-size: 14px;
            padding-top: 5px;
        }

        .stats-banner .stat-panel .stat-metric {
            color: #666666;
            font-family: ProximaNovaLight, Helvetica, Arial;
            font-size: 18px;
            height: 85px;
            padding-top: 20px;
        }

        .stats-banner .stat-panel .stat-metric .metric-percent {
            display: inline;
            font-size: 12px;
            vertical-align: super;
        }

        .stats-banner .stat-panel .stat-metric .metric-icon {
            color: #888888;
            font-size: 18px;
            padding-right: 5px;
        }

        .stats-banner .stat-panel .stat-metric .metric-chart {
            position: absolute;
            top: 22px;
            width: 100%;
        }

        .stats-banner .stat-panel .stat-metric .metric-subtext {
            bottom: 7px;
            color: #888888;
            font-family: ProximaNova, Helvetica, Arial;
            font-size: 11px;
            position: absolute;
            text-transform: lowercase;
            width: 100%;
        }

        .stats-banner .stat-panel .stat-metric .metric-chart-text {
            position: absolute;
            top: 43px;
            width: 100%;
        }

        .stats-banner .stat-panel .stat-metric .metric-chart-text.percent-offset {
            left: 3px;
            top: 41px;
        }

        .stats-banner .stat-panel .stat-metric .stat-secondary {
            color: #888888;
            font-family: ProximaNova, Helvetica, Arial;
            font-size: 11px;
            text-transform: lowercase;
        }

        .stats-banner .stat-panel .stat-metric .stat-carousel {
            display: inline-block;
            font-family: ProximaNova, Helvetica, Arial;
            font-size: 12px;
            margin-top: -20px;
        }

        .stats-banner .stat-panel .stat-metric .stat-carousel .rally-carousel-pane .x-box-inner {
            top: 0px !important;
        }

        .stats-banner .stat-panel .stat-metric .stat-carousel .carousel>span {
            display: inline !important;
            width: auto !important;
        }

        .stats-banner .stat-panel .stat-metric .stat-carousel .carousel>span>div {
            display: block !important;
        }

        .stats-banner .stat-panel .stat-metric .stat-carousel .carousel .carousel-panel>span {
            display: inline !important;
            width: auto !important;
        }

        .stats-banner .stat-panel .stat-metric .stat-carousel .carousel .carousel-panel>span>div {
            display: block !important;
        }

        .stats-banner .stat-panel .chart .highcharts-container {
            cursor: pointer;
        }

        .stats-banner .stat-panel .gauge .chart .highcharts-container {
            cursor: default;
        }

        .stats-banner .stat-panel .header {
            display: none;
        }

        .stats-banner .stat-panel.collapse-expand {
            background-color: #f6f6f6;
            width: 23px;
        }

        .stats-banner .stat-panel.collapse-expand .toggle-icon {
            color: #c0c0c0;
            font-size: 18px;
            position: relative;
            right: 1px;
        }

        .stats-banner .stat-panel.collapse-expand:hover {
            cursor: pointer;
        }

        .stats-banner .stat-panel.collapse-expand:hover .toggle-icon {
            color: #888888;
        }

        .stats-banner.collapsed .stat-panel {
            height: 25px;
            padding-top: 2px;
        }

        .stats-banner.collapsed .stat-panel .metric-icon {
            color: #888888;
            font-size: 14px;
            padding-right: 5px;
            vertical-align: middle;
        }

        .stats-banner.collapsed .stat-panel .stat-title {
            color: #222222;
            display: inline;
            font-family: ProximaNovaSemiBold, Helvetica, Arial;
            font-size: 12px;
            vertical-align: middle;
        }

        .stats-banner.collapsed .stat-panel .stat-metric {
            color: #888888;
            display: inline;
            font-family: ProximaNova, Helvetica, Arial;
            font-size: 14px;
            height: auto;
            padding-top: auto;
            padding-left: 10px;
            vertical-align: middle;
        }

        .stats-banner.collapsed .stat-panel .stat-metric .stat-metric-secondary {
            font-size: 11px;
        }

        .stats-banner.collapsed .stat-panel .stat-metric .metric-percent {
            font-size: 10px;
            vertical-align: super;
        }

        .pie-chart-legend {
            color: #3E576F;
            font-size: 12px;
            padding: 5px;
            border: 1px solid #909090;
            -webkit-border-radius: 5px;
            -moz-border-radius: 5px;
            border-radius: 5px;
        }

        .pie-chart-legend .legend-swatch {
            width: 17px;
            height: 12px;
            border: 1px solid #EEE;
            -webkit-border-radius: 5px;
            -moz-border-radius: 5px;
            border-radius: 5px;
            float: left;
            margin: 0 3px 0 6px;
        }

        .pie-chart-legend .legend-swatch.defined-sample-swatch {
            background: #E0E0E0;
            /* light-gray */
        }

        .pie-chart-legend .legend-swatch.in-progress-sample-swatch {
            background: #00a9e0;
        }

        .pie-chart-legend .legend-swatch.completed-sample-swatch {
            background: #8dc63f;
        }

        .pie-chart-legend .legend-swatch.blocked-sample-swatch {
            background: #EF3F35;
            /* rally red */
        }

        .iteration-progress-dialog .carousel .carousel-panel .scroll-button span {
            width: 45px;
            height: 50px;
            line-height: 46px;
        }

        .iteration-progress-dialog .carousel .carousel-panel .scroll-button span:hover {
            background-color: #e6e6e6;
            color: #666666;
        }

        .iteration-progress-toggle-button-group {
            margin-bottom: 5px;
        }

        .x-gecko .stats-banner.collapsed .stat-panel .stat-metric {
            line-height: 20px;
            vertical-align: top;
        }

        .x-gecko .stats-banner.collapsed .stat-panel .stat-metric .metric-percent {
            line-height: 10px;
        }

        .x-gecko.x-mac .stats-banner.collapsed .stat-panel .stat-metric {
            line-height: 22px;
        }

    </style>
</head>

<body>
</body>

</html>
